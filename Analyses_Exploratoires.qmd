---
title: "Analyses_exploratoires"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false

#| label: Packages necessaire
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
```

::: {.callout-warning style="border-left: 5px solid red; background-color: #fdd; padding: 1em;"}
## Attention

Pour les analyses à venir, vous devez utiliser le **nouveau jeu de données** créé après vérification qu'il est **complet et nettoyé** (voir les sections suivantes).

Il est important de commencer toutes les nouvelles analyses avec ce jeu de données afin que **tout le monde travaille sur la même base**. Le jeu de donnée se trouve dans le git commun dans le dossier data pro

Si vous avez besoin de **sous-jeux de données**, par exemple uniquement le **Butor étoilé** ou uniquement les données **opportunistes**, rendez-vous dans la **section 4** pour les récupérer, afin de **préserver la typologie correcte du jeu de données**.
:::


# 1. Jeux de données nécessaires ( par especes, par protocole....)

```{r}
#| label: DATA A UTILISER
#| echo: true
#| message: false
#| warning: false
 process_data <- read_csv("data/pro/process_data.csv")
```

```{r}
## 4.1 Par especes
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

Blongios_nain<-process_data %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

```

## 1.2 Par protocole

```{r}
#| label: data par protocole
suivi<-process_data %>%
  filter(
  champs_additionnels%in% c(
    "{'RELV_NOM': 'SuiviBlongiostaleve'}",
    "{'RELV_NOM': 'SuiviButor'}"
  )
)

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Protocole_SuiviButor <- process_data %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviBlongiosTaleve <- process_data %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Blongios<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Blongios nain, Butor blongios"
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

```

# 2. Analyses exploratoires

## 2.1continuité des protocoles sur les sites

### 2.1.a Pour le Butor

```{r fig.height=25, fig.width=30}
#| label: I
#| echo: false

# Liste des noms de sites
sites <- c(unique(Protocole_SuiviButor$nom_lieu))

# Définir toutes les semaines attendues pour la période de suivi (reste hors de la boucle)
annees <- 1996:2025
semaines <- 1:53  # Certaines années ont 53 semaines ISO

# Générer un data frame complet avec toutes les semaines de toutes les années
calendrier <- expand.grid(annee = annees, semaine = semaines) %>%
  arrange(annee, semaine)

# creation liste pour la boucle 

tous_les_graphes <- list()
# --- 2. Boucle pour l'Analyse et le Graphique de Chaque Site ---

# Nous itérons directement sur la liste des noms de sites
for(site_nom in sites) {
  
  # a) Filtrer les données pour le site actuel (site_nom)
  df_site <- Protocole_SuiviButor %>%
    filter(nom_lieu == site_nom)
  
  # b) Préparation des données: convertir la date et extraire année + semaine
  # Si df_site est vide, le reste du pipeline fonctionnera toujours grâce à right_join
  data_semaines_site <- df_site %>%
    mutate(
      date_parsed = ymd(date_debut),
      annee = year(date_parsed),
      semaine = isoweek(date_parsed)
    )
  
  # c) Calculer le suivi (compte et jointure avec le calendrier)
  suivi <- data_semaines_site %>%
    group_by(annee, semaine) %>%
    summarise(nb = n(), .groups = "drop") %>%
    right_join(calendrier, by = c("annee", "semaine")) %>%
    mutate(
      fait = ifelse(is.na(nb), "Non", "Oui"),
      annee_fct = factor(annee) 
    )
  
  # d) Créer le graphique
  g <- ggplot(suivi, aes(x = semaine, y = annee_fct, fill = fait)) +
    geom_tile(color = "black") +
    scale_fill_manual(values = c("Oui" = "forestgreen", "Non" = "red")) +
    labs(
      title = paste("Site", site_nom), # Titre raccourci pour la vue combinée
      x = "Semaine ISO",
      y = "Année",
      fill = "Protocole fait ?"
    ) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      axis.text.y = element_text(size = 6),
      axis.text.x = element_text(size = 6),
      plot.title = element_text(size = 8, hjust = 0.5) 
    ) 

  tous_les_graphes[[site_nom]] <- g
}

grid.arrange(grobs = tous_les_graphes, ncol = 4)

```

### 2.1.b Pour le Blongios et le Taleve

```{r fig.height=25, fig.width=30}
#| label: J
#| echo: false
site_Blongios = sites <- c(unique(Protocole_SuiviBlongiosTaleve$nom_lieu))

tous_les_graphes_Blongios = list()

for(site_nom in sites) {
df_site <- Protocole_SuiviBlongiosTaleve %>%
  filter(nom_lieu == site_nom)

# b) Préparation des données: convertir la date et extraire année + semaine
# Si df_site est vide, le reste du pipeline fonctionnera toujours grâce à right_join
data_semaines_site <- df_site %>%
  mutate(
    date_parsed = ymd(date_debut),
    annee = year(date_parsed),
    semaine = isoweek(date_parsed)
  )

# c) Calculer le suivi (compte et jointure avec le calendrier)
suivi_Blongios <- data_semaines_site %>%
  group_by(annee, semaine) %>%
  summarise(nb = n(), .groups = "drop") %>%
  right_join(calendrier, by = c("annee", "semaine")) %>%
  mutate(
    fait = ifelse(is.na(nb), "Non", "Oui"),
    annee_fct = factor(annee) 
  )

# d) Créer le graphique
g <- ggplot(suivi_Blongios, aes(x = semaine, y = annee_fct, fill = fait)) +
  geom_tile(color = "black") +
  scale_fill_manual(values = c("Oui" = "forestgreen", "Non" = "red")) +
  labs(
    title = paste("Site", site_nom), # Titre raccourci pour la vue combinée
    x = "Semaine ISO",
    y = "Année",
    fill = "Protocole fait ?"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),
    plot.title = element_text(size = 8, hjust = 0.5) 
  ) 

tous_les_graphes_Blongios[[site_nom]] <- g
}

#Combiner tous les graphiques sur une seule page

grid.arrange(grobs = tous_les_graphes_Blongios, ncol = 4)

```

::: {.callout-note style="green"}
## Interpretation

Sites où pas de protocole suivi régulièrement (1 à 2 sorties en tout) :

-   blongios/taleve : petit_bassin R3.2 petit_bassin R2.9 petit_bassin R3.1 GB6 chemin_animation

-   butor : GB GB5 s 66 44 55 11 99 33 domaineGrandClavalet

sites avec protocole régulier : - blongios/taleve : début en 2014 - butor : début en 2013
:::

## 2.2 effort d'observation journalier

### 2.2.a Effort journalier toutes espèces tout protocole

```{r}

process_data <- process_data %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nen conservant les heures inconnues (0), tout protocole confondu")

```

### 2.2.b Données d'heure sans les 00:00:00 et les absence d'heure tout espece tout protocole

```{r}
process_data <-process_data %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00") 

### Extraire l'heure

process_data <- process_data %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
process_data$heure_debut_tronc = as.factor(process_data$heure_debut_tronc)
### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure



### Frequence horaire

freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot


ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nsans les heures inconnues, tout protocole confondu")
```

### 2.2.c Effort journalier Butor tout protocole

```{r}
Butor_etoile <- Butor_etoile %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")
### Extraire l'heure

Butor_etoile <- Butor_etoile %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Butor_etoile$heure_debut_tronc = as.factor(Butor_etoile$heure_debut_tronc)

### Sommer les obs par heure


obs_heure <- Butor_etoile %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure


### Frequence horaire


freq_heure <- Butor_etoile %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Butor étoilé) par heure \nsans les heures inconnues, tout protocole confondu")

```

### 2.2.d Effort journalier Blongios tout protocole

```{r}
Blongios_nain <- Blongios_nain  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Blongios_nain <- Blongios_nain %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Blongios_nain$heure_debut_tronc = as.factor(Blongios_nain$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Blongios_nain %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Blongios_nain %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Blongios nain) par heure \nsans les heures inconnues, tout protocole confondu")
```

### 2.2.e Effort journalier Taleve tout protocole

```{r}
Taleve_sultane <- Taleve_sultane  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Taleve_sultane <- Taleve_sultane %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Taleve_sultane$heure_debut_tronc = as.factor(Taleve_sultane$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Taleve_sultane %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Taleve_sultane %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Talève sultane) par heure \nsans les heures inconnues, tout protocole confondu")
```

### 2.2.f Effort journalier protocole Butor

```{r}
Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Protocole_SuiviButor$heure_debut_tronc = as.factor(Protocole_SuiviButor$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviButor %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations protocolées (Butor étoilé) par heure \nsans les heures inconnues")
```

### 2.2.g Effort journalier protocole Blongios-Talève

```{r}
Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Protocole_SuiviBlongiosTaleve$heure_debut_tronc = as.factor(Protocole_SuiviBlongiosTaleve$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviBlongiosTaleve %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Protocole_SuiviBlongiosTaleve %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations protocolées \n(Blongios et Talève) par heure sans les heures inconnues")
```

::: {.callout-note style="green"}
## Interpretation

Beaucoup d'obs pour lesquelles l'heure est inconnue.

#Données d'heure sans les 00:00:00 (les 00 sont encore la ?) et les absence d'heure
:::

::: {.callout-note style="green"}
## Interpretation

Tout confondu : max au crépuscule (20h) et avant le levé du soleil (4-5h)

\- butor : max au crépuscule (20h-22h) et au levé du soleil (4-6h)

-   blongios : de 21h-23h et 5h à 9h

-   Taleve : de 5h à 9h avec GROS PIC à 8h puis de 20 à 21.

-   protocole blongios taleve = obs a 6h et 7h et 20h et 21h.

    =\> globalement tout correspond aux protocoles mis en place SAUF

-   protocole butor: UNE SEULE OBS PROTOCOLEE DONT ON CONNAIS L'HEURE et elle date de 1998 (j'ai verif les données brutes et effectivement c'est le cas)
:::

### 2.3 Correspondance des coordonnées et des sites

```{r}

process_data$nom_lieu <- as.factor(process_data$nom_lieu)

levels(process_data$nom_lieu)

# 65 sites de coordonées (protocole et opportunistes melanges)

# Résumé des coordonnées

coord_summary <- process_data %>%
  group_by(x_centroid_4326, y_centroid_4326) %>%
  summarise(
    n_sites = n_distinct(nom_lieu),                         # nombre de lieux distincts
    site_names = paste(unique(nom_lieu), collapse = ", "),  # liste des noms
    coord_unique = n_sites == 1,                             # TRUE si une seule espèce
    .groups = "drop"
  ) %>%
  arrange(desc(n_sites))%>%
  filter(n_sites > 1)

view(coord_summary)


process_data <- process_data %>%
  mutate(nom_lieu = ifelse(is.na(nom_lieu) | nom_lieu == "",
                           paste0("unnamedSite", row_number()), 
                           as.character(nom_lieu)))

process_data <- process_data %>%
  mutate(nom_lieu = as.character(nom_lieu)) %>%
  mutate(nom_lieu = ifelse(nom_lieu %in% c("Portiragnes", "RNNbagnas", "Bessan"),
                           "SudEtangBagnas",
                           nom_lieu)) %>%
  mutate(nom_lieu = as.factor(nom_lieu))

process_data$nom_lieu <- as.factor(process_data$nom_lieu)

levels(process_data$nom_lieu)

coord_summary <- process_data %>%
  group_by(x_centroid_4326, y_centroid_4326) %>%                 
  summarise(
    n_sites = n_distinct(nom_lieu),                              
    site_names = paste(unique(nom_lieu), collapse = ", "),      
    coord_unique = n_sites == 1                                  
  ) %>%
  ungroup() %>%
  arrange(desc(n_sites))
view(coord_summary)


ggplot(process_data, aes(x = x_centroid_4326, y = y_centroid_4326)) +
  geom_point(aes(color = nom_lieu), size = 3) +         
  geom_text(aes(label = nom_lieu), vjust = -1, size = 3) + 
  coord_quickmap() +                                     
  labs(title = "Sites in Réserve du Bagnas") +
  theme_classic() +
  theme(legend.position = "none")

```

::: {.callout-note style="green"}
## Interpretation

3 sites sans noms 3 sites avec des noms différents mais mêmes coordonnées : portignagne ; RNN_bagnas ; B100
:::

############################################### 

## 2.4 observation des espèces chaque semaine depuis le début des relevés

### 2.4.a Pour le Blongios

```{r}
#| label: O

annee_min <- min(year(process_data$date_debut), na.rm = TRUE)
annee_max <- max(year(process_data$date_debut), na.rm = TRUE)
duree_annees <- annee_max - annee_min + 1


data_blongios <- process_data %>%
  filter(nom_vernaculaire == "Blongios nain, Butor blongios") %>%
  mutate(
    annee_suivi  = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine      = isoweek(date_debut)
  )

# --- Résumer les semaines (gestion des observations / sorties) ---
data_blongios_summarized <- data_blongios %>%
  group_by(annee_suivi, semaine) %>%
  summarize(
    statut = case_when(
      any(nombre_min > 0)  ~ "observation",
      any(nombre_min == 0) ~ "sortie_sans_observation"
    ),
    .groups = "drop"
  )

# --- Grille complète année x semaine ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine     = 1:53
) %>%
  mutate(
    annee_reelle = annee_min + annee_suivi - 1
  ) %>%
  left_join(
    data_blongios_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(
    statut = ifelse(is.na(statut), "pas_de_sortie", statut)
  )

# --- Graphique calendrier ---
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", size = 0.2) +
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "observation"              = "#0072B2",
      "sortie_sans_observation"  = "#E69F00",
      "pas_de_sortie"            = "lightgrey"
    )
  ) +
  labs(
    title    = paste("Observations de", data_blongios),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())
```

::: callout-note
## Interpretation

graphique qui montre l'observation des blongios par semaine sur toute la periode de suivi (1990-2025). Attention, si dans une même semaine il y a des sorties sans observations et des sorties avec, la semaine est comptée comme "observation"
:::

### 2.4.b Pour le Butor

```{r}
#| echo: false
## Butor étoilé

annee_min <- min(year(process_data$date_debut), na.rm = TRUE)
annee_max <- max(year(process_data$date_debut), na.rm = TRUE)
duree_annees <- annee_max - annee_min + 1


data_butor <- process_data %>%
  filter(nom_vernaculaire == "Butor étoilé") %>%
  mutate(
    annee_suivi  = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine      = isoweek(date_debut)
  )

# --- Résumer les semaines (gestion des observations / sorties) ---
data_butor_summarized <- data_butor %>%
  group_by(annee_suivi, semaine) %>%
  summarize(
    statut = case_when(
      any(nombre_min > 0)  ~ "observation",
      any(nombre_min == 0) ~ "sortie_sans_observation"
    ),
    .groups = "drop"
  )

# --- Grille complète année x semaine ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine     = 1:53
) %>%
  mutate(
    annee_reelle = annee_min + annee_suivi - 1
  ) %>%
  left_join(
    data_butor_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(
    statut = ifelse(is.na(statut), "pas_de_sortie", statut)
  )

# --- Graphique calendrier ---
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", size = 0.2) +
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "observation"              = "#0072B2",
      "sortie_sans_observation"  = "#E69F00",
      "pas_de_sortie"            = "lightgrey"
    )
  ) +
  labs(
    title    = paste("Observations de", data_butor),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

::: {.callout-note style="green"}
## Interpretation

graphique qui montre l'observation des butors par semaine sur toute la periode de suivi (1990-2025). Attention, si dans une même semaine il y a des sorties sans observations et des sorties avec, la semaine est comptée comme "observation"

**Interpretation** - butor : observations depuis le début, depuis \~2018 plus vraiment d'observations. observations les premières semaines de l'années et dernières semaines sorties sans observations à partir de \~2013. (si on se refère aux graphs protocoles on voit que ça suit le même pattern. est ce que protocole fait à un moment étrange ?) les periodes où observations ne sont plus faites même en non observation

-   blongios : même pattern de semaines depuis \~1998 . qq sorties sans observation à l'air de coller avec les patterns de protocoles

=\> en 2018 le protocole blongios taleve est passé de 30min part point d'ecoute à 15min parce que moins de gens donc ça explique qu'il y ait moins d'obs !
:::

### 2.4.c Pour le Taleve

```{r}
# Taleve 
#On redefinis les annees
annee_min <- min(year(process_data$date_debut), na.rm = TRUE)
annee_max <- max(year(process_data$date_debut), na.rm = TRUE)
duree_annees <- annee_max - annee_min + 1


data_taleve <- process_data %>%
  filter(nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu") %>%
  mutate(
    annee_suivi  = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine      = isoweek(date_debut)
  )

# --- Résumer les semaines (gestion des observations / sorties) ---
data_taleve_summarized <- data_taleve %>%
  group_by(annee_suivi, semaine) %>%
  summarize(
    statut = case_when(
      any(nombre_min > 0)  ~ "observation",
      any(nombre_min == 0) ~ "sortie_sans_observation"
    ),
    .groups = "drop"
  )

# --- Grille complète année x semaine ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine     = 1:53
) %>%
  mutate(
    annee_reelle = annee_min + annee_suivi - 1
  ) %>%
  left_join(
    data_taleve_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(
    statut = ifelse(is.na(statut), "pas_de_sortie", statut)
  )

# --- Graphique calendrier ---
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", size = 0.2) +
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "observation"              = "#0072B2",
      "sortie_sans_observation"  = "#E69F00",
      "pas_de_sortie"            = "lightgrey"
    )
  ) +
  labs(
    title    = paste("Observations de", data_taleve),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())
```

# 2.5 nombre d'observation par observateur depuis le début des données

##2.5.a Nombre d'observation par observateur

```{r}

#0) Diagnostic : afficher un aperçu de process_data ---

cat("Aperçu de process_data (5 premières lignes) :\n")
print(utils::head(process_data, 5))
cat("\nStructure de process_data :\n")
print(str(process_data))

# --- 1) Re-créer data_filtered au cas où (exclusion ADENA, insensible à la casse et aux espaces) ---
data_filtered <- process_data %>%
  # s'assurer que la colonne existe et est en caractère
  mutate(observateurs = as.character(observateurs)) %>%
  # nettoyer espaces début/fin et remplacer NA par "NA_obs" si besoin (optionnel)
  mutate(observateurs = str_trim(observateurs)) %>%
  # exclusion insensible à la casse de "ADENA" (gère "Adena", " ADENA ", etc.)
  filter(!is.na(observateurs) & !(str_to_upper(observateurs) == "ADENA"))

cat("\nVérification data_filtered (5 premières lignes) :\n")
print(utils::head(data_filtered, 5))
cat("\nNombre de lignes après filtre :", nrow(data_filtered), "\n")

# --- 2) Agrégation : somme de nombre_min par observateur ---

data_summarized <- data_filtered %>%
  # s'assurer que nombre_min est numérique
  mutate(nombre_min = as.numeric(nombre_min)) %>%
  group_by(observateurs) %>%
  summarise(
    total_min = sum(nombre_min, na.rm = TRUE),
    n_rows = n(),
    .groups = "drop"
  )

cat("\nTable agrégée (top 20) :\n")
print(utils::head(arrange(data_summarized, desc(total_min)), 20))

# Vérification d'éventuels problèmes
if (nrow(data_summarized) == 0) {
  stop("data_summarized est vide — vérifie que data_filtered contient des lignes et que la colonne nombre_min est numérique.")
}
if (all(is.na(data_summarized$total_min))) {
  stop("Toutes les sommes sont NA — vérifie la colonne nombre_min (valeurs non numériques).")
}

# --- 3) Réordonner les observateurs pour un affichage clair (optionnel) ---
data_summarized <- data_summarized %>%
  arrange(desc(total_min)) %>%
  mutate(observateurs = factor(observateurs, levels = observateurs))

# --- 4) Tracer le barplot avec geom_col() et valeurs au-dessus des barres ---
p <- ggplot(data_summarized, aes(x = observateurs, y = total_min)) +
  geom_col() +                           # geom_col() = geom_bar(stat="identity")
  geom_text(aes(label = round(total_min, 1)), 
            vjust = -0.3, size = 3) +    # afficher la valeur au-dessus
  labs(
    title = "Nombre total (nombre_min) par observateur\n(sans ADENA)",
    x = "Observateur",
    y = "Total nombre_min"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(p)

```

## 2.5.b Coontinuité dans le temps des observateurs

```{r}
 process_data <- process_data %>%
  mutate(date_debut = as.Date(date_debut))  # transforme si c'était du texte

# Optionnel : enlever "ADENA" si tu ne veux pas la voir
process_data <- process_data %>%
  filter(observateurs != "")

# Optionnel : trier les observateurs par fréquence
process_data <- process_data %>%
  mutate(observateurs = forcats::fct_infreq(observateurs))

# --- Graphe de présence ---
ggplot(process_data, aes(x = date_debut, y = observateurs)) +
  geom_point(alpha = 0.7, color = "steelblue", size = 3) +
  labs(
    title = "Présence des observateurs dans le temps",
    x = "Date de début",
    y = "Observateurs"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

::: {.callout-note style="green"}
## Interpretation

ADENA : nom de l'asso , tout le temps présent depuis 1990

sans ADENA : obs commencent à 2011/13? obs principaux : Mathier Lognos (jusqu'à 2022?) et Nathalie Guenel

ATTENTION presque la moitiés des observations sont faites par une multitude de personnes conséquences sur le biais observateur
:::

# 6 Que faire pour la suite ????????????

[**Objectif**]{.underline} :

-Étudier l'évolution des populations par espèce dans le temps.

---\> I**dentifier les tendances** : augmentation, diminution ou stabilité.

---\> **Tester l'influence des variables climatiques** sur la fluctuation des populations. ---\> modèles prédictifs (GLM ? model mutilevel (avec effet espece)?).

[**Questions méthodologiques**]{.underline}

---\>**Quelles années inclure** ? -Peut-être se concentrer sur les années où le protocole a été rigoureusement suivi, par ex. à partir de 2013/2014. -Possibilité : comparer les résultats avec et sans les années "moins fiables".

---\>**Données opportunistes** : garder ou séparer ?

[**Constat** :]{.underline} les obervations en terme d'effort journaliers, de changement des obs en 2014 et 2018 correspondent à ce qu'on peut lire dans les fiches protocoles ce qui est plutôt rassurant. Que 4 obs protocolees de Butor toutes anciennes dont 3 dont on connait pas l'heure ????

[**Problème :**]{.underline}

Il y a eu au moins 2 changements de "protocoles" sur les 30 ans. Un protocole établis en 2014 qui contraste avec les données d'avant qui étaient surement rigoureuse (**poser la question aux gens de la reserve**)? Et une reduction du temps d'écoute par site en 2018 au moins pour blongios Talève (quid du butor). Donc si on veut faire des suivies rigoureux statistiquement entre le fait qu'on peut moyen prendre les données autre que protocolées + il y a différents protocoles + il y a différents observateur.ices (moindre mesure) ça semble tendu du slip pour avoir assez de points sur assez de temps.

#7 Idées plus poussées

on compare les protocoles et les opportunistes : est ce que protocoles vraiments utiles ? 1. quelle est la probabilité de détection ? - Occupancy (binomial) : est ce que proba varie selon climat. + biais opservateur

2.  Quelle est la présence espèce dans le temps ?

-   GLMM (poisson) : population varie dans le temps ? (modèle Null) Pop˚ varie selon climat ? attention : population ouverte ou fermée ? -\> on peut faire l'hypothèse de fermeture ponctuelle (pendant les migrations)? si ouvert : on peut aussi regarder la date d'arrivée selon le temps et le climat.

tri données : avant 2014 -\> pas de protocole ? donc on commence nos modèles en 2014 ? est ce qu'on sépare les modèles selon les différents protocoles pour la même espèce ? ex: pour Butor deux protocoles différents entre 2014-2018 et 2018-2025. Pareil pour Blongios Talève.
