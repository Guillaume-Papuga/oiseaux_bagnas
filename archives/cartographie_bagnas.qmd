---
title: "cartographie_site_observation"
format: html
editor: visual
---

## cartographie de la reserve....

```{r}
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
setwd("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/raw")
#recuperer les données : 
raw_data<- read_excel("synthese_observations_2025-09-09T13_30_50.994Z.xlsx") 

process_data_1= raw_data %>%
  select(id_synthese,date_debut,date_fin,heure_debut,heure_fin,
         nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326,
         y_centroid_4326,nom_lieu,champs_additionnels)

process_data_1 <- process_data_1 %>%
  mutate(
    heure_debut = format(heure_debut, "%H:%M:%S"),
    heure_fin   = format(heure_fin,   "%H:%M:%S")
  )

process_data_1 %>% count(heure_debut)


process_data_1 <- process_data_1 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )

raw_data_2 <- read_delim(
  "~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/raw/synthese_observations_2025-11-24T07_38_00.302Z (2).csv",
  delim = ";",
  locale = locale(encoding = "Latin1", decimal_mark = ".")
)

process_data_2 <- raw_data_2 %>%
  select(id_synthese, date_debut, date_fin, heure_debut, heure_fin,
         nom_vernaculaire, nombre_min, observateurs, determinateur,
         x_centroid_4326, y_centroid_4326,
         nom_lieu, champs_additionnels)

process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = as.character(x_centroid_4326),
    y_centroid_4326 = as.character(y_centroid_4326)
  )


process_data_1<- process_data_1 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )

process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )

process_data_2 <- process_data_2 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )

#verification des données soit identiques pour le butor et le taleve


process_data_2 <- process_data_2 %>%
  mutate(
    heure_debut = as.character(heure_debut),
    heure_fin   = as.character(heure_fin)
  )
process_data_2$champs_additionnels[ process_data_2$id_synthese == 124571 ] <- 
  process_data_1$champs_additionnels[720]

# Comparaison BUTOR ÉTOILÉ
Butor_etoile_1 <- process_data_1   %>% filter(nom_vernaculaire == "Butor étoilé")
Butor_etoile_2 <- process_data_2 %>% filter(nom_vernaculaire == "Butor étoilé")

all.equal(Butor_etoile_1, Butor_etoile_2)

# Comparaison BLONGIOS
Blongios_1 <- process_data_1 %>%
  filter(nom_vernaculaire == "Blongios nain, Butor blongios")

Blongios_2 <- process_data_2 %>%
  filter(nom_vernaculaire == "Blongios nain, Butor blongios")

all.equal(Blongios_1, Blongios_2)

process_data = process_data_2

write_csv(process_data, "~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")
```

à oublier pour le moment

```{r}
library(leaflet)
library(sf)
library(RColorBrewer) 
library(dplyr)
library(readr)


process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")

sites_sf <- st_as_sf(process_data, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

```

## .... avec les points d'observation des oiseaux. à oublier pour le moment

carte interactive, on peut zoomer et cliquer sur les points pour avoir les noms d'espèces

```{r}

leaflet() %>%
  addTiles() %>%     # fond OSM
  addPolygons(
    data = clc12_bagnas,
    fillColor = "green",
    color = "darkgreen",
    weight = 1,
    fillOpacity = 0.4,
    popup = ~as.character(CODE_12)   # nom de l'attribut habitat CLC
  ) %>%
  addCircleMarkers(
    data =sites_sf,
    radius = 5,
    color = "red",
    fillOpacity = 0.9,
    popup = ~nom_vernaculaire
  ) %>%
  setView(lng = 3.3, lat = 43.6, zoom = 9)


```

## .... avec les les sites d'observation (protocole ou opportuniste) des oiseaux

carte interactive, on peut zoomer et cliquer sur les points pour avoir les noms des sites attention : que depuis 2014 (pour filtrer les vieilles données bancales)

```{r}
sites_sf$annee<-year(floor_date(sites_sf$date_debut, "year"))
sites_sf<- sites_sf %>%
  filter(annee> 2013)  

sites_resume <- sites_sf %>%
  mutate(
    is_protocole = grepl("SuiviBlongiosTalève|SuiviButor", champs_additionnels)
  ) %>%
  group_by(nom_lieu) %>%
  summarise(
    geometry = first(geometry),   # ← IMPORTANT
    has_protocole = any(is_protocole, na.rm = TRUE),
    has_opportuniste = any(!is_protocole, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  st_as_sf() %>%                   # sécurisation
  mutate(
    couleur = case_when(
      has_protocole & has_opportuniste ~ "purple",
      has_protocole & !has_opportuniste ~ "red",
      !has_protocole & has_opportuniste ~ "green",
      TRUE ~ "grey"
    )
  )

leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_resume,
    radius = 5,
    color = ~couleur,
    fillOpacity = 0.9,
    popup = ~nom_lieu
  ) %>%
  setView(lng = 3.3, lat = 43.6, zoom = 9)




```
## Cartographie des sites protocolés 

```{r}

process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

sites_protocole <- st_as_sf(process_protocole, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole,
    radius = 5,
    color = "red",
    fillOpacity = 0.9,
    popup = ~nom_lieu
  ) %>%
  setView(lng = 3.3, lat = 43.6, zoom = 9)



```

## cartographie des sites protocoles avec la taille des points qui montre l'abondance par site (de 2014 à 2025 confondu) pour chaque espèces 

```{r}
process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

process_protocole_blongios <- process_protocole %>%
  filter(nom_vernaculaire=="Blongios nain, Butor blongios")

sites_protocole_blongios <- st_as_sf(process_protocole_blongios, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

sites_protocole_blongios2 <- sites_protocole_blongios %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )


leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_blongios2,
    radius = ~somme_nombre_min,
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Blongios entendus :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)


```

```{r}

process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

process_protocole_taleve <- process_protocole %>%
  filter(nom_vernaculaire=="Talève sultane, Poule sultane, Porphyrion bleu")

sites_protocole_taleve <- st_as_sf(process_protocole_taleve, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

sites_protocole_taleve <- sites_protocole_taleve %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )


leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_taleve,
    radius = ~somme_nombre_min,
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Talèves entendues :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)


```

```{r}
process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

process_protocole_butor <- process_protocole %>%
  filter(nom_vernaculaire=="Butor étoilé")

sites_protocole_butor <- st_as_sf(process_protocole_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

sites_protocole_butor <- sites_protocole_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )


leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_butor,
    radius = ~somme_nombre_min,
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```

