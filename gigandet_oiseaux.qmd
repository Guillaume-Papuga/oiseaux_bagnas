

```{r}
library(tidyverse)
library(lubridate) 
library(readxl)
library(lubridate) 
library(ggplot2) 
library(sf)


getwd()

raw_data<- read_excel("synthese_observations_2025-09-09T13_30_50.994Z.xlsx") 
View(raw_data)

#clean 

process_data<- raw_data %>%
  select(id_synthese,date_debut,date_fin,heure_debut,heure_fin,
         nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326,
         y_centroid_4326,nom_lieu,champs_additionnels)

write.csv(process_data,
          file = "C:/Users/emile/Documents/oiseaux_bagnas/data/pro/process_data.csv",
          row.names = FALSE)
```


```{r}
library(ggplot2)
library(dplyr)
library(forcats)
library(stringr)

# --- 0) Diagnostic : afficher un aperçu de process_data ---
cat("Aperçu de process_data (5 premières lignes) :\n")
print(utils::head(process_data, 5))
cat("\nStructure de process_data :\n")
print(str(process_data))

# --- 1) Re-créer data_filtered au cas où (exclusion ADENA, insensible à la casse et aux espaces) ---
data_filtered <- process_data %>%
  # s'assurer que la colonne existe et est en caractère
  mutate(observateurs = as.character(observateurs)) %>%
  # nettoyer espaces début/fin et remplacer NA par "NA_obs" si besoin (optionnel)
  mutate(observateurs = str_trim(observateurs)) %>%
  # exclusion insensible à la casse de "ADENA" (gère "Adena", " ADENA ", etc.)
  filter(!is.na(observateurs) & !(str_to_upper(observateurs) == "ADENA"))

cat("\nVérification data_filtered (5 premières lignes) :\n")
print(utils::head(data_filtered, 5))
cat("\nNombre de lignes après filtre :", nrow(data_filtered), "\n")

# --- 2) Agrégation : somme de nombre_min par observateur ---
data_summarized <- data_filtered %>%
  # s'assurer que nombre_min est numérique
  mutate(nombre_min = as.numeric(nombre_min)) %>%
  group_by(observateurs) %>%
  summarise(
    total_min = sum(nombre_min, na.rm = TRUE),
    n_rows = n(),
    .groups = "drop"
  )

cat("\nTable agrégée (top 20) :\n")
print(utils::head(arrange(data_summarized, desc(total_min)), 20))

# Vérification d'éventuels problèmes
if (nrow(data_summarized) == 0) {
  stop("data_summarized est vide — vérifie que data_filtered contient des lignes et que la colonne nombre_min est numérique.")
}
if (all(is.na(data_summarized$total_min))) {
  stop("Toutes les sommes sont NA — vérifie la colonne nombre_min (valeurs non numériques).")
}

# --- 3) Réordonner les observateurs pour un affichage clair (optionnel) ---
data_summarized <- data_summarized %>%
  arrange(desc(total_min)) %>%
  mutate(observateurs = factor(observateurs, levels = observateurs))

# --- 4) Tracer le barplot avec geom_col() et valeurs au-dessus des barres ---
p <- ggplot(data_summarized, aes(x = observateurs, y = total_min)) +
  geom_col() +                           # geom_col() = geom_bar(stat="identity")
  geom_text(aes(label = round(total_min, 1)), 
            vjust = -0.3, size = 3) +    # afficher la valeur au-dessus
  labs(
    title = "Nombre total (nombre_min) par observateur\n(sans ADENA)",
    x = "Observateur",
    y = "Total nombre_min"
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

print(p)

```

```{r}
library(ggplot2)
library(dplyr)
library(lubridate)

# Vérifie que la colonne "date_debut" est bien au format Date
process_data <- process_data %>%
  mutate(date_debut = as.Date(date_debut))  # transforme si c'était du texte

# Optionnel : enlever "ADENA" si tu ne veux pas la voir
process_data <- process_data %>%
  filter(observateurs != "")

# Optionnel : trier les observateurs par fréquence
process_data <- process_data %>%
  mutate(observateurs = forcats::fct_infreq(observateurs))

# --- Graphe de présence ---
ggplot(process_data, aes(x = date_debut, y = observateurs)) +
  geom_point(alpha = 0.7, color = "steelblue", size = 3) +
  labs(
    title = "Présence des observateurs dans le temps",
    x = "Date de début",
    y = "Observateurs"
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 10),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

```

