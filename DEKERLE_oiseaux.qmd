---
title: "DEKERLE_Oiseaux"
format: html
editor: visual
---

```{r}
#| message: false
#| warning: false

#| label: Packages necessaire
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
```

::: {.callout-warning style="border-left: 5px solid red; background-color: #fdd; padding: 1em;"}
## Attention

Pour les analyses à venir, vous devez utiliser le **nouveau jeu de données** créé après vérification qu'il est **complet et nettoyé** (voir les sections suivantes).

Il est important de commencer toutes les nouvelles analyses avec ce jeu de données afin que **tout le monde travaille sur la même base**. Le jeu de donnée se trouve dans le git commun dans le dossier data pro

Si vous avez besoin de **sous-jeux de données**, par exemple uniquement le **Butor étoilé** ou uniquement les données **opportunistes**, rendez-vous dans la **section 4** pour les récupérer, afin de **préserver la typologie correcte du jeu de données**.
:::

# 1. Jeux de données nécessaires ( par especes, par protocole....)

```{r}
#| label: DATA A UTILISER
#| echo: true
#| message: false
#| warning: false
 process_data <- read_csv("data/pro/process_data.csv")
process_protocole <- read_csv("data/pro/process_protocole.csv")
```

```{r}
## 4.1 Par especes
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

Blongios_nain<-process_data %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

```

## 1.2 Par protocole

```{r}
#| label: data par protocole
suivi<-process_protocole %>%
  filter(
  champs_additionnels%in% c(
    "{'RELV_NOM': 'SuiviBlongiostaleve'}",
    "{'RELV_NOM': 'SuiviButor'}"
  )
)

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Protocole_SuiviButor <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Blongios<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Blongios nain, Butor blongios"
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

```

## 2.2 effort d'observation journalier

### FACULTATIF ET PAS A JOUR Effort journalier toutes espèces tout protocole

```{r}

process_data <- process_data %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nen conservant les heures inconnues (0), tout protocole confondu")

```

### FACULTATIF ET PAS A JOUR Données d'heure sans les 00:00:00 et les absence d'heure tout espece tout protocole

```{r}
process_data <-process_data %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00") 

### Extraire l'heure

process_data <- process_data %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
process_data$heure_debut_tronc = as.factor(process_data$heure_debut_tronc)
### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure



### Frequence horaire

freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot


ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nsans les heures inconnues, tout protocole confondu")
```

### FACULTATIF ET PAS A JOUR Effort journalier Butor tout protocole

```{r}
Butor_etoile <- Butor_etoile %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")
### Extraire l'heure

Butor_etoile <- Butor_etoile %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Butor_etoile$heure_debut_tronc = as.factor(Butor_etoile$heure_debut_tronc)

### Sommer les obs par heure


obs_heure <- Butor_etoile %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure


### Frequence horaire


freq_heure <- Butor_etoile %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Butor étoilé) par heure \nsans les heures inconnues, tout protocole confondu")

```

### FACULTATIF ET PAS A JOUR Effort journalier Blongios tout protocole

```{r}
Blongios_nain <- Blongios_nain  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Blongios_nain <- Blongios_nain %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Blongios_nain$heure_debut_tronc = as.factor(Blongios_nain$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Blongios_nain %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Blongios_nain %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Blongios nain) par heure \nsans les heures inconnues, tout protocole confondu")
```

### FACULTATIF ET PAS A JOUR Effort journalier Taleve tout protocole

```{r}
Taleve_sultane <- Taleve_sultane  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Taleve_sultane <- Taleve_sultane %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Taleve_sultane$heure_debut_tronc = as.factor(Taleve_sultane$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Taleve_sultane %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Taleve_sultane %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Talève sultane) par heure \nsans les heures inconnues, tout protocole confondu")
```

### 2.2.a Effort journalier protocole Butor

```{r}

# DOnnées 
Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_SuiviButor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot


ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Butor (2014-2018)")

```

### 2.2.b Effort journalier opportuniste Butor

```{r}
# DOnnées 
Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Butor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Butor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations \n opportuniste par heure pour le Butor (1997-2023), \nsans les heures inconnues ")

```

### 2.2.c Effort journalier protocole Blongios

```{r}
# DOnnées 
Protocole_Blongios <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Blongios <- Protocole_Blongios %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Protocole_Blongios <- Protocole_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Blongios (2014-2018)")

```

### 2.2.d Effort journalier opportuniste Blongios

```{r}

# Données 
Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Blongios <- Opportuniste_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour le Blongios (2014-2018)")

```

### 2.2.e Effort journalier protocole Talève

```{r}
# DOnnées 
Protocole_Taleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Taleve <- Protocole_Taleve %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_Taleve <- Protocole_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Talève (2014-2018)")

```

### 2.2.f Effort journalier opportuniste Talève

```{r}

# Données 
Opportuniste_Taleve <- Opportuniste_Taleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Taleve <- Opportuniste_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour la Talève (2014-2018)")

```

### FACULTATIF ET PAS A JOUR Effort journalier protocole Blongios-Talève

```{r}
Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Protocole_SuiviBlongiosTaleve$heure_debut_tronc = as.factor(Protocole_SuiviBlongiosTaleve$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviBlongiosTaleve %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Protocole_SuiviBlongiosTaleve %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations protocolées \n(Blongios et Talève) par heure sans les heures inconnues")
```

::: {.callout-note style="green"}
## Interpretation

Beaucoup d'obs pour lesquelles l'heure est inconnue.

#Données d'heure sans les 00:00:00 (les 00 sont encore la ?) et les absence d'heure
:::

::: {.callout-note style="green"}
## Interpretation

Tout confondu : max au crépuscule (20h) et avant le levé du soleil (4-5h)

\- butor : max au crépuscule (20h-22h) et au levé du soleil (4-6h)

-   blongios : de 21h-23h et 5h à 9h

-   Taleve : de 5h à 9h avec GROS PIC à 8h puis de 20 à 21.

-   protocole blongios taleve = obs a 6h et 7h et 20h et 21h.

    =\> globalement tout correspond aux protocoles mis en place SAUF

-   protocole butor: UNE SEULE OBS PROTOCOLEE DONT ON CONNAIS L'HEURE et elle date de 1998 (j'ai verif les données brutes et effectivement c'est le cas)
:::

# GLMM observation du butor en fonction du temps

## charger les packages

```{r}
library(dplyr)
library(lubridate)
library(MASS)
library(lme4)
library(stats)
```

## charger les données

```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

### Obs Butor tout protocoles
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

### Données butor protocolées  
Protocole_SuiviButor <- process_data %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

###Données butor opportuniste 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

```

## Préparer les variables temporelles

### Obs Butor tout protocoles

```{r}
Butor_etoile$date_debut <- as.Date(Butor_etoile$date_debut)

Butor_etoile <- Butor_etoile %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )
Butor_etoile <- Butor_etoile%>%
  filter(annee >= 2014)
Butor_etoile$annee2 <- as.numeric(as.character(Butor_etoile$annee)) - 2013

# Transformer en facteurs
Butor_etoile$annee <- as.numeric(Butor_etoile$annee)
Butor_etoile$mois  <- as.numeric(Butor_etoile$mois)
Butor_etoile$jour <- as.numeric(Butor_etoile$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

### Données butor protocolées

```{r}
Protocole_SuiviButor$date_debut <- as.Date(Protocole_SuiviButor$date_debut)

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor%>%
  filter(annee >= 2014)
Protocole_SuiviButor$annee2 <- as.numeric(as.character(Protocole_SuiviButor$annee)) - 2013

# Transformer en facteurs
Protocole_SuiviButor$annee <- as.numeric(Protocole_SuiviButor$annee)
Protocole_SuiviButor$mois  <- as.numeric(Protocole_SuiviButor$mois)
Protocole_SuiviButor$jour <- as.numeric(Protocole_SuiviButor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

### Données butor opportuniste

```{r}
Opportuniste_Butor$date_debut <- as.Date(Opportuniste_Butor$date_debut)

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor%>%
  filter(annee >= 2014)
Opportuniste_Butor$annee2 <- as.numeric(as.character(Opportuniste_Butor$annee)) - 2013

# Transformer en facteurs
Opportuniste_Butor$annee <- as.numeric(Opportuniste_Butor$annee)
Opportuniste_Butor$mois  <- as.numeric(Opportuniste_Butor$mois)
Opportuniste_Butor$jour <- as.numeric(Opportuniste_Butor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

## GLM Poisson + comparaison de modèles

### GLM Obs Butor tout protocoles

```{r}
# Modèle par année

modele_annee_butor_all <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Butor_etoile)
summary(modele_annee_butor_all)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_all <- glm(nombre_min ~ mois, 
                   data = Butor_etoile, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_all <- glm(nombre_min ~ jour, 
                   data = Butor_etoile, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_all <- glm(nombre_min ~ annee2 + mois, 
                         data = Butor_etoile, 
                         family = poisson)

modele_annee_jour_butor_all <- glm(nombre_min ~ annee2 + jour, 
                         data = Butor_etoile, 
                         family = poisson)
modele_mois_jour_butor_all <- glm(nombre_min ~ mois + jour, 
                        data = Butor_etoile, 
                        family = poisson)
modele_annee_mois_jours_butor_all <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Butor_etoile, 
                               family = poisson)


summary(modele_annee_butor_all)
summary(modele_mois_butor_all)
summary(modele_annee_mois_butor_all)
summary(modele_annee_jour_butor_all)
summary(modele_mois_jour_butor_all)
summary(modele_annee_mois_jours_butor_all)
summary(modele_jour_butor_all)
```

#### Comparaison modèle butor tout protocole

```{r}
AIC(modele_annee_butor_all, modele_mois_butor_all, modele_annee_mois_butor_all, modele_jour_butor_all, 
    modele_annee_mois_jours_butor_all, modele_mois_jour_butor_all, modele_annee_jour_butor_all)
```

##### AIC similaire entre modele_annee_mois_butor_all (AIC la plus petite) et modele_mois_butor_all (le moins de paramètre) donc par parcimonie modele_mois_butor_all est le meilleur.

#### Graphique modele temporelle butor tout protocole

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
```

### modele temporel Données butor protocolées IL Y A PAS D'OBSERVATIONS MDRRRRRRRRRRRR DONC LE SCRIPT EST FAIT MAIS LES MODELES SERVENT A RIEN

```{r}
# Modèle par année

modele_annee_butor_prot <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviButor)
summary(modele_annee_butor_prot)

# 4b. Modèle par mois (4 niveaux seulement)
modele_mois_butor_prot <- glm(nombre_min ~ mois, 
                   data = Protocole_SuiviButor, 
                   family = poisson)
# 4b. Modèle par jour (4 niveaux seulement)
modele_jour_butor_prot <- glm(nombre_min ~ jour, 
                   data = Protocole_SuiviButor, 
                   family = poisson)

# 4c. Modèle combiné année + mois
modele_annee_mois_butor_prot <- glm(nombre_min ~ annee2 + mois, 
                         data = Protocole_SuiviButor, 
                         family = poisson)

modele_annee_jour_butor_prot <- glm(nombre_min ~ annee2 + jour, 
                         data = Protocole_SuiviButor, 
                         family = poisson)
modele_mois_jour_butor_prot <- glm(nombre_min ~ mois + jour, 
                        data = Protocole_SuiviButor, 
                        family = poisson)
modele_annee_mois_jours_butor_prot <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Protocole_SuiviButor, 
                               family = poisson)


summary(modele_annee_butor_prot)
summary(modele_mois_butor_prot)
summary(modele_annee_mois_butor_prot)
summary(modele_annee_jour_butor_prot)
summary(modele_mois_jour_butor_prot)
summary(modele_annee_mois_jours_butor_prot)
summary(modele_jour_butor_prot)
```

#### Comparaison modèles butor données protocolées

```{r}
AIC(modele_annee_butor_prot, modele_mois_butor_prot, modele_annee_mois_butor_prot, modele_jour_butor_prot, 
    modele_annee_mois_jours_butor_prot, modele_mois_jour_butor_prot, modele_annee_jour_butor_prot)
```

#### Graphique modele temporel butor données protocolées

### Modèle temporel données butor opportuniste

```{r}
# Modèle par année

modele_annee_butor_opp <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Opportuniste_Butor)
summary(modele_annee_butor_opp)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_opp <- glm(nombre_min ~ mois, 
                   data = Opportuniste_Butor, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_opp <- glm(nombre_min ~ jour, 
                   data = Opportuniste_Butor, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_opp <- glm(nombre_min ~ annee2 + mois, 
                         data = Opportuniste_Butor, 
                         family = poisson)

modele_annee_jour_butor_opp <- glm(nombre_min ~ annee2 + jour, 
                         data = Opportuniste_Butor, 
                         family = poisson)
modele_mois_jour_butor_opp <- glm(nombre_min ~ mois + jour, 
                        data = Opportuniste_Butor, 
                        family = poisson)
modele_annee_mois_jours_butor_opp <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Opportuniste_Butor, 
                               family = poisson)


summary(modele_annee_butor_opp)
summary(modele_mois_butor_opp)
summary(modele_annee_mois_butor_opp)
summary(modele_annee_jour_butor_opp)
summary(modele_mois_jour_butor_opp)
summary(modele_annee_mois_jours_butor_opp)
summary(modele_jour_butor_opp)
```

#### Comparaison modèles butor donnees opportunistes

```{r}
AIC(modele_annee_butor_opp, modele_mois_butor_opp, modele_annee_mois_butor_opp, modele_jour_butor_opp, 
    modele_annee_mois_jours_butor_opp, modele_mois_jour_butor_opp, modele_annee_jour_butor_opp)
```

##### qualité similaire entre les modeles annee mois et jour parce que bon il y a que 30 obs opportunistes jpp.

#### Graphique modele temporele butor données opportunistes

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$annee2)
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
boxplot(Butor_etoile$nombre_min~Butor_etoile$jour )
```

# GLM poisson variable météo ?

## preparer les donnees

```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

env_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/environnement_daily.csv")
```

### 

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

a mettre au propre en mettant que protocolé vs opportuniste

```{r}
process_data <- process_data %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

### Sommer les obs par heure

obs_heure <- process_data %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- process_data %>% 
  group_by(heure_debut_tronc, champs_additionnels) %>% 
  summarise(freq = n(), .groups = "drop")

### Barplot

ggplot() +
  geom_bar(
    data = freq_heure,
    aes(x = heure_debut_tronc, y = freq, fill = champs_additionnels),
    width = 0.8,
    stat = "identity",
    position = "stack"   # ou "dodge" si tu préfères côte à côte
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée (tronquée à l'inférieur)") +
  ylab("Nombre de prospections") +
  labs(fill = "Facteur") +
  ggtitle(
    "Effort d'échantillonnage en fonction des suivis (heures inconnues conservées)"
  )

```

------------------------------------------------------------------------

#Jsp somme Obs butor au fil des années + jours julien jsp

qwwwwwwwwwwwwww## 1. Rassembler les deux tableaux de données

a)  récupérer les tableaux de données brute.

```{r}
#charger le chemin d'accès : à adapter à votre ordinateur 
setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas")

#charger les données brutes: 2 tableaux
raw_data<- read_excel("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/synthese_observations_2025-09-09T13_30_50.994Z.xlsx")

raw_data_2 <- read_delim(
  "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/synthese_observations_2025-11-24T07_38_00.302Z (2).csv",
  delim = ";",
  locale = locale(encoding = "Latin1", decimal_mark = ".")
)

```

Nous conservons uniquement les colonnes pertinentes pour la suite de l'analyse, en supprimant les colonnes vides ainsi que celles dont l'information est redondante, notamment les noms latins.

```{r}

process_data_1= raw_data %>%
  select(id_synthese,date_debut,date_fin,heure_debut,heure_fin,
         nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326,
         y_centroid_4326,nom_lieu,champs_additionnels)

process_data_2 <- raw_data_2 %>%
  select(id_synthese, date_debut, date_fin, heure_debut, heure_fin,
         nom_vernaculaire, nombre_min, observateurs, determinateur,
         x_centroid_4326, y_centroid_4326,
         nom_lieu, champs_additionnels)

# On garde uniquement l'heure (HH:MM:SS) dans heure_debut / heure_fin
# car le fichier original contenait une date + une heure
process_data_1 <- process_data_1 %>%
  mutate(
    heure_debut = format(heure_debut, "%H:%M:%S"),
    heure_fin   = format(heure_fin,   "%H:%M:%S")
  )

# mettre en format date les dates de debut et de fin 

process_data_1 <- process_data_1 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )



process_data_2 <- process_data_2 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )

#correction des formats de certaines colonnes
process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = as.character(x_centroid_4326),
    y_centroid_4326 = as.character(y_centroid_4326)
  )

process_data_1<- process_data_1 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )

process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )
# Le fichier brut est en format "dd/mm/YYYY"
# On convertit proprement en Date (format standard YYYY-MM-DD)


process_data_2 <- process_data_2 %>%
  mutate(
    heure_debut = as.character(heure_debut),
    heure_fin   = as.character(heure_fin)
  )

# La ligne 132 de process_data_2 avait un NA
# On remplace par la valeur correspondante dans process_data_1 (ligne 720)
process_data_2$champs_additionnels[ process_data_2$id_synthese == 124571 ] <- 
  process_data_1$champs_additionnels[720]

#création du tableau final avec les 3 espèces et les colonnes dans le bon format. C'est ce tableau qui est par la suite utilisé. 
process_data = process_data_2

write_csv(process_data, "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

```

## 2. Créer le tableau de données utilisé dans les analyses sur le protocole

```{r}
#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
process_data$annee = year(floor_date(process_data$date_debut, "year"))

#on filtre pour enlever toutes les données avant 2014 (le début des protocoles)
# on filtre pour garder les lieux protocolés "ButorTalèveBlongios de 1 à 9 ; on garde uniquement les données Butor 
process_butor = process_data  %>%
  filter( nom_vernaculaire == "Butor étoilé")

```

```{r}
##### création des lignes pour les jours manquants du tableau environnement_daily

# étape 1 création d'un tableau de 1990 à 2025 avec une variable jour julian

date_debut <- as.Date("1990-11-18")
date_fin   <- as.Date("2025-10-09")

toutes_dates <- seq(from = date_debut, to = date_fin, by = "day")

données_1990_2025 <- data.frame(
  Date = toutes_dates)

données_1990_2025$julian = yday(données_1990_2025$Date)

View(données_1990_2025)

# étape 2 on va forcer le rajout des lignes avec un full.join qui permet de rajouter toutes les lignes du tableau 2 au premier tableau meme si les lignes n'ont pas de jointures

butor_daily <- process_butor

process_butor$Date <- process_butor$date_debut

butor_daily <- process_butor %>%
  full_join(
    données_1990_2025 %>% select(Date, julian),
    by = "Date"
  )

```

```{r}

obs_annee <- butor_daily %>%
  group_by(annee) %>%
  summarize(sum(nombre_min))

### Barplot

ggplot(obs_annee, aes(x = annee)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Année") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque année entre 1990 et 2025")

```

# par jour

```{r}

obs_julian <- butor_daily %>%
  group_by(julian) %>%
  summarize(sum(nombre_min, na.rm = TRUE))

### Barplot

ggplot(obs_julian, aes(x = julian)) +
  geom_bar(aes(y = `sum(nombre_min, na.rm = TRUE)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Jour julien") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque jour julien entre 1990 et 2025")
```

# faire par jour pour chaque annee

```{r}

obs_julian <- butor_daily %>%
  group_by(annee, julian) %>%
  summarize(sum(nombre_min, na.rm = TRUE))


graph <- ggplot(obs_julian, aes(x = julian)) +
  geom_bar(aes(y = `sum(nombre_min, na.rm = TRUE)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Jour julien") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque jour julien entre 1990 et 2025")

graph + facet_grid(. ~ annee)

```

# avec une boucle

```{r}

# sommer les obsvertions par année et par jour julien

obs_julian <- butor_daily %>%
  group_by(annee, julian) %>%
  summarize(sum(nombre_min, na.rm = TRUE))

for (a in unique(obs_julian$annee)) {

  graph_annee <- ggplot(
    obs_julian %>% filter(annee == a),
    aes(x = julian, y = `sum(nombre_min, na.rm = TRUE)`)
  ) +
    geom_col(width = 0.4, fill = "blue") +
    theme_classic() +
    scale_y_continuous(expand = c(0, 0)
    ) +
    scale_x_continuous(limits = c(1, 365), expand = c(0, 0)) +
    xlab("Jour julien") +
    ylab("Nombre d'observations") +
    ggtitle(paste(
      "Nombre de butors observés chaque jour julien en", a
    ))

  print(graph_annee)
}
```

quel interet quand on voit le peu d'obs par ans ??? refaire en gardant tous les jours juliens pour que ce soit plus lisible

# par année pour chaque sites

```{r}

obs_site <- butor_daily %>%
  group_by(annee, nom_lieu) %>%
  summarize(sum(nombre_min, na.rm = TRUE))


for (a in unique(obs_site$nom_lieu)) {

  graph_site <- ggplot(
    obs_site %>% filter(nom_lieu == a),
    aes(x = annee, y = `sum(nombre_min, na.rm = TRUE)`)
  ) +
    geom_col(width = 0.4, fill = "blue") +
    theme_classic() +
    scale_y_continuous(expand = c(0, 0)) +
    scale_x_continuous(limits = c(1990, 2025), expand = c(0, 0)) +
    xlab("Annee") +
    ylab("Nombre d'observations") +
    ggtitle(paste(
      "Nombre de butors observés chaque année au site", a
    ))

  print(graph_site)
}

```

# CLEAN BUTOR ET REDACTION RAPPORT
---
title: "Butor_clean"
format: html
editor: visual
---

```{r setup}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
#ce code permet de n'afficher auxun message parasite ni les warnings. 
```

# Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(slider)

setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro")
process_data <- read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")
```

## 1. analyses exploratoires pour le Butor

### A- Graphique de présence des Butors par semaine depuis 1990

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 


esp_butor<- "Butor étoilé"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_butor <- process_data %>%
  filter(nom_vernaculaire == esp_butor) %>% #on filtre pour avoir uniquement les lignes du Butor dans le data frame
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1, 
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut) # on crée les numéros des semaines
  )

# --- Résumer les semaines pour gérer les sorties multiples ---
data_butor_summarized <- data_butor %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviButor", champs_additionnels) #on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole

      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )
# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_butor_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de", esp_butor),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

### B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/pro/process_protocole.csv")

process_protocole_butor <- process_protocole %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_protocole_butor <- st_as_sf(process_protocole_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_protocole_butor <- sites_protocole_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     

  addCircleMarkers(
    data =sites_protocole_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```

### C- Effort journalier du protocole Butor

```{r}
# Données protocolées du Butor
process_protocole <- read_csv("data/pro/process_protocole.csv")



Protocole_SuiviButor <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Création d'une table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les observation par heure

obs_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_SuiviButor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Butor (2014-2018)")
```

### D- Effort journalier des données opportunistes

```{r}
# Données 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Butor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Butor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations \n opportunistes par heure pour le Butor (1997-2023), \nsans les heures inconnues ")

```

### E - Cumule des observations de Butor

```{r}

# étape 0 création d'une variable année 

#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
data_butor$annee = year(floor_date(data_butor$date_debut, "year"))

```

#### a - Cumule par année

```{r}

obs_annee <- data_butor %>%
  group_by(annee) %>%
  summarize(sum(nombre_min))

### Barplot

ggplot(obs_annee, aes(x = annee)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Année") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque année entre 1990 et 2025")

```

#### b - Cumule par semaine

```{r}
obs_semaine <- data_butor %>%
  group_by(semaine) %>%
  summarize(sum(nombre_min, na.rm = TRUE)) %>%
  mutate(
    saison = case_when(
      semaine %in% c(0:12, 52:53) ~ "Hiver",
      semaine %in% 13:25          ~ "Printemps",
      semaine %in% 26:38          ~ "Été",
      semaine %in% 39:51          ~ "Automne"
    )
  )

### Barplot

ggplot(obs_semaine, aes(x = semaine)) +
  geom_rect(
    aes(xmin = 15, xmax = 21, ymin = -Inf, ymax = Inf,
        fill = "Période du protocole"),
    inherit.aes = FALSE
  ) +
  geom_bar(
    aes(y = `sum(nombre_min, na.rm = TRUE)`, fill = saison),
    stat = "identity",
    width = 0.4
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(
    values = c(
      "Hiver" = "steelblue",
      "Printemps" = "forestgreen",
      "Été" = "gold",
      "Automne" = "darkorange",
      "Période du protocole" = "grey70"
    )
  ) +
  xlab("Semaine") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque semaine de l'année entre 1990 et 2025") +
  labs(fill = "")

```

#### c - Cumule par année pour chaque site (même les sites hors protocole)

```{r}
process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")


process_butor <- process_data %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_butor <- st_as_sf(process_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_butor <- sites_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     
  
  addCircleMarkers(
    data =sites_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)
```