---
title: "DEKERLE_Oiseaux"
format: html
editor: visual
---

## Test

Hello : ) !

```{r}
library(tidyverse); library(lubridate); library(readxl); library(lubridate); library(spatstat.geom); library(spatstat.explore); library(ggplot2); library(ggspatial); library(ggmap); library(sf)
```

```{r}
raw_data<- read_excel("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/synthese_observations_2025-09-09T13_30_50.994Z.xlsx"); View(raw_data)
```

#clean

```{r}
process_data<- raw_data %>% select(id_synthese,date_debut,date_fin,heure_debut,heure_fin, nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326, y_centroid_4326,nom_lieu,champs_additionnels)

write.csv(process_data, file = "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv", row.names = FALSE)
```

# Aperçu des especes

```{r}
head(raw_data); str(raw_data); glimpse(raw_data)

occ_par_espece <- raw_data %>% group_by(nom_vernaculaire) %>% summarise(id_synthese= n()) %>% arrange(desc(id_synthese))

head(occ_par_espece)
```

#Aperçu des années

```{r}
occ_par_annee<-raw_data %>% mutate( date_parsed = ymd(date_debut),
annee = year(date_parsed) ) %>% group_by(annee) %>% summarise(total_individus = n(), .groups = "drop") %>% arrange(desc(annee))

print(occ_par_annee, n = Inf)

ggplot(raw_data, aes(x = x_centroid_4326, y = y_centroid_4326, color = nom_vernaculaire)) + geom_point(alpha = 0.6 , size = 1) + coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")
```

# Par espece

### Butor étoilé

```{r}
Butor_etoile<-raw_data %>% filter( nom_vernaculaire == "Butor étoilé")

Butor_etoile
```

#Aperçu des années du butor etoile

```{r}

occ_par_annee_butor_etoile<-Butor_etoile %>% mutate( date_parsed = ymd(date_debut),
annee_butor_etoile = year(date_parsed) ) %>% group_by(annee_butor_etoile) %>% summarise(total_individus = n(), .groups = "drop") %>% arrange(desc( annee_butor_etoile))

print(occ_par_annee_butor_etoile, n = Inf)

ggplot(occ_par_annee_butor_etoile, aes(x = annee_butor_etoile, y = total_individus)) + geom_bar(stat = "identity", fill = "#2c7fb8") + labs( title = "Observations annuelles du Butor etoile", x = "Année", y = "Nombre d'individus observés" ) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(Butor_etoile, aes(x = x_centroid_4326, y = y_centroid_4326)) + geom_point(alpha = 0.6) + coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")
```

### Blongios nain, Butor blongios

```{r}
Blongios_nain<-raw_data %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Blongios_nain
```

#Aperçu des années Blongios nain, Butor blongios

```{r}

occ_par_annee_Blongios_nain<-Blongios_nain %>% mutate( date_parsed = ymd(date_debut),
annee_Blongios_nain = year(date_parsed) ) %>% group_by(annee_Blongios_nain) %>% summarise(total_individus = n(), .groups = "drop") %>% arrange(desc(annee_Blongios_nain))

print(occ_par_annee_Blongios_nain, n = Inf)

ggplot(occ_par_annee_Blongios_nain, aes(x = annee_Blongios_nain, y = total_individus)) + geom_bar(stat = "identity", fill = "#2c7fb8") + labs( title = "Observations annuelles du Blongios nain", x = "Année", y = "Nombre d'individus observés" ) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(Blongios_nain, aes(x = x_centroid_4326, y = y_centroid_4326)) + geom_point(alpha = 0.6) + coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")
```

# Effort d'échantillonnage

## Effort journalier toutes espèces

## Données d'heure brutes

### Extraire l'heure

```{r}

process_data <- process_data %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
process_data$heure_debut_tronc = as.factor(process_data$heure_debut_tronc)
```

### Sommer les obs par heure

```{r}

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

```

### Frequence horaire

```{r}


freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

```

### Barplot

```{r}


ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nen conservant les heures inconnues (0), tout protocole confondu")



```

bcp à minuit parce que nsr il y a plein de 00:00:00 ou de juste c'est pas écrit donc IG il considère que c'est minuit

## Données d'heure sans les 00:00:00 et les absence d'heure

### enlever les heures indésirables

```{r}
process_data <- process_data %>% filter(heure_debut> as.Date("1899-12-31 00:00:00")) ; View (process_data)


```

### Extraire l'heure

```{r}

process_data <- process_data %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
process_data$heure_debut_tronc = as.factor(process_data$heure_debut_tronc)
```

### Sommer les obs par heure

```{r}

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

```

### Frequence horaire

```{r}
freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))
```

### Barplot

```{r}
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nsans les heures inconnues, tout protocole confondu")
```

## Effort journalier Butor

### enlever les heures indésirables

```{r}
Butor_etoile <- Butor_etoile %>% filter(heure_debut> as.Date("1899-12-31 00:00:00")) ; View (Butor_etoile)


```

### Extraire l'heure

```{r}

Butor_etoile <- Butor_etoile %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Butor_etoile$heure_debut_tronc = as.factor(Butor_etoile$heure_debut_tronc)
```

### Sommer les obs par heure

```{r}

obs_heure <- Butor_etoile %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

```

### Frequence horaire

```{r}

freq_heure <- Butor_etoile %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

```

### Barplot

```{r}
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Butor étoilé) par heure \nsans les heures inconnues, tout protocole confondu")
```

## Effort journalier Blongios

### enlever les heures indésirables

```{r}
Blongios_nain <- Blongios_nain %>% filter(heure_debut> as.Date("1899-12-31 00:00:00")) ; View (Blongios_nain)

```

### Extraire l'heure

```{r}

Blongios_nain <- Blongios_nain %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Blongios_nain$heure_debut_tronc = as.factor(Blongios_nain$heure_debut_tronc)
```

### Sommer les obs par heure

```{r}

obs_heure <- Blongios_nain %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

```

### Frequence horaire

```{r}

freq_heure <- Blongios_nain %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
```

### Barplot

```{r}
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'black') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en gris) et d'observations (en noir)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Blongios nain) par heure \nsans les heures inconnues, tout protocole confondu")
```


# GLMM observation du butor en fonction du temps 

## charger les packages 

```{r}
library(dplyr)
library(lubridate)
library(MASS)
library(lme4)
library(stats)
```

## charger les données 

```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

### Obs Butor tout protocoles
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

### Données butor protocolées  
Protocole_SuiviButor <- process_data %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

###Données butor opportuniste 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

```

## Préparer les variables temporelles


### Obs Butor tout protocoles
```{r}
Butor_etoile$date_debut <- as.Date(Butor_etoile$date_debut)

Butor_etoile <- Butor_etoile %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )
Butor_etoile <- Butor_etoile%>%
  filter(annee >= 2014)
Butor_etoile$annee2 <- as.numeric(as.character(Butor_etoile$annee)) - 2013

# Transformer en facteurs
Butor_etoile$annee <- as.numeric(Butor_etoile$annee)
Butor_etoile$mois  <- as.numeric(Butor_etoile$mois)
Butor_etoile$jour <- as.numeric(Butor_etoile$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```


### Données butor protocolées  

```{r}
Protocole_SuiviButor$date_debut <- as.Date(Protocole_SuiviButor$date_debut)

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor%>%
  filter(annee >= 2014)
Protocole_SuiviButor$annee2 <- as.numeric(as.character(Protocole_SuiviButor$annee)) - 2013

# Transformer en facteurs
Protocole_SuiviButor$annee <- as.numeric(Protocole_SuiviButor$annee)
Protocole_SuiviButor$mois  <- as.numeric(Protocole_SuiviButor$mois)
Protocole_SuiviButor$jour <- as.numeric(Protocole_SuiviButor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```



### Données butor opportuniste  

```{r}
Opportuniste_Butor$date_debut <- as.Date(Opportuniste_Butor$date_debut)

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor%>%
  filter(annee >= 2014)
Opportuniste_Butor$annee2 <- as.numeric(as.character(Opportuniste_Butor$annee)) - 2013

# Transformer en facteurs
Opportuniste_Butor$annee <- as.numeric(Opportuniste_Butor$annee)
Opportuniste_Butor$mois  <- as.numeric(Opportuniste_Butor$mois)
Opportuniste_Butor$jour <- as.numeric(Opportuniste_Butor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

## GLM Poisson + comparaison de modèles 

### GLM Obs Butor tout protocoles

```{r}
# Modèle par année

modele_annee_butor_all <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Butor_etoile)
summary(modele_annee_butor_all)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_all <- glm(nombre_min ~ mois, 
                   data = Butor_etoile, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_all <- glm(nombre_min ~ jour, 
                   data = Butor_etoile, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_all <- glm(nombre_min ~ annee2 + mois, 
                         data = Butor_etoile, 
                         family = poisson)

modele_annee_jour_butor_all <- glm(nombre_min ~ annee2 + jour, 
                         data = Butor_etoile, 
                         family = poisson)
modele_mois_jour_butor_all <- glm(nombre_min ~ mois + jour, 
                        data = Butor_etoile, 
                        family = poisson)
modele_annee_mois_jours_butor_all <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Butor_etoile, 
                               family = poisson)


summary(modele_annee_butor_all)
summary(modele_mois_butor_all)
summary(modele_annee_mois_butor_all)
summary(modele_annee_jour_butor_all)
summary(modele_mois_jour_butor_all)
summary(modele_annee_mois_jours_butor_all)
summary(modele_jour_butor_all)
```

#### Comparaison modèle butor  tout protocole 

```{r}
AIC(modele_annee_butor_all, modele_mois_butor_all, modele_annee_mois_butor_all, modele_jour_butor_all, 
    modele_annee_mois_jours_butor_all, modele_mois_jour_butor_all, modele_annee_jour_butor_all)
```
##### AIC similaire entre modele_annee_mois_butor_all (AIC la plus petite) et modele_mois_butor_all (le moins de paramètre) donc par parcimonie modele_mois_butor_all est le meilleur. 

#### Graphique modele temporelle butor tout protocole 

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
```


### modele temporel Données butor protocolées IL Y A PAS D'OBSERVATIONS MDRRRRRRRRRRRR DONC LE SCRIPT EST FAIT MAIS LES MODELES SERVENT A RIEN 

```{r}
# Modèle par année

modele_annee_butor_prot <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviButor)
summary(modele_annee_butor_prot)

# 4b. Modèle par mois (4 niveaux seulement)
modele_mois_butor_prot <- glm(nombre_min ~ mois, 
                   data = Protocole_SuiviButor, 
                   family = poisson)
# 4b. Modèle par jour (4 niveaux seulement)
modele_jour_butor_prot <- glm(nombre_min ~ jour, 
                   data = Protocole_SuiviButor, 
                   family = poisson)

# 4c. Modèle combiné année + mois
modele_annee_mois_butor_prot <- glm(nombre_min ~ annee2 + mois, 
                         data = Protocole_SuiviButor, 
                         family = poisson)

modele_annee_jour_butor_prot <- glm(nombre_min ~ annee2 + jour, 
                         data = Protocole_SuiviButor, 
                         family = poisson)
modele_mois_jour_butor_prot <- glm(nombre_min ~ mois + jour, 
                        data = Protocole_SuiviButor, 
                        family = poisson)
modele_annee_mois_jours_butor_prot <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Protocole_SuiviButor, 
                               family = poisson)


summary(modele_annee_butor_prot)
summary(modele_mois_butor_prot)
summary(modele_annee_mois_butor_prot)
summary(modele_annee_jour_butor_prot)
summary(modele_mois_jour_butor_prot)
summary(modele_annee_mois_jours_butor_prot)
summary(modele_jour_butor_prot)
```

#### Comparaison modèles butor données protocolées 

```{r}
AIC(modele_annee_butor_prot, modele_mois_butor_prot, modele_annee_mois_butor_prot, modele_jour_butor_prot, 
    modele_annee_mois_jours_butor_prot, modele_mois_jour_butor_prot, modele_annee_jour_butor_prot)
```

#### Graphique modele temporel butor données protocolées 


### Modèle temporel données butor opportuniste  

```{r}
# Modèle par année

modele_annee_butor_opp <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Opportuniste_Butor)
summary(modele_annee_butor_opp)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_opp <- glm(nombre_min ~ mois, 
                   data = Opportuniste_Butor, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_opp <- glm(nombre_min ~ jour, 
                   data = Opportuniste_Butor, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_opp <- glm(nombre_min ~ annee2 + mois, 
                         data = Opportuniste_Butor, 
                         family = poisson)

modele_annee_jour_butor_opp <- glm(nombre_min ~ annee2 + jour, 
                         data = Opportuniste_Butor, 
                         family = poisson)
modele_mois_jour_butor_opp <- glm(nombre_min ~ mois + jour, 
                        data = Opportuniste_Butor, 
                        family = poisson)
modele_annee_mois_jours_butor_opp <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Opportuniste_Butor, 
                               family = poisson)


summary(modele_annee_butor_opp)
summary(modele_mois_butor_opp)
summary(modele_annee_mois_butor_opp)
summary(modele_annee_jour_butor_opp)
summary(modele_mois_jour_butor_opp)
summary(modele_annee_mois_jours_butor_opp)
summary(modele_jour_butor_opp)
```

#### Comparaison modèles butor donnees opportunistes 

```{r}
AIC(modele_annee_butor_opp, modele_mois_butor_opp, modele_annee_mois_butor_opp, modele_jour_butor_opp, 
    modele_annee_mois_jours_butor_opp, modele_mois_jour_butor_opp, modele_annee_jour_butor_opp)
```

##### qualité similaire entre les modeles annee mois et jour parce que bon il y a que 30 obs opportunistes jpp. 

#### Graphique modele temporele butor données opportunistes 

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$annee2)
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
boxplot(Butor_etoile$nombre_min~Butor_etoile$jour )
```


# GLM poisson variable météo ? 

## preparer les donnees 
```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

env_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/environnement_daily.csv")
```

### 
