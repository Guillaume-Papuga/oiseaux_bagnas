---
title: "DEKERLE_Oiseaux"
format: html
editor: visual
---


```{r}
#| message: false
#| warning: false

#| label: Packages necessaire
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
```

::: {.callout-warning style="border-left: 5px solid red; background-color: #fdd; padding: 1em;"}
## Attention

Pour les analyses à venir, vous devez utiliser le **nouveau jeu de données** créé après vérification qu'il est **complet et nettoyé** (voir les sections suivantes).

Il est important de commencer toutes les nouvelles analyses avec ce jeu de données afin que **tout le monde travaille sur la même base**. Le jeu de donnée se trouve dans le git commun dans le dossier data pro

Si vous avez besoin de **sous-jeux de données**, par exemple uniquement le **Butor étoilé** ou uniquement les données **opportunistes**, rendez-vous dans la **section 4** pour les récupérer, afin de **préserver la typologie correcte du jeu de données**.
:::

# 1. Jeux de données nécessaires ( par especes, par protocole....)

```{r}
#| label: DATA A UTILISER
#| echo: true
#| message: false
#| warning: false
 process_data <- read_csv("data/pro/process_data.csv")
process_protocole <- read_csv("data/pro/process_protocole.csv")
```

```{r}
## 4.1 Par especes
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

Blongios_nain<-process_data %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

```

## 1.2 Par protocole

```{r}
#| label: data par protocole
suivi<-process_protocole %>%
  filter(
  champs_additionnels%in% c(
    "{'RELV_NOM': 'SuiviBlongiostaleve'}",
    "{'RELV_NOM': 'SuiviButor'}"
  )
)

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Protocole_SuiviButor <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Blongios<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Blongios nain, Butor blongios"
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

```

## 2.2 effort d'observation journalier

### FACULTATIF ET PAS A JOUR  Effort journalier toutes espèces tout protocole

```{r}

process_data <- process_data %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nen conservant les heures inconnues (0), tout protocole confondu")

```

### FACULTATIF ET PAS A JOUR Données d'heure sans les 00:00:00 et les absence d'heure tout espece tout protocole

```{r}
process_data <-process_data %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00") 

### Extraire l'heure

process_data <- process_data %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
process_data$heure_debut_tronc = as.factor(process_data$heure_debut_tronc)
### Sommer les obs par heure

obs_heure <- process_data %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure



### Frequence horaire

freq_heure <- process_data %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot


ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations par heure \nsans les heures inconnues, tout protocole confondu")
```

### FACULTATIF ET PAS A JOUR Effort journalier Butor tout protocole

```{r}
Butor_etoile <- Butor_etoile %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")
### Extraire l'heure

Butor_etoile <- Butor_etoile %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Butor_etoile$heure_debut_tronc = as.factor(Butor_etoile$heure_debut_tronc)

### Sommer les obs par heure


obs_heure <- Butor_etoile %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure


### Frequence horaire


freq_heure <- Butor_etoile %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))


### Barplot

ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Butor étoilé) par heure \nsans les heures inconnues, tout protocole confondu")

```

### FACULTATIF ET PAS A JOUR Effort journalier Blongios tout protocole

```{r}
Blongios_nain <- Blongios_nain  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Blongios_nain <- Blongios_nain %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Blongios_nain$heure_debut_tronc = as.factor(Blongios_nain$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Blongios_nain %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Blongios_nain %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Blongios nain) par heure \nsans les heures inconnues, tout protocole confondu")
```

### FACULTATIF ET PAS A JOUR Effort journalier Taleve tout protocole

```{r}
Taleve_sultane <- Taleve_sultane  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Taleve_sultane <- Taleve_sultane %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Taleve_sultane$heure_debut_tronc = as.factor(Taleve_sultane$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Taleve_sultane %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Taleve_sultane %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations (Talève sultane) par heure \nsans les heures inconnues, tout protocole confondu")
```

### 2.2.a Effort journalier protocole Butor

```{r}

# DOnnées 
Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_SuiviButor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot


ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Butor (2014-2018)")

```

### 2.2.b Effort journalier opportuniste Butor

```{r}
# DOnnées 
Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Butor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Butor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations \n opportuniste par heure pour le Butor (1997-2023), \nsans les heures inconnues ")

```

### 2.2.c Effort journalier protocole Blongios

```{r}
# DOnnées 
Protocole_Blongios <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Blongios <- Protocole_Blongios %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Protocole_Blongios <- Protocole_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Blongios (2014-2018)")

```

### 2.2.d Effort journalier opportuniste Blongios

```{r}

# Données 
Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Blongios <- Opportuniste_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour le Blongios (2014-2018)")

```


### 2.2.e Effort journalier protocole Talève

```{r}
# DOnnées 
Protocole_Taleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Taleve <- Protocole_Taleve %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_Taleve <- Protocole_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Talève (2014-2018)")

```

### 2.2.f Effort journalier opportuniste Talève

```{r}

# Données 
Opportuniste_Taleve <- Opportuniste_Taleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Taleve <- Opportuniste_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour la Talève (2014-2018)")

```

### FACULTATIF ET PAS A JOUR Effort journalier protocole Blongios-Talève

```{r}
Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")


### Extraire l'heure

Protocole_SuiviBlongiosTaleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut_tronc = hour(heure_debut),   # heure de la journée (0-23)
    date = as.Date(heure_debut)
  )
Protocole_SuiviBlongiosTaleve$heure_debut_tronc = as.factor(Protocole_SuiviBlongiosTaleve$heure_debut_tronc)

### Sommer les obs par heure

obs_heure <- Protocole_SuiviBlongiosTaleve %>%
      group_by(heure_debut_tronc) %>%
      summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire

freq_heure <- Protocole_SuiviBlongiosTaleve %>%
  group_by(heure_debut_tronc) %>%
  summarise(freq = n()) %>%
  mutate(freq_rel = freq / sum(freq))
### Barplot
ggplot(mapping = aes(x, y)) +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = freq_heure$freq), width = 0.8, stat = 'identity', fill = 'orange') +
  geom_bar(data = data.frame(x = freq_heure$heure_debut_tronc, y = obs_heure$`sum(nombre_min)`), width = 0.4, stat = 'identity', fill = 'blue') +
  theme_classic() + scale_y_continuous(expand = c(0, 0)) + xlab("Heure de la journée tronquée à l'inférieur") + ylab ("Nombre de prospections (en orange) et d'observations (en bleu)" ) +
ggtitle("Effort d'échantillonnage et nombre d'observations protocolées \n(Blongios et Talève) par heure sans les heures inconnues")
```

::: {.callout-note style="green"}
## Interpretation

Beaucoup d'obs pour lesquelles l'heure est inconnue.

#Données d'heure sans les 00:00:00 (les 00 sont encore la ?) et les absence d'heure
:::

::: {.callout-note style="green"}
## Interpretation

Tout confondu : max au crépuscule (20h) et avant le levé du soleil (4-5h)

\- butor : max au crépuscule (20h-22h) et au levé du soleil (4-6h)

-   blongios : de 21h-23h et 5h à 9h

-   Taleve : de 5h à 9h avec GROS PIC à 8h puis de 20 à 21.

-   protocole blongios taleve = obs a 6h et 7h et 20h et 21h.

    =\> globalement tout correspond aux protocoles mis en place SAUF

-   protocole butor: UNE SEULE OBS PROTOCOLEE DONT ON CONNAIS L'HEURE et elle date de 1998 (j'ai verif les données brutes et effectivement c'est le cas)
:::

# GLMM observation du butor en fonction du temps

## charger les packages

```{r}
library(dplyr)
library(lubridate)
library(MASS)
library(lme4)
library(stats)
```

## charger les données

```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

### Obs Butor tout protocoles
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

### Données butor protocolées  
Protocole_SuiviButor <- process_data %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

###Données butor opportuniste 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

```

## Préparer les variables temporelles

### Obs Butor tout protocoles

```{r}
Butor_etoile$date_debut <- as.Date(Butor_etoile$date_debut)

Butor_etoile <- Butor_etoile %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )
Butor_etoile <- Butor_etoile%>%
  filter(annee >= 2014)
Butor_etoile$annee2 <- as.numeric(as.character(Butor_etoile$annee)) - 2013

# Transformer en facteurs
Butor_etoile$annee <- as.numeric(Butor_etoile$annee)
Butor_etoile$mois  <- as.numeric(Butor_etoile$mois)
Butor_etoile$jour <- as.numeric(Butor_etoile$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

### Données butor protocolées

```{r}
Protocole_SuiviButor$date_debut <- as.Date(Protocole_SuiviButor$date_debut)

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor%>%
  filter(annee >= 2014)
Protocole_SuiviButor$annee2 <- as.numeric(as.character(Protocole_SuiviButor$annee)) - 2013

# Transformer en facteurs
Protocole_SuiviButor$annee <- as.numeric(Protocole_SuiviButor$annee)
Protocole_SuiviButor$mois  <- as.numeric(Protocole_SuiviButor$mois)
Protocole_SuiviButor$jour <- as.numeric(Protocole_SuiviButor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

### Données butor opportuniste

```{r}
Opportuniste_Butor$date_debut <- as.Date(Opportuniste_Butor$date_debut)

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    annee = year(date_debut),
    mois  = month(date_debut),
    jour  = day(date_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor%>%
  filter(annee >= 2014)
Opportuniste_Butor$annee2 <- as.numeric(as.character(Opportuniste_Butor$annee)) - 2013

# Transformer en facteurs
Opportuniste_Butor$annee <- as.numeric(Opportuniste_Butor$annee)
Opportuniste_Butor$mois  <- as.numeric(Opportuniste_Butor$mois)
Opportuniste_Butor$jour <- as.numeric(Opportuniste_Butor$jour)
# Ne pas mettre jour comme facteur si beaucoup de lignes pour éviter le crash
```

## GLM Poisson + comparaison de modèles

### GLM Obs Butor tout protocoles

```{r}
# Modèle par année

modele_annee_butor_all <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Butor_etoile)
summary(modele_annee_butor_all)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_all <- glm(nombre_min ~ mois, 
                   data = Butor_etoile, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_all <- glm(nombre_min ~ jour, 
                   data = Butor_etoile, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_all <- glm(nombre_min ~ annee2 + mois, 
                         data = Butor_etoile, 
                         family = poisson)

modele_annee_jour_butor_all <- glm(nombre_min ~ annee2 + jour, 
                         data = Butor_etoile, 
                         family = poisson)
modele_mois_jour_butor_all <- glm(nombre_min ~ mois + jour, 
                        data = Butor_etoile, 
                        family = poisson)
modele_annee_mois_jours_butor_all <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Butor_etoile, 
                               family = poisson)


summary(modele_annee_butor_all)
summary(modele_mois_butor_all)
summary(modele_annee_mois_butor_all)
summary(modele_annee_jour_butor_all)
summary(modele_mois_jour_butor_all)
summary(modele_annee_mois_jours_butor_all)
summary(modele_jour_butor_all)
```

#### Comparaison modèle butor tout protocole

```{r}
AIC(modele_annee_butor_all, modele_mois_butor_all, modele_annee_mois_butor_all, modele_jour_butor_all, 
    modele_annee_mois_jours_butor_all, modele_mois_jour_butor_all, modele_annee_jour_butor_all)
```

##### AIC similaire entre modele_annee_mois_butor_all (AIC la plus petite) et modele_mois_butor_all (le moins de paramètre) donc par parcimonie modele_mois_butor_all est le meilleur.

#### Graphique modele temporelle butor tout protocole

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
```

### modele temporel Données butor protocolées IL Y A PAS D'OBSERVATIONS MDRRRRRRRRRRRR DONC LE SCRIPT EST FAIT MAIS LES MODELES SERVENT A RIEN

```{r}
# Modèle par année

modele_annee_butor_prot <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviButor)
summary(modele_annee_butor_prot)

# 4b. Modèle par mois (4 niveaux seulement)
modele_mois_butor_prot <- glm(nombre_min ~ mois, 
                   data = Protocole_SuiviButor, 
                   family = poisson)
# 4b. Modèle par jour (4 niveaux seulement)
modele_jour_butor_prot <- glm(nombre_min ~ jour, 
                   data = Protocole_SuiviButor, 
                   family = poisson)

# 4c. Modèle combiné année + mois
modele_annee_mois_butor_prot <- glm(nombre_min ~ annee2 + mois, 
                         data = Protocole_SuiviButor, 
                         family = poisson)

modele_annee_jour_butor_prot <- glm(nombre_min ~ annee2 + jour, 
                         data = Protocole_SuiviButor, 
                         family = poisson)
modele_mois_jour_butor_prot <- glm(nombre_min ~ mois + jour, 
                        data = Protocole_SuiviButor, 
                        family = poisson)
modele_annee_mois_jours_butor_prot <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Protocole_SuiviButor, 
                               family = poisson)


summary(modele_annee_butor_prot)
summary(modele_mois_butor_prot)
summary(modele_annee_mois_butor_prot)
summary(modele_annee_jour_butor_prot)
summary(modele_mois_jour_butor_prot)
summary(modele_annee_mois_jours_butor_prot)
summary(modele_jour_butor_prot)
```

#### Comparaison modèles butor données protocolées

```{r}
AIC(modele_annee_butor_prot, modele_mois_butor_prot, modele_annee_mois_butor_prot, modele_jour_butor_prot, 
    modele_annee_mois_jours_butor_prot, modele_mois_jour_butor_prot, modele_annee_jour_butor_prot)
```

#### Graphique modele temporel butor données protocolées

### Modèle temporel données butor opportuniste

```{r}
# Modèle par année

modele_annee_butor_opp <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Opportuniste_Butor)
summary(modele_annee_butor_opp)

# Modèle par mois (4 niveaux seulement)
modele_mois_butor_opp <- glm(nombre_min ~ mois, 
                   data = Opportuniste_Butor, 
                   family = poisson)
# Modèle par jour (4 niveaux seulement)
modele_jour_butor_opp <- glm(nombre_min ~ jour, 
                   data = Opportuniste_Butor, 
                   family = poisson)

# Modèle combiné année + mois
modele_annee_mois_butor_opp <- glm(nombre_min ~ annee2 + mois, 
                         data = Opportuniste_Butor, 
                         family = poisson)

modele_annee_jour_butor_opp <- glm(nombre_min ~ annee2 + jour, 
                         data = Opportuniste_Butor, 
                         family = poisson)
modele_mois_jour_butor_opp <- glm(nombre_min ~ mois + jour, 
                        data = Opportuniste_Butor, 
                        family = poisson)
modele_annee_mois_jours_butor_opp <- glm(nombre_min ~ annee2 + mois+jour, 
                               data = Opportuniste_Butor, 
                               family = poisson)


summary(modele_annee_butor_opp)
summary(modele_mois_butor_opp)
summary(modele_annee_mois_butor_opp)
summary(modele_annee_jour_butor_opp)
summary(modele_mois_jour_butor_opp)
summary(modele_annee_mois_jours_butor_opp)
summary(modele_jour_butor_opp)
```

#### Comparaison modèles butor donnees opportunistes

```{r}
AIC(modele_annee_butor_opp, modele_mois_butor_opp, modele_annee_mois_butor_opp, modele_jour_butor_opp, 
    modele_annee_mois_jours_butor_opp, modele_mois_jour_butor_opp, modele_annee_jour_butor_opp)
```

##### qualité similaire entre les modeles annee mois et jour parce que bon il y a que 30 obs opportunistes jpp.

#### Graphique modele temporele butor données opportunistes

```{r}
boxplot(Butor_etoile$nombre_min~Butor_etoile$annee2)
boxplot(Butor_etoile$nombre_min~Butor_etoile$mois )
boxplot(Butor_etoile$nombre_min~Butor_etoile$jour )
```

# GLM poisson variable météo ?

## preparer les donnees

```{r}
process_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

env_data <- readr::read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/environnement_daily.csv")
```

### 

\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\-\--

a mettre au propre en mettant que protocolé vs opportuniste

```{r}
process_data <- process_data %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

### Sommer les obs par heure

obs_heure <- process_data %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- process_data %>% 
  group_by(heure_debut_tronc, champs_additionnels) %>% 
  summarise(freq = n(), .groups = "drop")

### Barplot

ggplot() +
  geom_bar(
    data = freq_heure,
    aes(x = heure_debut_tronc, y = freq, fill = champs_additionnels),
    width = 0.8,
    stat = "identity",
    position = "stack"   # ou "dodge" si tu préfères côte à côte
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée (tronquée à l'inférieur)") +
  ylab("Nombre de prospections") +
  labs(fill = "Facteur") +
  ggtitle(
    "Effort d'échantillonnage en fonction des suivis (heures inconnues conservées)"
  )

```
