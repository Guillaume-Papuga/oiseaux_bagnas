---
title: "COMPTE RENDU D'ANALYSE DES DONNÉES D'OBSERVATION DE BUTOR ÉTOILÉ (*Botaurus stellaris*) À LA RÉSERVE DU BAGNAS"
format: html
editor: visual
echo: false
---

```{css, echo = FALSE}
.justify {
  text-align: justify !important
}
```

## Introduction

::: justify
Le butor étoilé (*Botaurus stellaris*) est un oiseau emblématique des zones humides et est classé "Vulnérable" sur la liste rouge des oiseaux nicheurs de France métropolitaine. Pour répondre au déclin des populations et à la dégradation des habitats, un Plan national d'action (PNA) a été mis en place, s'étendant de 2025 à 2034. Animé notamment sur tout le pourtour méditerranéen, l'une des actions de ce PNA consiste à "se doter d'outils pour suivre l'évolution des effectifs et auditer les sites accueillant l'espèce". En ce sens, la réserve du Bagnas a émis le désir de disposer d'une analyse de ses données d'observation de butor, récoltées entre 1990 et 2025. 
Le but est dans un premier temps de comparer les données opportunistes et celles issues des protocoles de points d'écoutes (destinées à détecter des mâles chanteurs), afin d'évaluer l'efficacité et la pertinence des suivis. Dans un second temps, déterminer la structure spatio-temporelle de la présence du butor étoilé dans la réserve. Nous nous sommes aussi posé la question de la structure de l'effort de prospection tout au long du suivi, à l'échelle annuelle et journalière ainsi que la structure de la détection du butor au sein des prospections.
:::

```{r setup}


knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#ce code permet de n'afficher aucun code, message parasite ou d'erreur. 
```

```{r}

# Charger les données et les librairies

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(slider)

setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro") # modifier le chemin en fonction de l'ordinateur utilisé 
process_data <- read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv") # charger le jeu de données nettoyé 
```

## 1 - Graphique de présence des butors par semaine depuis 1990

::: justify
Le graphique suivant représente pour chaque année (en ligne), au cours de quelle semaine (en colonne) le butor a été observé et s'il s'agit d'observations opportunistes ou protocolées. Le graphique indique aussi les sorties protocolées où le butor n'a pas été observé. La ligne pointillée bleue correspond à 2014, début du protocole de point d'écoute du butor. Celui-ci se déroule du 10 avril au 16 mai, période favorable pour la détection de mâles chanteurs.
:::

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 


esp_butor<- "Butor étoilé"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_butor <- process_data %>%
  filter(nom_vernaculaire == esp_butor) %>% #on filtre pour avoir uniquement les lignes du butor dans le data frame
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1, #ajoute une colonne pour l'annér de suivi
    annee_reelle = year(date_debut), #ajoute une colonne pour l'année "réelle"
    semaine = isoweek(date_debut) # on crée les numéros des semaines
  )

# --- Résumer les semaines pour gérer les sorties multiples ---
data_butor_summarized <- data_butor %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviButor", champs_additionnels) & annee_reelle >= 2014 #on définit ce qu'est une observation protocolée, certaines observations sont notées comme protocolées alors qu'elles ont lieu avant la mise en place du protocole, on les enlève en filtrant à partir de 2014. 
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs)   ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs)  ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs)  ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole

      # sorties protocolées sans observation = aucun oiseau vu
      any(is_protocole) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )
# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_butor_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2, , show.legend = TRUE) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85",
      show.legend = TRUE #force l'affichage des couleurs dans la légende même si les catégories n'existent pas 
    ), 
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie protocolée sans observation",
      "Pas de sortie"
    ),
    drop = FALSE #force l'affichage de la légende même si les catégories sont absentes 
  ) +
  labs(
    title = paste("Observations de", esp_butor),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

::: justify
On remarque que la plupart des observations de butor sont réalisées de manière opportuniste en début et fin d'année. A contrario, on observe une "zone blanche" en milieu d'année (de fin mars à octobre) où les observations sont quasiment nulles. Le protocole se situe dans cette zone blanche. En effet, aucun butor n'a été contacté lors du protocole d'écoute depuis 2014. En conclusion, il n'y a très probablement pas de mâle chanteur en réserve du Bagnas. Les observations opportunistes correspondent sûrement à des individus hivernants.
:::

## 2 - Cartographie de la présence des butors sur les sites d'écoute du protocole

::: justify
Cette carte donne la localisation des points d'écoute du protocole butors et le nombre de butors contactés (en cliquant sur les points). Les points noirs représentent les sites où aucun butor n'a été contacté.
:::

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/pro/process_protocole.csv")

process_protocole_butor <- process_protocole %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_protocole_butor <- st_as_sf(process_protocole_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de butor par site (somme depuis 2014)
sites_protocole_butor <- sites_protocole_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     

  addCircleMarkers(
    data =sites_protocole_butor[sites_protocole_butor$somme_nombre_min >= 1,], #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butors contactés : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13) %>% 
  
  addCircleMarkers(
    data =sites_protocole_butor[sites_protocole_butor$somme_nombre_min == 0,], #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "black",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butors contactés : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)



```

::: justify
Comme mentionné plus haut, aucun butor n'a été contacté lors du protocole commencé en 2014. A la toute fin du script se trouve la même carte en prenant en compte les observations opportunistes depuis 1990.
:::

## 3 - Effort journalier du protocole Butor

::: justify
Ce graphique représente l'effort d'échantillonnage ainsi que le nombre d'obervations cumulés au cours du protocole butor pour chaque heure de la journée de 2014 à 2025. L'effort d'échantillonnage est représenté par la somme des entrées (lignes) dans le jeu de données.
:::

```{r}

# mettre les dates au bon format 
process_protocole_butor_h <- process_protocole_butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  ) 

# enlever les heures inconnues 
process_protocole_butor_h <- process_protocole_butor_h  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

#on créé une table avec les 24h pour les fixer sur le graphique et avoir toutes les heures sur l'axe des abscisses.
heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les observation par heure
obs_heure <- process_protocole_butor_h %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 

### Frequence horaire
freq_heure <- process_protocole_butor_h %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre d'entrées dans le jeu de données (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole butor (2014-2025)")
```

::: justify

On observe que les sorties se concentrent avant le levé du soleil et au crépuscule, heures favorables à l'écoute du butor. L'effort d'échantillonnage représente plus de 250 points d'écoute sur 11 ans, mais n'a pas permis de contacter d'individu chanteur. 

:::



## 4 - Cumule des observations de butor

::: justify
Face à l'absence de données protocolées, nous n'avons pas pu effectuer de modélisation de la structure de la population de butor. Nous avons cependant représenté graphiquement la distribution du nombre de butors contactés pour obtenir la structure inter-annuelle, intra-annuelle et spatiale.
:::

#### a - Cumule par année

::: justify
Ce graphique représente le cumul de toutes les observations de butor entre 1990 et 2025 structurées par année (uniquement des observations opportunistes). Ce graphique permet d'avoir une idée de la structure inter-annuelle des observations.
:::

```{r}

#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
data_butor$annee = year(floor_date(data_butor$date_debut, "year"))

# on crée un dataset résumé avec les années et la sommes des observations 
obs_annee <- data_butor %>%
  group_by(annee) %>%
  summarize(sum(nombre_min))

### Barplot

ggplot(obs_annee, aes(x = annee)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Année") +
  ylab("Nombre d'observations opportuniste cumulées") +
  ggtitle("Nombre de butors observés chaque année entre 1990 et 2025")

```

::: justify
La majorité des observations opportunistes ont eu lieu autour des années 1998 et 2015 sans suivre de structures particulières. Très peu de butors ont été observés ces 10 dernières années. 
:::

#### b - Cumul par semaine

::: justify
Ce graphique représente le cumul de toutes les observations de butor entre 1990 et 2025 structurées par semaine de l'année (uniquement des observations opportunistes). Ce graphique permet d'avoir une idée de la structure intra-annuelle des observations.
:::

```{r}
#on crée un dataset résumé par semaine en sommant les observations. On crée une catégorie pour la saison correspondante. 
obs_semaine <- data_butor %>%
  group_by(semaine) %>%
  summarize(sum(nombre_min, na.rm = TRUE)) %>%
  mutate(
    saison = case_when(
      semaine %in% c(0:12, 52:53) ~ "Hiver",
      semaine %in% 13:25          ~ "Printemps",
      semaine %in% 26:38          ~ "Été",
      semaine %in% 39:51          ~ "Automne"
    )
  )

### Barplot

ggplot(obs_semaine, aes(x = semaine)) +
  geom_rect(
    aes(xmin = 15, xmax = 21, ymin = -Inf, ymax = Inf,
        fill = "Période du protocole"),
    inherit.aes = FALSE
  ) +
  geom_bar(
    aes(y = `sum(nombre_min, na.rm = TRUE)`, fill = saison),
    stat = "identity",
    width = 0.4
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(
    values = c(
      "Hiver" = "steelblue",
      "Printemps" = "forestgreen",
      "Été" = "gold",
      "Automne" = "darkorange",
      "Période du protocole" = "grey70"
    )
  ) +
  xlab("Semaine") +
  ylab("Nombre d'observations opportunistes cumulées") +
  ggtitle("Nombre de butors observés chaque semaine de l'année entre 1990 et 2025") +
  labs(fill = "")

```

::: justify
La majorité des observations opportunistes ont eu lieu aux périodes d'hivernage, en dehors de la période du protocole.
:::


#### c - Cumul journalier

::: justify

Ce graphique représente le nombre cumulé d'observations de butors à la réserve du Bagnas (uniquement des observations opportunistes) pour chaque heure de la journée entre 1997 et 2025. Les observations pour lesquelles l'heure n'était pas disponible ont été enlevées, expliquant l'intervalle temporel réduit.

:::

```{r}
# on met les heures au bon format 
data_butor_h <- data_butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  ) 

#on enlève les obs où l'heure n'est pas disponible 
data_butor_h <- data_butor_h  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00") 

#on créé une table avec les 24h pour les fixer sur le graphique et avoir toutes les heures sur l'axe des abscisses.
heures_jour <- tibble(heure_debut_tronc = 0:23)  

### Sommer les obs par heure
obs_heure <- data_butor_h %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
    left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot
ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
    geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de d'observations opportunistes cumulées") +
  ggtitle("Nombre d'observations opportunistes par heure \npour le butor (1997-2025), sans les heures inconnues ")

```
::: justify

Les observations opportunistes sont plus éparpillées au cours de la journée, correspondant aux heures de terrains d'autres protocoles au sein de la réserve.

:::

#### d - Cumul pour chaque site (y compris hors protocole)

::: justify
Ce graphique représente le cumul de toutes les observations de butor entre 1990 et 2025, structurées en fonction du lieu d'observation. Ce graphique permet d'avoir une idée de la structure spatiale des observations. Les points noirs représentent les sites où aucun butor n'a été contacté. Les cercles rouges ont un rayon proportionnel au nombre de butors contactés. Cliquer sur le cercle permet de voir le nombre exacte. 
:::

```{r}
# enlever le site GB => vieilles données opportunistes rattachées à rien. 
sites_butor = data_butor[data_butor$nom_lieu != "GB",]


#préparer les coordonnées pour R 
sites_butor <- st_as_sf(sites_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326, na.fail = FALSE) #na.fail permet de ne pas prendre en compte les NA incorporés sans raison par ligne du dessus

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de butor par site (somme depuis 1990)
sites_butor <- sites_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     
  
  addCircleMarkers(
    data = sites_butor[sites_butor$somme_nombre_min >= 1,], #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min/6, #la taille des points est proportionnelle au nombre d'oiseaux entendus, on ajouter un facteur pour diminuer la taille des cercles
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor contactés : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.32, zoom = 14) %>% 
  
  addCircleMarkers(
    data = sites_butor[sites_butor$somme_nombre_min == 0,], #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus, la taille est minimale pour 0 mais le point s'affiche tout de même 
    color = "black",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butors contactés : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.32, zoom = 14)
  
```

::: justify
La majorité des observations opportunistes ont eu lieu dans les sites intitulés "GB". Principalement GB1, GB5, GB2, GB. En raison de la taille restreinte de la réserve et de la proximité de certains de ces lieux avec les sites protocolés, il est possible que la structure soit davantage liée à la fréquence de visite des sites "GB" plutôt qu'aux caractéristiques du milieu.
:::

## Discussion et recommandations

::: justify
Les analyses ont montré qu'il n'y avait sûrement pas de butor chanteur en réserve du Bagnas. Cependant, la réserve semble être une zone d'hivernage favorable pour cette espèce. Nous recommandons d'arrêter le protocole de point d'écoute en période de reproduction. En fonction de la faisabilité (le butor étant une espèce cryptique) il pourrait être remplacé par un comptage en période d'hivernage pour essayer de déterminer la structure des populations hivernantes de manière plus rigoureuse. En cas d'impossibilité ou de manque de robustesse du changement du protocole, les observations opportunistes peuvent continuer à être renseignées afin de continuer à disposer des périodes de présence du butor sur la réserve.
:::












---
title: "Butor_clean"
format: html
editor: visual
---

```{css, echo = FALSE}
.justify {
  text-align: justify !important
}
```

# COMPTE RENDU D'ANALYSE DES DONNÉES D'OBSERVATION DE BUTOR ÉTOILÉ (*Botaurus stellaris*) À LA RÉSERVE DU BAGNAS

## Introduction

::: justify
Le butor étoilé (*Botaurus stellaris*) est un oiseau emblématique des zones humides et est classé "Vulnérable" sur la liste rouge des oiseaux nicheurs de France métropolitaine. Pour répondre au déclin des populations et à la dégradation des habitats, un Plan national d'action (PNA) a été mis en place, s'étendant de 2025 à 2034. Animé notamment sur tout le pourtour méditerranéen, l'une des actions de ce PNA consiste à "se doter d'outils pour suivre l'évolution des effectifs et auditer les sites accueillant l'espèce". En ce sens, la réserve du Bagnas a émis le désir de disposer d'une analyse de ses données d'observation de Butor, récoltées entre 1990 et 2025. Le but est dans un premier temps de comparer les données opportunistes et celles issues des protocoles de points d'écoutes (destinées à détecter des mâles chanteurs), afin d'évaluer l'efficacité et la pertinence des suivis. Dans un second temps, déterminer la structure spatio-temporelle de la présence du butor étoilé dans la réserve. Nous nous sommes ainsi posé la question de la structure de l'effort de prospection tout au long du suivi, à l'échelle annuelle et journalière ainsi que la structure de la détection du butor au sein des prospections.
:::

```{r setup}


knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
#ce code permet de n'afficher aucun code, message parasite ou d'erreur. 
```

## Charger les données et les librairies

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(slider)

setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro")
process_data <- read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")
```

## 1 - Graphique de présence des Butors par semaine depuis 1990

::: justify
Le graphique suivant représente pour chaque année (en ligne), au court de quelle semaine (en colonne) le butor a été observé et s'il s'agit d'observations opportunistes ou protocolées. Le graphique indique aussi les sorties protocolées où le butor n'a pas été observé. La ligne pointillée bleue correspond à 2014, début du protocole de point d'écoute du butor. Celui-ci se déroule du 10 avril au 16 mai, période favorable pour la détection de mâles chanteurs.
:::

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 


esp_butor<- "Butor étoilé"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_butor <- process_data %>%
  filter(nom_vernaculaire == esp_butor) %>% #on filtre pour avoir uniquement les lignes du Butor dans le data frame
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1, 
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut) # on crée les numéros des semaines
  )

# --- Résumer les semaines pour gérer les sorties multiples ---
data_butor_summarized <- data_butor %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviButor", champs_additionnels) #on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole

      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )
# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_butor_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de", esp_butor),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

::: justify
On remarque que la plupart des observations de butor sont réalisées de manière opportuniste en début et fin d'année. A contrario, on observe une "zone blanche" en milieu d'année où les observations sont quasiment nulles. Le protocole se situe dans cette zone blanche. En effet, aucun butor n'a été observé lors du protocole d'écoute depuis 2014. Les prospections classifiées comme protocolées avant 2014 ont probablement été effectuées dans le cadre d'autres suivies ou peuvent résulter d'erreurs de saisies. En conclusion, il n'y a très probablement pas de mâle chanteur en réserve du Bagnas. Les observations opportunistes correspondent sûrement à des individus hivernants.
:::

## 2 - Cartographie de la présence des Butors sur les sites d'écoute du protocole

::: justify
Cette carte donne la localisation des points d'écoute du protocole butors et le nombre de butor contactés (en cliquant sur les points).
:::

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/pro/process_protocole.csv")

process_protocole_butor <- process_protocole %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_protocole_butor <- st_as_sf(process_protocole_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_protocole_butor <- sites_protocole_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     

  addCircleMarkers(
    data =sites_protocole_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```

::: justify
Comme mentionné plus haut, aucun butor n'a été contacté lors du protocole commencé en 2014. A la toute fin du script se trouve la même carte en prenant en compte les observations opportunistes depuis 1990.
:::

## 3 - Effort journalier du protocole Butor

::: justify
Ce graphique représente l'effort d'échantillonnage ainsi que le nombre d'obervations cumulés au cours du protocole butor pour chaque heure de la journée de 2014 à 2025. L'effort d'échantillonnage est représenté par la somme des sorties effectuées.
:::

```{r}
# Données protocolées du Butor
process_protocole <- read_csv("data/pro/process_protocole.csv")



Protocole_SuiviButor <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Création d'une table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les observation par heure

obs_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 

### Frequence horaire
freq_heure <- Protocole_SuiviButor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Butor (2014-2025)")
```

::: justify
Ce graphique représente l' "effort d'échantillonnage" ainsi que le nombre d'obervations opportunistes de butor cumulées pour chaque heure de la journée de 1990 et 2025. L'effort d'échantillonnage est représenté par la somme des observations opportuniste.
:::

## 4 - Effort journalier des données opportunistes

::: justify
Ce graphique représente le nombre cumulé d'observations opportunistes ainsi que le nombre cumulé de butors observé de cette manière pour chaque heure de la journée entre 1997 et 2023. Les observations pour lesquelles l'heure n'était pas disponible ont été enlevées, expliquant l'intervalle temporel réduit.
:::

```{r}
# Données 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Butor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 

### Frequence horaire
freq_heure <- Opportuniste_Butor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations \n opportunistes par heure pour le Butor (1997-2023), \nsans les heures inconnues ")

```

::: justify
Les observations opportunistes sont plus éparpillées au cours de la journée, correspondant aux heures de terrains d'autres protocoles au sein de la réserve.
:::

## 5 - Cumule des observations de Butor

::: justify
Face à l'absence de données protocolées, nous n'avons pas pu effectuer de modélisation de la structure de la population de butor. Nous avons cependant représenté graphiquement la distribution du nombre de butors contactés pour obtenir la structure inter-annuelle, intra-annuelle et spatiale.
:::

#### a - Cumule par année

::: justify
Ce graphique représente le cumul de toutes les observations de butor entre 1990 et 2025 structurées par année. Ce graphique permet d'avoir une idée de la structure inter-annuelle des observations.
:::

```{r}

#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
data_butor$annee = year(floor_date(data_butor$date_debut, "year"))

obs_annee <- data_butor %>%
  group_by(annee) %>%
  summarize(sum(nombre_min))

### Barplot

ggplot(obs_annee, aes(x = annee)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Année") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque année entre 1990 et 2025")

```

::: justify
La majorité des observations opportunistes ont eu lieu autour des années 1998 et 2015 sans suivre de structures particulières. A partir de 2014, en raison du protocole, les observations opportunistes ont peut-être arrêté d'être renseignées systématiquement, expliquant la baisse.
:::

#### b - Cumul par semaine

::: justify
Ce graphique représente le cumule de toutes les observations de butor entre 1990 et 2025 structurées par semaine de l'année. Ce graphique permet d'avoir une idée de la structure intra-annuelle des observations.
:::

```{r}
obs_semaine <- data_butor %>%
  group_by(semaine) %>%
  summarize(sum(nombre_min, na.rm = TRUE)) %>%
  mutate(
    saison = case_when(
      semaine %in% c(0:12, 52:53) ~ "Hiver",
      semaine %in% 13:25          ~ "Printemps",
      semaine %in% 26:38          ~ "Été",
      semaine %in% 39:51          ~ "Automne"
    )
  )

### Barplot

ggplot(obs_semaine, aes(x = semaine)) +
  geom_rect(
    aes(xmin = 15, xmax = 21, ymin = -Inf, ymax = Inf,
        fill = "Période du protocole"),
    inherit.aes = FALSE
  ) +
  geom_bar(
    aes(y = `sum(nombre_min, na.rm = TRUE)`, fill = saison),
    stat = "identity",
    width = 0.4
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(
    values = c(
      "Hiver" = "steelblue",
      "Printemps" = "forestgreen",
      "Été" = "gold",
      "Automne" = "darkorange",
      "Période du protocole" = "grey70"
    )
  ) +
  xlab("Semaine") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque semaine de l'année entre 1990 et 2025") +
  labs(fill = "")

```

::: justify
La majorité des observations opportunistes ont eu lieu aux périodes d'hivernage, en dehors de la période du protocole.
:::

#### c - Cumul par année pour chaque site (y compris hors protocole)

::: justify
Ce graphique représente le cumul de toutes les observations de butor entre 1990 et 2025 structurées en fonction du lieu d'observation. Ce graphique permet d'avoir une idée de la structure spatiale des observations.
:::

```{r}

#préparer les coordonnées pour R 
sites_butor <- st_as_sf(data_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_butor <- sites_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     
  
  addCircleMarkers(
    data =sites_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```

::: justify
La majorité des observations opportunistes ont eu lieu dans les sites intitulés "GB". Principalement GB1, GB5, GB2, GB. En raison de la taille restreinte de la réserve et de la proximités de certains de ces lieux avec les sites protocolés, il est possible que la structure soit davantage liée à la fréquence de visite des sites "GB" plutôt qu'aux caractéristiques du milieu.
:::

## Discussion et recommandations

::: justify
Les analyses ont montré qu'il n'y avait sûrement pas de butor chanteur en réserve du bagnas. Cependant, la réserve semble être une zone d'hivernage favorable pour cette espèce. Nous recommandons d'arrêter le protocole de point d'écoute en période de reproduction. En fonction de la faisabilité (le butor étant une espèce cryptique) il pourrait être remplacé par un comptage en période d'hivernage pour essayer de déterminer la structure des populations hivernantes de manière plus rigoureuse. En cas d'impossibilité ou de manque de robustesse du changement du protocole, les observations opportunistes peuvent continuer à être renseignées afin de continuer à disposer des périodes de présence du butor sur la réserve.
:::

--------------------------------------------------------------------------------------


---
title: "Document introductif"
format: html
editor: visual
---

# A. Introduction

::: justify
La réserve du Bagnas est un espace naturel protégé situé entre Agde et Marseillan. Classée Réserve Naturelle Nationale depuis 1983, elle abrite une remarquable diversité de milieux : étangs, lagunes, roselières, prés salés, sansouïres et dunes. La réserve abrite une biodiversité d'une grande richesse. 

La réserve est d'importance majeure à l'échelle régionale, notamment comme site de nidification, comme pour la Talève sultane qui niche dans les roselières. et halte migratoire pour de nombreuses espèces d'oiseaux. On y observe une importante population de hérons, dont le Blongios nain, le Butor étoilé et le Héron pourpré.

Dans cette étude, nous nous concentrons sur le Blongios nain, le Butor étoilé et la Talève sultane. Ces trois espèces font l'objet d'un suivi protocolé depuis 2014, notre objectif ici est d'analyser les données des protocoles afin d'en retirer des informations utiles pour la réserve et le protocole.

Le projet se base sur des données d'observation fournies par la réserve du Bagnas. Les données hydrologiques sont également fournies par la réserve, les données météorologiques proviennent de InfoClimat.

Ce document comprend deux parties : la première est la préparation des données et la deuxième présente des figures générales sur les données.
:::

# B. Préparation des données

```{r setup}
#| include: false
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE, 
  echo = FALSE
)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```

```{r}
#1. Il faut charger les données et les library
#charger les library 
library(leaflet)
library(sf)
library(RColorBrewer) 
library(dplyr)
library(readr)
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(kableExtra)
library(slider)
```

# 1. Mise en forme du tableau de données

Nous partons avec des tableaux de données bruts.

Dans chaque tableau il y a 77 variables et toutes les données d'observations du Butor, Blongios et de la Talève de 1990 à 2025. Dans ces tableaux, de nombreuses variables ne nous seront pas utiles pour la suite, il faut donc trier les variables et créer un nouveau tableau qui ne comprend que les 13 variables d'intéret.

On crée un nouveau

```{r recup, message=FALSE, warning=FALSE}

## 1. Rassembler les deux tableaux de données

#a)  récupérer les tableaux de données brute.

#charger le chemin d'accès : à adapter à votre ordinateur 
setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas")

#charger les données brutes: 2 tableaux
raw_data<- read_excel("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/synthese_observations_2025-09-09T13_30_50.994Z.xlsx")

raw_data_2 <- read_delim(
  "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/synthese_observations_2025-11-24T07_38_00.302Z (2).csv",
  delim = ";",
  locale = locale(encoding = "Latin1", decimal_mark = ".")
)

```

```{r}
#Nous conservons uniquement les colonnes pertinentes pour la suite de l'analyse, en supprimant les colonnes vides ainsi que celles dont l'information est redondante, notamment les noms latins.

process_data_1= raw_data %>%
  select(id_synthese,date_debut,date_fin,heure_debut,heure_fin,
         nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326,
         y_centroid_4326,nom_lieu,champs_additionnels)

process_data_2 <- raw_data_2 %>%
  select(id_synthese, date_debut, date_fin, heure_debut, heure_fin,
         nom_vernaculaire, nombre_min, observateurs, determinateur,
         x_centroid_4326, y_centroid_4326,
         nom_lieu, champs_additionnels)

# On garde uniquement l'heure (HH:MM:SS) dans heure_debut / heure_fin
# car le fichier original contenait une date + une heure
process_data_1 <- process_data_1 %>%
  mutate(
    heure_debut = format(heure_debut, "%H:%M:%S"),
    heure_fin   = format(heure_fin,   "%H:%M:%S")
  )

# mettre en format date les dates de debut et de fin 

process_data_1 <- process_data_1 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )



process_data_2 <- process_data_2 %>%
  mutate( date_debut = as.Date(date_debut, format = "%d/%m/%Y"),
          date_fin = as.Date(date_fin, format = "%d/%m/%Y") )

#correction des formats de certaines colonnes
process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = as.character(x_centroid_4326),
    y_centroid_4326 = as.character(y_centroid_4326)
  )

process_data_1<- process_data_1 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )

process_data_2 <- process_data_2 %>%
  mutate(
    x_centroid_4326 = round(as.numeric(x_centroid_4326), 6),
    y_centroid_4326 = round(as.numeric(y_centroid_4326), 6)
  )
# Le fichier brut est en format "dd/mm/YYYY"
# On convertit proprement en Date (format standard YYYY-MM-DD)


process_data_2 <- process_data_2 %>%
  mutate(
    heure_debut = as.character(heure_debut),
    heure_fin   = as.character(heure_fin)
  )

# La ligne 132 de process_data_2 avait un NA
# On remplace par la valeur correspondante dans process_data_1 (ligne 720)
process_data_2$champs_additionnels[ process_data_2$id_synthese == 124571 ] <- 
  process_data_1$champs_additionnels[720]

#création du tableau final avec les 3 espèces et les colonnes dans le bon format. C'est ce tableau qui est par la suite utilisé. 
process_data = process_data_2

write_csv(process_data, "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")

tibble(Variables = names(process_data)) |>
  kbl(caption = "Variables du jeu de données") |>
  kable_styling(full_width = FALSE)
```

Les 13 variables conservées sont présentées dans la la liste ci-dessus.

```{r}

head(process_data) |>
  kbl(caption = "Aperçu des données") |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )

```

Le tableau process_data correspond aux données sur toute la periode 1990-2025 pour toutes les données d'interet. On y retrouve des données protocolées et des données oportunistes.

Il y a deux protocoles mis en place pour les trois espèces : un pour le Butor étoilé et un pour le Blongios et la Talève. Le protocole Butor se réalise entre le 10 avril et le 16 mai, à raison de deux à quatre visites sur la période. Chaque visite sur un point consiste à écouter pendant 15 minutes 1 fois le soir (entre 30mn avant le coucher du soleil et 1h après) et 1 fois le matin (dans les 2h qui précèdent le lever du soleil).

Le protocole Bliongios-Talève se réalise entre le 1er mai et fin juiller. Il y a une visite toutes les 3 semaines sur les 9 points d'écoute (et d'observation), soit 4 visites annuelles. Chaque visite sur un point consiste à écouter (et observer) pendant 30 minutes 1 fois le soir (entre 1h avant le coucher du soleil et 30mn après) et 1 fois le matin (dans les 1h30 qui suivent le lever du soleil) Chaque visite comporte trois parties : 10 mn d'écoute-observation suivie de 10mn d'écoute-observation avec repasse du chant de Blongios suivi de 10mn d'écoute-observation avec repasse du chant de Talève.

Nous ne gardons par la suite des analyses que les données qui font parti de ces protocoles : donc à partir de 2014 et uniquement sur les 9 points d'écoutes protocolés. Les autres données sont considerées comme opportunistes.

```{r}
## 2. Créer le tableau de données utilisé dans les analyses sur le protocole

#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
process_data$annee = year(floor_date(process_data$date_debut, "year"))

#on filtre pour enlever toutes les données avant 2014 (le début des protocoles)
# on filtre pour garder uniquement les données protocolées : on garde les lieux protocolés "ButorTalèveBlongios de 1 à 9 ; on garde uniquement les données rensignées comme protocolés SuiviButor|BlongiosTalève
process_protocole = process_data  %>%
  filter(annee>= 2014) %>%
  filter (nom_lieu  %in% paste0 ("ButorTalèveBlongios-", 1 : 9)) %>%
  filter( champs_additionnels== "{'RELV_NOM': 'SuiviButor'}" |
          champs_additionnels== "{'RELV_NOM': 'SuiviBlongiosTalève'}")


#écrire le nouveau csv des données >2014 protocolées 
write_csv(process_protocole, "data/pro/process_protocole.csv")

head(process_protocole) |>
  kbl(caption = "Aperçu des données") |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )


```

Ce tableau est celui qui sera utilisé pour les analyses dans la suite du projet. Il ne contient que les données qui appartiennent aux protocoles BlongiosTalève et Butor.

# 2. Les données météorologiques

Les données météorologiques ont été fournies par InfoClimat. Nous avons un document par année de 2013 à 2025. On créé un nouveau data frame qui rassemble toutes les données en 1 tableau.

```{r data_enviro, message=FALSE, warning=FALSE}
#| echo: false
#il faut aller chercher les données environnementales

#récuperer les csv bruts pour chaque année 
file_2013 <- read_delim("data/raw/2013.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)

file_2014 <- read_delim("data/raw/2014.csv", delim = ";", 
                       escape_double = FALSE, trim_ws = TRUE, 
                       skip = 4)
file_2015 <- read_delim("data/raw/2015.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2016 <- read_delim("data/raw/2016.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2017 <- read_delim("data/raw/2017.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2018 <- read_delim("data/raw/2018.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2019 <- read_delim("data/raw/2019.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2020 <- read_delim("data/raw/2020.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2021 <- read_delim("data/raw/2021.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2022 <- read_delim("data/raw/2022.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2023 <- read_delim("data/raw/2023.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2024 <- read_delim("data/raw/2024.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)
file_2025 <- read_delim("data/raw/2025.csv", delim = ";", 
                        escape_double = FALSE, trim_ws = TRUE, 
                        skip = 4)

#enlever la première ligne qui donne les unités des colonnes (toujours présent dans les données brutes si besoin de les retrouver )
file_2013 <- file_2013[-1, ]
file_2014 <- file_2014[-1, ]
file_2015 <- file_2015[-1, ]
file_2016 <- file_2016[-1, ]
file_2017 <- file_2017[-1, ]
file_2018 <- file_2018[-1, ]
file_2019 <- file_2019[-1, ]
file_2020 <- file_2020[-1, ]
file_2021 <- file_2021[-1, ]
file_2022 <- file_2022[-1, ]
file_2023 <- file_2023[-1, ]
file_2024 <- file_2024[-1, ]
file_2025 <- file_2025[-1, ]

#on crée un data frame avec tous les fichiers 
data_environnement <- bind_rows(file_2013, file_2014, file_2015, file_2016, file_2017, file_2018, file_2019, file_2020, file_2021, file_2022, file_2023, file_2024, file_2025)

#écrire le CVS avec toutes les données 
write_csv(data_environnement, "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/raw/raw_environnement.csv")

#tri et clean des données environnementales : les données sont toutes les 20min depuis 2013.
data_environnement2=data_environnement

#mettre la date en bon format
data_environnement2$dh_utc= as.POSIXct(data_environnement2$dh_utc, format =c("%Y-%m-%d %H:%M:%S"), tz="UTC")

data_environnement2$date <- as.Date(data_environnement2$dh_utc)


data_environnement2_clean <- data_environnement2 %>%
  mutate(Date = as.Date(date)) %>%
  mutate(across(!c(Date,dh_utc), ~ suppressWarnings(as.numeric(.x))))


environnement_daily <- data_environnement2_clean %>%
  group_by(Date) %>%
  summarise(across(where(is.numeric),
                   ~ mean(.x, na.rm = TRUE)),
            .groups = "drop")



#écriture du csv propre qui sera utilisé par la suite : 1 donnée par jour (moyenne de toutes les variables qui étaient toutes les 20min) -> nommé environnement_daily
write_csv(environnement_daily, "C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/environnement_daily.csv")



head(environnement_daily) |>
  kbl(caption = "Aperçu des données") |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )

```

Nous avons un tableau de données environnementales de 2013 à 2025. Initialement, il y avait des données toutes les 20minutes, nous avons fait des moyennes journalières pour diminuer le nombre de données.

Dans le tableau des données environnementales, il manque des jours, on fait donc des moyennes glissantes pour créer les données (car 1 ou 2 jours consécutif manquant maximum). Il faut donc d'abord créer les lignes des jours puis créer les données manquantes.

```{r}

##### création des lignes pour les jours manquants du tableau environnement_daily

# étape 1 création d'un tableau de 2013 à 2025 avec une variable jour julian

date_debut <- as.Date("2013-01-01")
date_fin   <- as.Date("2025-12-31")

toutes_dates <- seq(from = date_debut, to = date_fin, by = "day")

données_2013_2025 <- data.frame(
  Date = toutes_dates)

données_2013_2025$julian = yday(données_2013_2025$Date)



# étape 2 on va forcer le rajout des lignes avec un full.join qui permet de rajouter toutes les lignes du tableau 2 au premier tableau meme si les lignes n'ont pas de jointures

environnement_daily <- environnement_daily %>%
  full_join(
    données_2013_2025 %>% select(Date, julian),
    by = "Date"
  )

# Etape 3 verification du jeu de données
# 
# # Nombre de jours par année
# environnement_daily %>%
#   mutate(Annee = year(Date)) 
#   # count(Annee)
# 
# # les lignes manquantes si il y'en a
# résumé_jours_NA = environnement_daily %>%
#   filter(is.na(temperature)) %>%        
#   mutate(Annee = year(Date)) %>%        
#   group_by(Annee) %>%                   
#   summarise(
#     nb_lignes = n(),                     
#     nb_jours_uniques = n_distinct(Date)  
#   )


### 3.2 Rajout des moyennes glissantes

# On calcule la variable température et pluie moyenne glissante sur 31 jours 

environnement_daily <- environnement_daily %>%
  arrange(Date) %>%
  mutate(
    temp_moy_glissante_31j = slide_dbl(
      temperature,
      mean,
      .before = 31,
      .after = 0,
      .complete = TRUE,
      na.rm = TRUE
    )
  )

environnement_daily <- environnement_daily %>%
  arrange(Date) %>%
  mutate(
    temp_moy_glissante_7j = slide_dbl(
      temperature,
      mean,
      .before = 7,
      .after = 0,
      .complete = TRUE,
      na.rm = TRUE
    )
  )

environnement_daily <- environnement_daily %>%
  arrange(Date) %>%
  mutate(
    pluie_moy_glissante_31j = slide_dbl(
      pluie_1h,
      mean,
      .before = 31,
      .after = 0,
      .complete = TRUE,
      na.rm = TRUE
    )
  )
environnement_daily <- environnement_daily %>%
  arrange(Date) %>%
  mutate(
    pluie_moy_glissante_7j = slide_dbl(
      pluie_1h,
      mean,
      .before = 7,
      .after = 0,
      .complete = TRUE,
      na.rm = TRUE
    )
  )
write_csv(
  environnement_daily,
  "data/pro/environnement_daily.csv"
)


head(environnement_daily) |>
  kbl(caption = "Aperçu des données") |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )

```

```{r}
#| echo: false
process_protocole = process_protocole %>%
  inner_join( environnement_daily,by = c("date_debut"= "Date") )

write_csv(
  process_protocole,
  "data/pro/process_protocole.csv"
)
```

Dans ce tableau, que certaines variables nous interessent : la pluie, le vent et la température.

```{r}
#graphique enviro


environnement_daily <- environnement_daily %>%
  mutate(
    year = year(Date),
    day_of_year = yday(Date)  # équivalent du jour julien
  )

ggplot(environnement_daily, aes(x = day_of_year, y = temperature)) +
  geom_line(color = "red") +
  facet_wrap(~ year, scales = "free_y") +
  labs(
    title = "Évolution journalière des températures (2013–2025)",
    x = "Jour de l'année",
    y = "Température (°C)"
  ) +
  theme_minimal()


```

Ces graphiques montrent l'évolution de la température durant un an pour chaque année d'étude. On voit que les patterns sont les mêmes.

```{r}

ggplot(environnement_daily, aes(x = day_of_year, y = pluie_1h)) +
  geom_line(color = "steelblue") +
  facet_wrap(~ year, scales = "free_y") +
  labs(
    title = "Évolution journalière de la pluie (2013–2025)",
    x = "Jour de l'année",
    y = "Pluie"
  ) +
  theme_minimal()

```

Ces graphiques montrent l'évolution de la pluie journalière par année d'étude. On voit qu'il y a des années plus sèches, comme 2019 ou 2021, et des années plus pluvieuses, comme 2023 ou 2025.

# 3. Les données hydrologiques

Les données hydrologiques comportent un grand nombre de variables, mais seules 2 variables nous interessent ici : la profondeur moyenne du grand Bagnas, et les assec totaux ou partiels.

```{r}

### Importe les packages
library(ggplot2)
library(dplyr)
library(lubridate)

### Importation des données brutes
HydrologicData <- read.csv("data/raw/DataHydro.csv", sep = ";")

### On sélectionne les colonnes qui nous interessent dans le data frame hydro et on remet les données sous le bon format et les données après 2013
HydrologicDataGrandBagnas <- HydrologicData %>%
  select(Station, Date.Releve, Heure, Salinite, Temperature, Niveau.Ngf, Niveau.Relatif)%>%
  mutate(Profondeur = (Niveau.Ngf+0.27),
         Date.Releve = as.Date(Date.Releve, format = "%d/%m/%Y"),
         Annee = as.integer(format(Date.Releve, "%Y")),
         Mois = format(Date.Releve, "%m"),
         Jour = yday(Date.Releve))%>%
  filter(Station == "Etangs du Grand Bagnas - TB5 centre",
         Annee > 2013)

### Calcule la profondeur et l'altitude moyenne (de l'eau) mensuelle
Hydro_moyenne <- HydrologicDataGrandBagnas %>%
  group_by(Annee, Mois) %>%
  summarise(
    ProfondeurMoyenne = mean(Profondeur, na.rm = TRUE),
    AltitudeMoyenne = mean(Niveau.Ngf, na.rm = TRUE),
    .groups = "drop")

### Code une variable Assec (mois par mois) et AssecT (niveau le plus extreme de l'année) 
HydrologicDataGrandBagnas <- HydrologicDataGrandBagnas %>%
  mutate(
    Assec = case_when(
      is.na(Profondeur) ~ "total",
      Profondeur < 0.2  ~ "partiel",
      TRUE                     ~ "non"),
    Assec_score = case_when(
      Assec == "non"     ~ 1,
      Assec == "partiel" ~ 2,
      Assec == "total"   ~ 3)) %>%
  group_by(Annee) %>%
  mutate(
    AssecT = case_when(
      max(Assec_score, na.rm = TRUE) == 3 ~ "total",
      max(Assec_score, na.rm = TRUE) == 2 ~ "partiel",
      TRUE                                ~ "non")) %>%
  ungroup() %>%
  select(-Assec_score)

### Crée une variable AssecT_1 (AssecT de l'année précédente)
Assec_annuel <- HydrologicDataGrandBagnas %>%
  distinct(Annee, AssecT) %>%
  bind_rows(tibble(Annee = 2014, AssecT = "non")) %>%
  filter(Annee != 2026) %>%                             
  arrange(Annee) %>%
  mutate(AssecT_1 = lag(AssecT),
         AssecT_1 = if_else(Annee == 2014, "non", AssecT_1))%>%
  group_by(Annee) %>%
  slice(1) %>%   
  ungroup()

### Ajoute la variable AssecT_1 au tableau HydrologicDataGrandBagnas
HydrologicDataGrandBagnas <- HydrologicDataGrandBagnas %>%
  left_join(
    Assec_annuel %>% select(Annee, AssecT_1),
    by = "Annee")

### Conserve que les bonnes variables 
HydrologicDataGrandBagnas <- HydrologicDataGrandBagnas[,c(8,9,10,11,14)]

### Remplace les valeurs NA de Profondeur par 0
HydrologicDataGrandBagnas <- HydrologicDataGrandBagnas %>%
  mutate(Profondeur = if_else(is.na(Profondeur), 0, Profondeur))

### Convertit la variable Mois en numérique  
HydrologicDataGrandBagnas$Mois <- as.numeric(as.character(HydrologicDataGrandBagnas$Mois))

### Graphique de la profondeur moyenne mensuelle par année
ggplot(HydrologicDataGrandBagnas, aes(x = Mois, y = Profondeur)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ Annee, ncol = 3) +
  scale_x_continuous(breaks = 1:12) +
  theme_bw()
```

ces graphiques représentent la profondeur de l'eau chaque année. on peut voir en 2016, 2019 et 2022 des assec totaux (profondeur à 0) en septembre.

Pour des raisons écologiques, on utilise les assec de l'année qui précède l'année d'étude. JUSTIFICATION BIBLIO? On crée une variable Assec de l'année précédente avec 3 modalités : non (pas d'assec), partiel et total.

```{r}
## INTERPOLATION LINÉAIRE DE LA PROFONDEUR JOURNALIÈRE

### On crée une fonction qui génère un data frame avec les jours de l'année
jours_par_annee <- function(df) {
  data.frame(Jour = 1:365)}

### On applique la fonction à chaque année pour avoir un tableau avec tous les jours de chaque année
DataInterpolationProfondeur <- HydrologicDataGrandBagnas %>%
  group_by(Annee) %>%
  group_modify(~ {    interp <- approx(
    x = .x$Jour,
    y = .x$Profondeur,
    xout = 1:365,   
    rule = 2         )
  tibble(
    Jour = interp$x,
    Profondeur = interp$y)}) %>% ungroup()

### Ajoute les colonnes Date, Mois au tableau DataInterpolationProfondeur
AssecT_1_annee <- HydrologicDataGrandBagnas %>%
  select(Annee, AssecT_1) %>%
  distinct()

### Crée la colonne Date
HydrologicDataGrandBagnas <- DataInterpolationProfondeur %>%
  left_join(AssecT_1_annee, by = "Annee")

### Enregistre le tableau final dans le fichier processed
write.csv(HydrologicDataGrandBagnas, file = "data/pro/DataHydroBagnas.csv", row.names = FALSE)
DataHydroBagnas <- HydrologicDataGrandBagnas



head(DataHydroBagnas) |>
  kbl(caption = "Aperçu des données") |>
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE
  )


```

Les données hydro nous interessent pour la profondeur moyenne et les assec. Dans le tableau initial, les données n'étaient que toutes les 2 semaines, on a donc créé des données quotidienne par interpolation linéaire. On a donc pour chaque jour la profondeur de l'eau, et la présence ou non d'un assec un an avant.

On rajoute ensuite les variables hydrologiques dans les tableaux de données process_protocole et environnement_daily.

```{r}
DataHydroBagnas<- DataHydroBagnas%>%

 mutate( date = as.Date(Jour-1 , origin = paste0(Annee, "-01-01")) )

environnement_daily = environnement_daily %>%
  inner_join( DataHydroBagnas,by = c("Date"= "date") )%>%
  select(-Annee, -Jour)

process_protocole <- process_protocole %>%
  inner_join(DataHydroBagnas, by = c("date_debut" = "date")) %>%
  select(-Annee, -Jour)

write_csv(environnement_daily, "data/pro/environnement_daily.csv")

write_csv(process_protocole, "data/pro/process_protocole.csv")

```

# C. Analyses exploratoires

Les premières analyses des données sont exploratoires. Cette partie présente les analyses exploratoires communes aux 3 espèces.

## A. les observateurs Script d'Émile

A FAIRE Ce graphique représente les observations par observateurs.

## B. cartographie des sites protocolés

La cartographie des sites d'écoute pour les 3 espèces. Les sites sur la carte sont les 9 sites du protocole. En cliquant sur les points rouges les noms des sites apparaissent.

```{r}


#1 : les sites du protocole :
#on va chercher le csv process_protocole dans l'ordinateur
process_protocole <- read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_protocole.csv")

#préparer les coordonnées pour que R comprenne 
sites_protocole <- st_as_sf(process_protocole, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

#le package leaflet permet de projeter des coordonnées sur la carte du monde
leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole, 
    radius = 5,
    color = "red",
    fillOpacity = 0.9,
    popup = ~nom_lieu  #quand on appuie sur les point de la carte le nom des sites du protocole apparraissent 
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```





















