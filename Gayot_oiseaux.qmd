---
title: "Gayot_oiseaux"
format: html
editor: visual
---

## Test

### Les packages nécessaires

```{r}
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
```

### Netoyage de données

```{r}
setwd("C:/Users/lucie/Desktop/Projet_Biodiversite/oiseaux_bagnas/data/raw")
raw_data<- read_excel("synthese_observations_2025-09-09T13_30_50.994Z.xlsx") 
View(raw_data)

#clean 

process_data<- raw_data %>%
  select(id_synthese,date_debut,date_fin,heure_debut,heure_fin,
         nom_vernaculaire,nombre_min,observateurs,determinateur,x_centroid_4326,
         y_centroid_4326,nom_lieu,champs_additionnels)

write.csv(process_data,
          file = "C:/Users/lucie/Desktop/Projet_Biodiversite/oiseaux_bagnas/data/pro/process_data.csv",
          row.names = FALSE)
```

#### Aperçu des especes

```{r}
head(process_data) 
str(process_data) 
glimpse(process_data)

occ_par_espece <- process_data %>% 
  group_by(nom_vernaculaire) %>% 
  summarise(id_synthese= n()) %>% 
  arrange(desc(id_synthese))

head(occ_par_espece)
```

#### Aperçu des années

```{r}
occ_par_annee<-process_data %>% mutate( date_parsed = ymd(date_debut),
                                      annee = year(date_parsed) ) %>% 
  group_by(annee) %>% 
  summarise(total_individus = n(), .groups = "drop") %>% 
  arrange(desc(annee))

print(occ_par_annee, n = Inf)

ggplot(process_data, aes(x = x_centroid_4326, y = y_centroid_4326, color = nom_vernaculaire)) + 
  geom_point(alpha = 0.6 , size = 1) +
  coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")
```

## Butor étoilé

```{r}
Butor_etoile<-process_data %>% filter( nom_vernaculaire == "Butor étoilé")

Butor_etoile

```

#### Aperçu des années du butor etoile

```{r}
occ_par_annee_butor_etoile<-Butor_etoile %>% 
  mutate( date_parsed = ymd(date_debut),
 annee_butor_etoile = year(date_parsed) ) %>% 
  group_by(annee_butor_etoile) %>% summarise(total_individus = n(), .groups = "drop") %>% arrange(desc( annee_butor_etoile))

print(occ_par_annee_butor_etoile, n = Inf)

ggplot(occ_par_annee_butor_etoile, aes(x = annee_butor_etoile, y = total_individus)) + geom_bar(stat = "identity", fill = "#2c7fb8") + labs( title = "Observations annuelles du Butor etoile", x = "Année", y = "Nombre d'individus observés" ) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1))

ggplot(Butor_etoile, aes(x = x_centroid_4326, y = y_centroid_4326)) + geom_point(alpha = 0.6) + coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")

```

## Blongios nain, Butor blongios

```{r}
Blongios_nain<-process_data %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Blongios_nain
```

#### Aperçu des années Blongios nain, Butor blongios

```{r}
occ_par_annee_Blongios_nain<-Blongios_nain %>% mutate( date_parsed = ymd(date_debut),
                                                         annee_Blongios_nain = year(date_parsed) ) %>% group_by(annee_Blongios_nain) %>% summarise(total_individus = n(), .groups = "drop") %>% arrange(desc(annee_Blongios_nain))

print(occ_par_annee_Blongios_nain, n = Inf)

ggplot(occ_par_annee_Blongios_nain, aes(x = annee_Blongios_nain, y = total_individus)) + geom_bar(stat = "identity", fill = "#2c7fb8") + labs( title = "Observations annuelles du Blongios nain", x = "Année", y = "Nombre d'individus observés" ) + theme_minimal() + theme( axis.text.x = element_text(angle = 45, hjust = 1))
ggplot(Blongios_nain, aes(x = x_centroid_4326, y = y_centroid_4326)) + geom_point(alpha = 0.6) + coord_fixed() + labs(title = "Distribution spatiale des occurrences", x = "Longitude", y = "Latitude")

```

##PAr protocole

#### Protocole scientifique

```{r}
Protocole_Scientifique <- process_data %>%
  filter( champs_additionnels %in% c("{'RELV_NOM': 'SuiviButor'}", "{'RELV_NOM': 'SuiviBlongiosTalève'}"))
```

#### Protocole Opportuniste

```{r}
Protocole_opportuniste <- process_data %>%
  filter( !champs_additionnels %in% c("{'RELV_NOM': 'SuiviButor'}", "{'RELV_NOM': 'SuiviBlongiosTalève'}"))

```

# Analyses explo

## Question 1 : Est ce que les protocoles sont réalisés de façon linéaire le temps

```{note}
#Nous avons besoin de prendre seulement les données qui proviennent des protocoles 
```

```{r}

Protocole_SuiviButor<- Protocole_Scientifique %>%
  filter( champs_additionnels == "{'RELV_NOM': 'SuiviButor'}")

Protocole_SuiviBlongiosTalève<- Protocole_Scientifique %>%
  filter( champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}")

```

```{note}
#Étape 2 : nous devons diviser les données par site et par espèce,
# afin d'obtenir un jeu de données distinct pour chaque combinaison.
# Nous réalisons ensuite une boucle qui permet de générer un schéma de vie hebdomadaire pour chaque site,
# afin de vérifier si les protocoles ont été réalisés chaque année et à la même période ou non.
```

#### Pour le Butor

```{r, fig.width=30, fig.height=25}

# Liste des noms de sites
sites <- c(unique(Protocole_SuiviButor$nom_lieu))

# Définir toutes les semaines attendues pour la période de suivi (reste hors de la boucle)
annees <- 1996:2025
semaines <- 1:53  # Certaines années ont 53 semaines ISO

# Générer un data frame complet avec toutes les semaines de toutes les années
calendrier <- expand.grid(annee = annees, semaine = semaines) %>%
  arrange(annee, semaine)

# creation liste pour la boucle 

tous_les_graphes <- list()
# --- 2. Boucle pour l'Analyse et le Graphique de Chaque Site ---

# Nous itérons directement sur la liste des noms de sites
for(site_nom in sites) {
  
  # a) Filtrer les données pour le site actuel (site_nom)
  df_site <- Protocole_SuiviButor %>%
    filter(nom_lieu == site_nom)
  
  # b) Préparation des données: convertir la date et extraire année + semaine
  # Si df_site est vide, le reste du pipeline fonctionnera toujours grâce à right_join
  data_semaines_site <- df_site %>%
    mutate(
      date_parsed = ymd(date_debut),
      annee = year(date_parsed),
      semaine = isoweek(date_parsed)
    )
  
  # c) Calculer le suivi (compte et jointure avec le calendrier)
  suivi <- data_semaines_site %>%
    group_by(annee, semaine) %>%
    summarise(nb = n(), .groups = "drop") %>%
    right_join(calendrier, by = c("annee", "semaine")) %>%
    mutate(
      fait = ifelse(is.na(nb), "Non", "Oui"),
      annee_fct = factor(annee) 
    )
  
  # d) Créer le graphique
  g <- ggplot(suivi, aes(x = semaine, y = annee_fct, fill = fait)) +
    geom_tile(color = "black") +
    scale_fill_manual(values = c("Oui" = "forestgreen", "Non" = "red")) +
    labs(
      title = paste("Site", site_nom), # Titre raccourci pour la vue combinée
      x = "Semaine ISO",
      y = "Année",
      fill = "Protocole fait ?"
    ) +
    theme_minimal() +
    theme(
      panel.grid = element_blank(),
      axis.text.y = element_text(size = 6),
      axis.text.x = element_text(size = 6),
      plot.title = element_text(size = 8, hjust = 0.5) 
    ) 

  tous_les_graphes[[site_nom]] <- g
}

grid.arrange(grobs = tous_les_graphes, ncol = 4)

```



grid.arrange(grobs = tous_les_graphes, ncol = 4)


#### Pour le BlongiosTalève

```{r}
site_Blongios = sites <- c(unique(Protocole_SuiviBlongiosTalève$nom_lieu))

tous_les_graphes_Blongios = list()

for(site_nom in sites) {
df_site <- Protocole_SuiviBlongiosTalève %>%
  filter(nom_lieu == site_nom)

# b) Préparation des données: convertir la date et extraire année + semaine
# Si df_site est vide, le reste du pipeline fonctionnera toujours grâce à right_join
data_semaines_site <- df_site %>%
  mutate(
    date_parsed = ymd(date_debut),
    annee = year(date_parsed),
    semaine = isoweek(date_parsed)
  )

# c) Calculer le suivi (compte et jointure avec le calendrier)
suivi_Blongios <- data_semaines_site %>%
  group_by(annee, semaine) %>%
  summarise(nb = n(), .groups = "drop") %>%
  right_join(calendrier, by = c("annee", "semaine")) %>%
  mutate(
    fait = ifelse(is.na(nb), "Non", "Oui"),
    annee_fct = factor(annee) 
  )

# d) Créer le graphique
g <- ggplot(suivi_Blongios, aes(x = semaine, y = annee_fct, fill = fait)) +
  geom_tile(color = "black") +
  scale_fill_manual(values = c("Oui" = "forestgreen", "Non" = "red")) +
  labs(
    title = paste("Site", site_nom), # Titre raccourci pour la vue combinée
    x = "Semaine ISO",
    y = "Année",
    fill = "Protocole fait ?"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.text.y = element_text(size = 6), 
    axis.text.x = element_text(size = 6),
    plot.title = element_text(size = 8, hjust = 0.5) 
  ) 

tous_les_graphes_Blongios[[site_nom]] <- g
}
```

`````{note}
#Combiner tous les graphiques sur une seule page

```{r, fig.width=30, fig.height=25}
grid.arrange(grobs = tous_les_graphes_Blongios, ncol = 4)
```
