---
title: "Butor_clean"
format: html
editor: visual
---

```{r setup}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
#ce code permet de n'afficher auxun message parasite ni les warnings. 
```

# Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(slider)

setwd("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro")
process_data <- read_csv("C:/Users/LENOVO/Desktop/M2/BIODIV_DATA/oiseaux_bagnas/data/pro/process_data.csv")
```

## 1. analyses exploratoires pour le Butor

### A- Graphique de présence des Butors par semaine depuis 1990

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 


esp_butor<- "Butor étoilé"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_butor <- process_data %>%
  filter(nom_vernaculaire == esp_butor) %>% #on filtre pour avoir uniquement les lignes du Butor dans le data frame
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1, 
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut) # on crée les numéros des semaines
  )

# --- Résumer les semaines pour gérer les sorties multiples ---
data_butor_summarized <- data_butor %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviButor", champs_additionnels) #on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole

      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )
# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_butor_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de", esp_butor),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

### B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/pro/process_protocole.csv")

process_protocole_butor <- process_protocole %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_protocole_butor <- st_as_sf(process_protocole_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_protocole_butor <- sites_protocole_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     

  addCircleMarkers(
    data =sites_protocole_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)

```

### C- Effort journalier du protocole Butor

```{r}
# Données protocolées du Butor
process_protocole <- read_csv("data/pro/process_protocole.csv")



Protocole_SuiviButor <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Protocole_SuiviButor <- Protocole_SuiviButor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_SuiviButor <- Protocole_SuiviButor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Création d'une table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les observation par heure

obs_heure <- Protocole_SuiviButor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_SuiviButor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Butor (2014-2018)")
```

### D- Effort journalier des données opportunistes

```{r}
# Données 

Opportuniste_Butor <- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviButor'}" &
      nom_vernaculaire == "Butor étoilé"
  )

Opportuniste_Butor <- Opportuniste_Butor %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Opportuniste_Butor <- Opportuniste_Butor  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Butor %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Butor %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations \n opportunistes par heure pour le Butor (1997-2023), \nsans les heures inconnues ")

```

### E - Cumule des observations de Butor

```{r}

# étape 0 création d'une variable année 

#floor date permet de récuperer l'année et de créer une nouvelle colonne uniquement avec l'année
data_butor$annee = year(floor_date(data_butor$date_debut, "year"))

```

#### a - Cumule par année

```{r}

obs_annee <- data_butor %>%
  group_by(annee) %>%
  summarize(sum(nombre_min))

### Barplot

ggplot(obs_annee, aes(x = annee)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Année") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque année entre 1990 et 2025")

```

#### b - Cumule par semaine

```{r}
obs_semaine <- data_butor %>%
  group_by(semaine) %>%
  summarize(sum(nombre_min, na.rm = TRUE)) %>%
  mutate(
    saison = case_when(
      semaine %in% c(0:12, 52:53) ~ "Hiver",
      semaine %in% 13:25          ~ "Printemps",
      semaine %in% 26:38          ~ "Été",
      semaine %in% 39:51          ~ "Automne"
    )
  )

### Barplot

ggplot(obs_semaine, aes(x = semaine)) +
  geom_rect(
    aes(xmin = 15, xmax = 21, ymin = -Inf, ymax = Inf,
        fill = "Période du protocole"),
    inherit.aes = FALSE
  ) +
  geom_bar(
    aes(y = `sum(nombre_min, na.rm = TRUE)`, fill = saison),
    stat = "identity",
    width = 0.4
  ) +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(
    values = c(
      "Hiver" = "steelblue",
      "Printemps" = "forestgreen",
      "Été" = "gold",
      "Automne" = "darkorange",
      "Période du protocole" = "grey70"
    )
  ) +
  xlab("Semaine") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre de butors observés chaque semaine de l'année entre 1990 et 2025") +
  labs(fill = "")

```

#### c - Cumule par année pour chaque site (même les sites hors protocole)

```{r}
process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")


process_butor <- process_data %>%
  filter(nom_vernaculaire=="Butor étoilé")

#préparer les coordonnées pour R 
sites_butor <- st_as_sf(process_butor, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Butor par site (somme depuis 2014)
sites_butor <- sites_butor %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     
  
  addCircleMarkers(
    data =sites_butor, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, #la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Butor entendus : " ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)
```
