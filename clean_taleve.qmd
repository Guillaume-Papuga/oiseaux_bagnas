---
title: "clean_taleve"
format: html
editor: visual
---

```{r setup}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```


#Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(slider)
library(leaflet)
library(sf)

setwd("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro")
process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")

```

## 1. analyses exploratoires de la Talève

#A- Graphique de présence des Talèves par semaine depuis 1990

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 

esp_taleve<- "Talève sultane, Poule sultane, Porphyrion bleu"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_taleve <- process_data %>%
  filter(nom_vernaculaire == esp_taleve) %>%
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut)
  )


# --- Résumer les semaines pour gérer les sorties multiples ---
data_taleve_summarized <- data_taleve %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)#on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # observations présentes
       # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole
      
      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )


# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_taleve_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de la ", esp_taleve),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

#B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

process_protocole_taleve <- process_protocole %>%
  filter(nom_vernaculaire=="Talève sultane, Poule sultane, Porphyrion bleu")

#préparer les coordonnées pour R 
sites_protocole_taleve <- st_as_sf(process_protocole_taleve, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Talève par site (somme depuis 2014)

sites_protocole_taleve <- sites_protocole_taleve %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_taleve, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min,#la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Talèves entendues :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)



```

#C- Effort journalier des données protocoles Talève

```{r}
# Données 

process_protocole <- read_csv("data/pro/process_protocole.csv")
Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Protocole_Taleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Taleve <- Protocole_Taleve %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_Taleve <- Protocole_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Talève (2014-2018)")


```

#D- Effort journalier des données opportunistes Talève

```{r}
# Données 

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

Opportuniste_Taleve <- Opportuniste_Taleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Taleve <- Opportuniste_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour la Talève (2014-2018)")


```

##2 . Modèle de présence/absence

```{r}

library(ggplot2)
library(dplyr)
library(broom)

## Importation des données
process_protocole <- read.csv("data/pro/process_protocole.csv", sep = ",")
process_protocole$nombre_min <- ifelse(process_protocole$nombre_min > 0, 1, 0)
HydrologicDataGrandBagnas <- read.csv("data/pro/DataHydroBagnas.csv", sep = ",")
colnames(HydrologicDataGrandBagnas)[colnames(HydrologicDataGrandBagnas) == "Annee"] <- "annee"
colnames(HydrologicDataGrandBagnas)[colnames(HydrologicDataGrandBagnas) == "Mois"] <- "mois"


## colonnes à garder
cols_keep <- c(1, 2, 3, 6, 7, 12, 14)

## filtre les données pour la talève sultane
Protocole_SuiviTaleve <- process_protocole %>%
  filter(nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu") %>%
  select(all_of(cols_keep))

## ajoute des colonnes pour le jour julien et son effet quadratique
Protocole_SuiviTaleve$date_debut <- as.Date(Protocole_SuiviTaleve$date_debut, format = "%Y-%m-%d")
Protocole_SuiviTaleve$julian_day <- as.numeric(Protocole_SuiviTaleve$date_debut) #jour julien
Protocole_SuiviTaleve$julian_day2 <- Protocole_SuiviTaleve$julian_day^2 #jour julien carré

## ajoute les données hydrologiques au data frame taleve_sultane
Protocole_SuiviTaleve$annee <- as.integer(format(Protocole_SuiviTaleve$date_debut, "%Y"))
Protocole_SuiviTaleve$mois <- as.integer(format(Protocole_SuiviTaleve$date_debut, "%m"))
Protocole_SuiviTaleve <- merge(Protocole_SuiviTaleve, HydrologicDataGrandBagnas, by = c("annee", "mois"), all.x = TRUE)

## Modèle GLM avec la présence de la talève en fonction du temps
glm_taleve_temps <- glm(nombre_min ~ julian_day + I(julian_day^2), family = binomial, data = Protocole_SuiviTaleve)  
summary(glm_taleve_temps)

## Modèles GLM avec la présence de la talève en fonction des conditions hydrologiques
glm_taleve_hydro <- glm(nombre_min ~ ProfondeurMoyenne + AssecT_1, family = binomial, data = Protocole_SuiviTaleve)
summary(glm_taleve_hydro)

## Modèles GLM avec la présence de la talève en fonction du temps et des conditions hydrologiques
glm_taleve_temps_hydro <- glm(nombre_min ~ julian_day + I(julian_day^2) + ProfondeurMoyenne + AssecT_1, family = binomial, data = Protocole_SuiviTaleve)
summary(glm_taleve_temps_hydro)



ggplot(Protocole_SuiviTaleve, aes(x = ProfondeurMoyenne, y = nombre_min)) +
  geom_jitter(height = 0.02, width = 0, alpha = 0.5, color = "blue") +
  stat_smooth(method = "glm", method.args = list(family = binomial),
              formula = y ~ x, color = "red", se = TRUE) +
  labs(x = "Profondeur moyenne (m)", y = "Présence (0/1)",
       title = "Effet de la profondeur sur la présence de la Talève sultane") +
  theme_minimal()



# Crée une grille de profondeur pour prédiction
depth_seq <- seq(
  min(Protocole_SuiviTaleve$ProfondeurMoyenne, na.rm = TRUE),
  max(Protocole_SuiviTaleve$ProfondeurMoyenne, na.rm = TRUE),
  length.out = 100
)

# Crée un dataframe pour prédictions
pred_grid <- data.frame(
  ProfondeurMoyenne = depth_seq,
  julian_day = mean(Protocole_SuiviTaleve$julian_day, na.rm = TRUE),   # On fixe le temps à la moyenne
  AssecT_1 = "non"                                             # On fixe AssecT_1 à la catégorie de référence
)

# Prédictions de probabilité
pred_grid$prob <- predict(glm_taleve_temps_hydro, newdata = pred_grid, type = "response")

# Heatmap
ggplot(pred_grid, aes(x = ProfondeurMoyenne, y = 1, fill = prob)) +
  geom_tile() +
  scale_fill_gradient(low = "white", high = "steelblue", name = "Probabilité") +
  labs(x = "Profondeur moyenne (m)", y = "", 
       title = "Probabilité prédite de présence de la Talève sultane") +
  theme_minimal() +
  theme(axis.text.y = element_blank(),
        axis.ticks.y = element_blank())

```

##2.1 Interpretation

Le modèle GLM explorant la présence de la Talève sultane en fonction du temps, de la profondeur et de l’assec de l’année précédente montre que la profondeur moyenne a un effet significatif positif sur la probabilité de présence (Estimate = 2,19, p = 0,035). Les variables temporelles (date julienne et son terme quadratique) ne sont pas significatives (p ≈ 0,09–0,10), indiquant que la présence de l’espèce n’évolue pas de façon marquée au cours de la période 2014–2024. Les effets de l’assec de l’année précédente sont faibles et non significatifs, avec un assec partiel ayant un effet légèrement négatif et un assec total un effet légèrement positif (p ≈ 0,17–0,08).

## 3 . Modèle d'abondance

Cette analyse vise à caractériser la dynamique de la population de **Talève** et à déterminer l'influence relative des variables temporelles (année, date julienne) et environnementales (précipitations et temperatures) sur l'abondance observée.

## 3.1 Modèle d'abondance en fonction du temps

Nous réalisons cette analyse sur seulement les observations qui proviennent du protocole (donc pas les observations opportunistes)

```{r}
process_protocole <- read.csv("data/pro/process_protocole.csv", sep = ",")
# Filtrer les relevés pour Talève sultane
Protocole_SuiviTaleve <- process_protocole %>%
  filter(
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

```

```{r}
# Preparation des variables ( standardisation )
Protocole_SuiviTaleve$annee <- as.numeric(Protocole_SuiviTaleve$annee)
Protocole_SuiviTaleve$julian <- as.numeric(scale(Protocole_SuiviTaleve$julian))
Protocole_SuiviTaleve$annee2 <- as.numeric(as.character(Protocole_SuiviTaleve$annee)) - 2013
```

```{r}
#  Modèle dans le temps 
# y ~ Pois ( lambda)

modele_annee <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviTaleve)


modele_jour <- glm(nombre_min ~ julian, 
                   data = Protocole_SuiviTaleve, 
                   family = poisson)


modele_annee_jour <- glm(nombre_min ~ annee2 + julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)

modele_anneejour <- glm(nombre_min ~ annee2 * julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)



summary(modele_annee)
summary(modele_jour)
summary(modele_annee_jour)
summary(modele_anneejour)

AIC(modele_annee, modele_jour, modele_annee_jour, modele_anneejour)

```

La sélection de modèle par l'AIC a désigné la combinaison des effets temporels (année et jour julien) comme structure optimale. Ce modèle servira de base à notre analyse pour tester l'apport des variables environnementales, telles que la pluviométrie, sur l'abondance des individus.

## 3.2 Modèle d'abondance en fonction du temps et de l'environnement

```{r}
#standartisation des variables explicatives continues
Protocole_SuiviTaleve$temp_moy_glissante_31j <- as.numeric(scale(Protocole_SuiviTaleve$temp_moy_glissante_31j))
Protocole_SuiviTaleve$temp_moy_glissante_7j <- as.numeric(scale(Protocole_SuiviTaleve$temp_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_7j <- as.numeric(scale(Protocole_SuiviTaleve$pluie_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_31j <- as.numeric(scale(Protocole_SuiviTaleve$pluie_moy_glissante_31j))
```

```{r}
m_temp_7 <- glm(nombre_min ~ annee2 * julian + temp_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_temp_31 <- glm(nombre_min ~ annee2 * julian + temp_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_7 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_31<- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_temp_7 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_7j +
                        temp_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_temp_31 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_31j +
                        temp_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

AIC(m_temp_31,m_temp_7,m_pluie_7, m_pluie_31, m_pluie_temp_7, m_pluie_temp_31)
```

> La comparaison des modèles par l'AIC montre que l'intégration de la pluie moyenne glissante sur 31 jours améliore légèrement la capacité prédictive du modèle. En revanche, les variables de température n'apportent aucune amélioration supplémentaire et ne sont donc pas retenues.

Les paramètres estimés indiquent que :

-   La pluie moyenne glissante sur 31 jours n'a pas d'effet négatif significatif sur l’abondance des talèves (β = −0.179, p =0.08). Donc une variation de la quantité de pluie entre les mois n'influence pas une diminution ou augmentation du nombre d’individus

-   L’année a un effet positif significatif sur l’abondance (β = 0.155, p \< 0.001), suggérant une augmentation progressive du nombre de talèves au cours des années.

-   Le jour julien présente un effet négatif significatif (β = −0.569, p = 0.002), indiquant une diminution de l’abondance au cours de la saison ( ce qui est logique car le protocole n'est pas effectué en fin d'année )

-   L’interaction entre l’année et le jour julien est faiblement positive et significative (β = 0.059, p = 0.034), suggérant que la dynamique saisonnière varie peu d’une année à l’autre.

    Globalement, le modèle permet d’expliquer une part substantielle de la variabilité observée (déviance résiduelle = 308.28 contre une déviance nulle de 354.24), avec un AIC de 545.09.

-   La fonction pour trouver l'abondance du blongios en fonction de la pluie , de l,'année et des jours est :

    log(y) = -1.48879 + 0.15277(annee2\[i\]) - 0.59216 (julian\[i\]) -0.17924(pluie\[i\]) + 0.05917(annee\[i\]\*julian\[i\])

graphes probabilité de détection par année

```{r}
#========================
# LIBRAIRIES
#========================
library(dplyr)
library(lubridate)
library(ggplot2)
library(lme4)

#========================
# DONNEES
#========================
process_data <- read.csv("data/pro/process_protocole.csv")

#========================
# PREPARATION  # garder uniquement les lignes protocolées de talève
#========================
process_data <- process_data %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  ) %>%
  mutate(
    presence   = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee      = factor(lubridate::year(date_debut)),  # année en facteur
    j_julien   = lubridate::yday(date_debut),
    j_julien2  = j_julien^2,
    nom_lieu   = factor(nom_lieu)
  )


# ---- MODELE GLM ----
modele_phenologie <- glm(
  presence ~ j_julien + j_julien2 + annee,
  data = process_data,
  family = binomial
)

# ---- GRILLE DE PREDICTION (PAR ANNEE) ----
newdat <- process_data %>%
  group_by(annee) %>%
  summarise(
    j_julien = list(seq(min(j_julien), max(j_julien), by = 1)),
    .groups = "drop"
  ) %>%
  unnest(j_julien) %>%
  mutate(j_julien2 = j_julien^2)

# ---- PREDICTION ----
newdat$prob_detect <- predict(
  modele_phenologie,
  newdata = newdat,
  type = "response"
)

# ---- GRAPHE ----
ggplot(newdat, aes(x = j_julien, y = prob_detect, color = annee)) +
  geom_line(linewidth = 1) +
  labs(
    x = "Jour julien",
    y = "Probabilité de détection",
    color = "Année"
  ) +
  theme_minimal()


```

quelles variables font le meilleur glm (préparation au n mixture)

```{r}


#========================
# LIBRAIRIES
#========================
library(dplyr)
library(lubridate)

#========================
# DONNEES
#========================
process_data <- read.csv("data/pro/process_protocole.csv")

#========================
# PREPARATION
#========================
process_data <- process_data %>%
  mutate(
    presence = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee = factor(year(date_debut)),
    j_julien = yday(date_debut),
    j_julien2 = j_julien^2,
    mois = factor(month(date_debut, label = TRUE, abbr = FALSE)),
    nom_lieu = factor(nom_lieu)
  ) %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu",
    as.numeric(as.character(annee)) > 2013
  )

#========================
# MODELES CANDIDATS
#========================

# Modèle nul
m0 <- glm(presence ~ 1,
          data = process_data,
          family = binomial)

# Effet DATE (toujours j_julien + j_julien2)
m_date <- glm(presence ~ j_julien + j_julien2,
              data = process_data,
              family = binomial)

# Effet SITE
m_site <- glm(presence ~ nom_lieu,
              data = process_data,
              family = binomial)

# Effet ANNEE
m_annee <- glm(presence ~ annee,
               data = process_data,
               family = binomial)

# DATE + SITE
m_date_site <- glm(presence ~ j_julien + j_julien2 + nom_lieu,
                   data = process_data,
                   family = binomial)

# DATE + ANNEE
m_date_annee <- glm(presence ~ j_julien + j_julien2 + annee,
                    data = process_data,
                    family = binomial)

# SITE + ANNEE
m_site_annee <- glm(presence ~ nom_lieu + annee,
                    data = process_data,
                    family = binomial)

# DATE + SITE + ANNEE 
m_full <- glm(presence ~ j_julien + j_julien2 + nom_lieu + annee,
              data = process_data,
              family = binomial)

#========================
# COMPARAISON AIC
#========================
aic_tab <- AIC(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)

print(aic_tab)

#========================
# MEILLEUR MODELE
#========================
best_model <- list(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)[[which.min(aic_tab$AIC)]]

summary(best_model)

```
