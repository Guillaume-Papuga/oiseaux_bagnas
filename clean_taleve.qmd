---
title: "clean_taleve"
format: html
editor: visual
---

```{r setup}
knitr::opts_chunk$set(
warning = FALSE,
message = FALSE, 
echo = FALSE
)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```

#Charger les données et les library

```{r}
library(unmarked)
library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(slider)
library(leaflet)
library(sf)
library(broom)
library(ggeffects)
library(reactable)
library(DT)
library(questionr)

process_data <- read_csv("data/pro/process_data.csv")

```

## 1. analyses exploratoires de la Talève

#A- Graphique de présence des Talèves par semaine depuis 1990

Le graphique suivant représente pour chaque année (en ligne), au court de quelle semaine (en colonne) la talève a été observé et s'il s'agit d'observations opportunistes ou protocolées. Le graphique indique aussi les sorties protocolées où la talève n'a pas été observé. La ligne pointillée bleue correspond à 2014, début du protocole de point d'écoute de la talève. Celui-ci se déroule du 10 avril au 16 mai, période favorable pour la détection de mâles chanteurs.

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 

esp_taleve<- "Talève sultane, Poule sultane, Porphyrion bleu"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_taleve <- process_data %>%
  filter(nom_vernaculaire == esp_taleve) %>%
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut)
  )


# --- Résumer les semaines pour gérer les sorties multiples ---
data_taleve_summarized <- data_taleve %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)#on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs)   ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs)  ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs)  ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole
      
      # sorties protocolées sans observation = aucun oiseau vu
      any(is_protocole) & any(nombre_min == 0) ~ "sortie_sans_observation",
      
      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )


# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_taleve_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de la ", esp_taleve),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

on voit que le protocole est réalisé pendant la periode historique d'écoute et d'observation du la talève. Nous pouvons voir que la talève est présente tout au long de l'année.

#B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

Cette carte donne la localisation des points d'écoute du protocole talève et le nombre de talèves contactés (en cliquant sur les points).

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/process_protocole.csv")

process_protocole_taleve <- process_protocole %>%
  filter(nom_vernaculaire=="Talève sultane, Poule sultane, Porphyrion bleu")

#préparer les coordonnées pour R 
sites_protocole_taleve <- st_as_sf(process_protocole_taleve, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Talève par site (somme depuis 2014)

sites_protocole_taleve <- sites_protocole_taleve %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_taleve, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min,#la taille des points est proportionnelle au nombre d'oiseaux entendus
color = "red",
fillOpacity = 0.9,
popup = ~paste ((nom_lieu), ", Talèves entendues :" ,(somme_nombre_min), sep = "")
) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)



```

#C- Effort journalier des données protocoles Talève

Ce graphique représente l'effort d'échantillonnage ainsi que le nombre d'obervations cumulés au cours du protocole talève pour chaque heure de la journée de 2014 à 2025. L'effort d'échantillonnage est représenté par la somme des sorties effectuées.

```{r}
# Données 

process_protocole <- read_csv("data/pro/process_protocole.csv")
Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Protocole_Taleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Taleve <- Protocole_Taleve %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_Taleve <- Protocole_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Talève (2014-2018)")


```

En orange l'effort d'échantillonngage et en bleu le nombre de talèves observés/entendus.

#D- Effort journalier des données opportunistes Talève

Ce graphique représente le nombre cumulé d'observations opportunistes ainsi que le nombre cumulé de talèves observés de cette manière pour chaque heure de la journée entre 1997 et 2023. Les observations pour lesquelles l'heure n'était pas disponible ont été enlevées, expliquant l'intervalle temporel réduit.

```{r}
# Données 

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

Opportuniste_Taleve <- Opportuniste_Taleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Taleve <- Opportuniste_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour la Talève (2014-2018)")


```

LA couleur orange représente les observations protocolées et le bleu représente les observations opportunistes. Nous retrouvons le meme patron entre les deux types d'observations

## 2 Preparation du jeu de données et des variables

Pour les analyses de présence et d'abondance, nous utilisons uniquement les données d'observation de la talève provenant des observations protocolées. Ce jeu de données sera nommé *Protocole_SuiviTaleve*.\*\*

```{r}
#| echo: false
#| message: false
#| warning: false
process_protocole <- read.csv("data/pro/process_protocole.csv", sep = ",")
# Filtrer les relevés pour Talève sultane
Protocole_SuiviTaleve <- process_protocole %>%
filter( champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
          nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
)

datatable(head(Protocole_SuiviTaleve, 10), 
        options = list(scrollX = TRUE, pageLength = 5))

#Protocole_SuiviTaleve2<- process_protocole %>%
#  filter(
#    champs_additionnels  != "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
#     nom_vernaculaire ==
#       "Talève sultane, Poule sultane, Porphyrion bleu"
#      )
```

Le tableau résulte de la fusion d'un tableau contenant les variables environnementales (*environnement_daily*) et d'un tableau regroupant les observations de talèves.

Nous allons préparer les variables environnementales, c'est‑à‑dire les standardiser afin qu'elles ne soient pas influencées par leur unité et pour éviter une sur‑ ou sous‑dispersion.

```{r}
Protocole_SuiviTaleve$annee <- as.numeric(Protocole_SuiviTaleve$annee)
Protocole_SuiviTaleve$julian <- as.numeric(Protocole_SuiviTaleve$julian)
Protocole_SuiviTaleve$annee <- as.numeric(Protocole_SuiviTaleve$annee)
Protocole_SuiviTaleve$nom_lieu<- as.character (Protocole_SuiviTaleve$nom_lieu)
Protocole_SuiviTaleve$temp_moy_glissante_31j <- as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_31j)
Protocole_SuiviTaleve$temp_moy_glissante_7j <- as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_7j)
Protocole_SuiviTaleve$pluie_moy_glissante_7j <- as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_7j)
Protocole_SuiviTaleve$pluie_moy_glissante_31j <- as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_31j)
Protocole_SuiviTaleve$vent_moyen <- as.numeric(Protocole_SuiviTaleve$vent_moyen)
Protocole_SuiviTaleve$temperature =  as.numeric(Protocole_SuiviTaleve$temperature)
Protocole_SuiviTaleve$pluie_1h = as.numeric(Protocole_SuiviTaleve$pluie_1h)
Protocole_SuiviTaleve$Profondeur = as.numeric(Protocole_SuiviTaleve$Profondeur)
Protocole_SuiviTaleve$AssecT_1 = as.factor(Protocole_SuiviTaleve$AssecT_1)
```

# 3 . Modèle de présence/absence

Cette analyse vise à caractériser la dynamique de la population de la Talève et à déterminer l'influence relative des variables temporelles (année, date julienne) et environnementales (précipitations et temperatures) sur l'occurence observée.

```{r}

## création de la variable Occurence (1 si au moins un individu observé, 0 sinon)
Protocole_SuiviTaleve$Occurence <- ifelse(Protocole_SuiviTaleve$nombre_min > 0, 1, 0)

### Modeles emboités 


modele_null <- glm(Occurence~ annee + julian + I(julian^2)+ nom_lieu ,
                   data = Protocole_SuiviTaleve, 
                   family = binomial )

modele_complet <- glm(Occurence~ annee + julian + I(julian^2)+ nom_lieu +  temp_moy_glissante_7j + pluie_moy_glissante_7j + pluie_moy_glissante_31j+ pluie_1h + AssecT_1+ Profondeur,
                      data = Protocole_SuiviTaleve, 
                      family = binomial )
# comparaison de modeles 
AIC_tab <- AIC(
  modele_null,
  modele_complet
) %>%
  as.data.frame() %>%
  rownames_to_column("Modèle") %>%
  arrange(AIC) %>%
  mutate(
    delta_AIC = AIC - min(AIC)
  )

kable(
  AIC_tab,
  digits = 2,
  caption = "Comparaison des modèles selon le critère d'information d'Akaike (AIC)"
)

```

La sélection de modèles selon le critère d'information d'Akaike (AIC) indique que l'intégration des variables environnementales et hydrologiques n'améliore pas l'ajustement du modèle. Ces résultats suggèrent que ces facteurs ne jouent pas un rôle important dans la variation de l'abondance de la population de talèves. L'analyse est poursuivie à l'aide du modèle complet.

Les parametres estimés indiquent que :

```{r}
# Nous transformons les resultats par la l'inverse de sa fonction lien (logit) afin de pouvoir les interpreter biologiquement
transformation_logit=odds.ratio (modele_complet)
```

```{r}
extract_coef <- function(modele, var){
  c <- summary(modele)$coefficients[var, ]
  tibble(
    beta = round(c["Estimate"], 3),
    p    = round(c["Pr(>|z|)"], 3)
  )
}

annee_res <- extract_coef(modele_complet, "annee")
```

-   Année a un effet positif significatif sur l'abondance des talèves (β = `r annee_res$beta`, p = `r annee_res$p`. Donc nous avons une augmentation de l'abondance de talèves au cours des années. Le modele nous donne la chance qu'un site soit occupé par la talève augmente de `r round(((transformation_logit["annee", 'OR']-1)*100),2)`% d'une année sur l'autre

Le graphique présente l'évolution de la population de la talèves au cours du temps

```{r}
p1 <- plot(
  ggeffect(modele_complet, terms = "annee"), 
  colors = "Okabe-Ito"
) + 
  ggtitle("Évolution temporelle de l'occurrence des talèves")
p1
```

-   Le site a un effet significatif sur l'abondance des talèves. Les sites 3, 4, 5 et 7 sont significativement différents du site de référence, le site 1. Sur le graphique (fig. X), nous pouvons constater que ces sites n'ont pas d'observations. On peut supposer que ces sites ne présentent pas les conditions favorables pour accueillir la talève.

    Le graphique montre le nombre d'observations de talèves sur chaque site du protocole :

```{r}
p2 <- plot(
  ggeffect(modele_complet, terms = "nom_lieu"),
  colors = "Okabe-Ito"
) +
  ggtitle("Évolution spatiale de l'occurrence des talèves") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

p2
```

Les graphiques suivants illustrent les effets des variables pour lesquelles aucun effet significatif n'a été détecté, dans le but d'évaluer l'existence de tendances potentielles.

```{r}
p3 = plot(ggeffect(modele_complet, terms= "temp_moy_glissante_7j", residual = T))
p4 = plot(ggeffect(modele_complet, terms= "pluie_moy_glissante_7j", residual = T))
p5 = plot(ggeffect(modele_complet, terms= "pluie_moy_glissante_31j", residual = T))
p6 = plot(ggeffect(modele_complet, terms= "pluie_1h", residual = T))
p7 <- plot(ggeffect(modele_complet, terms = "AssecT_1", residuals = TRUE))
p8 = plot(ggeffect(modele_complet, terms= "Profondeur", residual = T))

p3
p4
p5
p6
p7
p8
```

À travers ces derniers graphiques, nous observons une tendance positive de la température : lorsque celle-ci augmente, l'occurrence des talèves tend également à augmenter. À l'inverse, les variables de pluviométrie moyenne sur 31 et 7 jours montrent une tendance négative, une augmentation des précipitations étant associée à une diminution de l'occurrence des talèves. En revanche, pour la pluviométrie journalière, la profondeur et l'assec, aucun effet clair ni tendance marquée sur l'occurrence des talèves ne se dégage.

```{r}
null_dev <- modele_complet$null.deviance
resid_dev <- modele_complet$deviance

pseudo_R2 <- (null_dev - resid_dev) / null_dev
```

Globalement, Le modèle indique que l'abondance des talèves est significativement influencée par le site et l'assec partiel et le temps.Le modèle explique environ 29% de la variation de l'abondance des talèves (pseudo-R² = `r pseudo_R2`), ce qui suggère que d'autres facteurs non inclus dans le protocole pourraient également jouer un rôle important dans la distribution et l'abondance de cette espèce.

## 4 . Modèle d'abondance

Cette analyse vise à caractériser la dynamique de la population de la Talève et à déterminer l'influence relative des variables temporelles (année, date julienne) et environnementales (précipitations et temperatures) sur l'abondance observée.

Nous réalisons cette analyse sur seulement les observations qui proviennent du protocole (donc pas les observations opportunistes)

```{r}
modele_null <- glm(nombre_min~ annee + julian + I(julian^2)+ nom_lieu ,
                   data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet <- glm(nombre_min~ annee + julian + I(julian^2)+ nom_lieu +  temp_moy_glissante_7j + pluie_moy_glissante_7j + pluie_moy_glissante_31j+ pluie_1h + AssecT_1+ Profondeur,
                      data = Protocole_SuiviTaleve, 
                      family = poisson )
# comparaison de modeles 
AIC_tab <- AIC(
  modele_null,
  modele_complet
) %>%
  as.data.frame() %>%
  rownames_to_column("Modèle") %>%
  arrange(AIC) %>%
  mutate(
    delta_AIC = AIC - min(AIC)
  )

kable(
  AIC_tab,
  digits = 2,
  caption = "Comparaison des modèles selon le critère d'information d'Akaike (AIC)"
)
```

La sélection de modèles selon le critère d'information d'Akaike (AIC) indique que l'intégration des variables environnementales et hydrologiques améliore significativement l'ajustement du modèle. Ces résultats suggèrent que ces facteurs jouent un rôle important dans la variation de l'abondance de la population de talèves. L'analyse est poursuivie à l'aide du modèle complet afin d'explorer les effets prédictifs des paramètres sur cette population.

Les parametres estimés indiquent que :

```{r}
extract_coef <- function(modele, var){
c <- summary(modele)$coefficients[var, ]
tibble(
  beta = round(c["Estimate"], 3),
  p    = round(c["Pr(>|z|)"], 7)
)
}

annee_res <- extract_coef(modele_complet, "annee")
```

-   Année a un effet positif significatif sur l'abondance des talèves. L'effet de l'assec sur l'abondance est négatif (β = `r annee_res$beta`, p = `r annee_res$p`). Donc nous avons une augmentation de l'abondance de talèves au cours des années. Le modele nous donne une augmentaion par année d'environ `r exp(annee_res$beta)`de talèves dans la reserve independamment des facteurs etudiés dans le modèle

Le graphique présente l'évolution de la population de la talèves au cours du temps

```{r}
p1 <- plot(ggeffect(modele_complet, terms= "annee", residual = T))
p1
```

```{r}
extract_coef <- function(modele, var){
  c <- summary(modele)$coefficients[var, ]
  tibble(
    beta = round(c["Estimate"], 3),
    p    = round(c["Pr(>|z|)"], 7)
  )
}

assec_res <- extract_coef(modele_complet, "AssecT_1total")
```

-   L'effet de l'assec sur l'abondance est négatif (β = `r assec_res$beta`, p = `r assec_res$p`). Donc les evenements d'assec ont un impact négatif qui fait diminuer la popualtion de taleves d'environ `r exp(assec_res$beta)` par rapport à l'année précedente.

    Nous ne pouvons pas mettre en évidence un effet de l'assec partiel sur la population de talèves, celui-ci n'ayant eu lieu qu'en 2022. De plus, le protocole de suivi n'a pas été appliqué selon la périodicité habituelle de deux ans, ce qui limite la capacité à détecter un effet éventuel.

Le graphique présente l'évolution de la population de la talèves en fonction au cours des années

```{r}
p2 <- plot(
  ggeffect(modele_complet, terms = "AssecT_1"),
  colors = "Okabe-Ito"
) +
  ggtitle("Évolution de l'abondance des talèves en fonction des assec") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

p2
```

-   Le site a un effet significatif sur l'abondance des talèves. Les sites 3, 4, 5 et 7 sont significativement différents du site de référence, le site 1. Sur le graphique (fig. X), nous pouvons constater que ces sites n'ont pas d'observations. On peut supposer que ces sites ne présentent pas les conditions favorables pour accueillir la talève.

-   Le graphique montre le nombre d'observations de talèves sur chaque site du protocole :

```{r}
p3 = plot(ggeffect(modele_complet, terms= "nom_lieu", residual = T))
p3
```

```{r}
null_dev <- modele_complet$null.deviance
resid_dev <- modele_complet$deviance

pseudo_R2 <- (null_dev - resid_dev) / null_dev
```

Globalement, Le modèle indique que l'abondance des talèves est significativement influencée par le site et l'assec partiel et le temps.Le modèle explique environ 43 % de la variation de l'abondance des talèves (pseudo-R² = `r pseudo_R2`), ce qui suggère que d'autres facteurs non inclus dans le protocole pourraient également jouer un rôle important dans la distribution et l'abondance de cette espèce.

------------------------------------------------------------------------

graphe probabilité de présence de la talève sur la réserve

Ce graphique permet de déterminer la probabilité d'occurence de la talève sur la réserve. La probabilité est calculée en faisant le ration des sorties avec observations sur les sorties sans observations. Seules les observations protocolées sont prises en compte

```{r}
#=======================
# LIBRAIRIES
#=======================
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lme4)

#========================
# DONNEES
#========================
#process_data <- read.csv("process_protocole.csv")

#========================
# PREPARATION
# Garder uniquement les lignes protocolées de Talève
# ET supprimer l'année 2018
#========================
process_data <- process_data %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  ) %>%
  mutate(
    presence   = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee      = factor(lubridate::year(date_debut)),  # année en facteur
    j_julien   = lubridate::yday(date_debut),
    j_julien2  = j_julien^2,
    nom_lieu   = factor(nom_lieu)
  ) %>%
  filter(annee != 2018)   # suppression définitive de 2018

#========================
# MODELE GLM
#========================
modele_phenologie <- glm(
  presence ~ j_julien + j_julien2 + annee,
  data = process_data,
  family = binomial
)

summary(modele_phenologie)

#========================
# GRILLE DE PREDICTION
#========================
newdat <- process_data %>%
  group_by(annee) %>%
  summarise(
    j_julien = list(seq(min(j_julien), max(j_julien), by = 1)),
    .groups = "drop"
  ) %>%
  unnest(j_julien) %>%
  mutate(j_julien2 = j_julien^2)

#========================
# PREDICTION AVEC INTERVALLES DE CONFIANCE
#========================
pred <- predict(
  modele_phenologie,
  newdata = newdat,
  type = "link",        # échelle logit
  se.fit = TRUE
)

newdat <- newdat %>%
  mutate(
    fit         = pred$fit,
    se_fit      = pred$se.fit,
    prob_detect = plogis(fit),
    prob_lower  = plogis(fit - 1.96 * se_fit),
    prob_upper  = plogis(fit + 1.96 * se_fit)
  )

#========================
# GRAPHE AVEC INTERVALLES
#========================
ggplot(newdat, aes(x = j_julien, y = prob_detect, color = annee, fill = annee)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = prob_lower, ymax = prob_upper), alpha = 0.2, color = NA) +
  labs(
    x = "Jour julien",
    y = "Probabilité de présence",
    color = "Année",
    fill  = "Année"
  ) +
  theme_minimal()

```

La probabilité d'occurence de la talève est plus élevée dans les dernières années de protocole (2019, 2021, 2023) que pendant la première, en 2014. L'espèce semble bien coloniser la réserve du bagnat depuis au moins 2014.

quelles variables font le meilleur glm (préparation au n mixture)

```{r}


#========================
# LIBRAIRIES
#========================
library(dplyr)
library(lubridate)

#========================
# DONNEES
#========================
process_data <- read.csv("data/pro/process_protocole.csv")

#========================
# PREPARATION
#========================
process_data <- process_data %>%
  mutate(
    presence = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee = factor(year(date_debut)),
    j_julien = yday(date_debut),
    j_julien2 = j_julien^2,
    mois = factor(month(date_debut, label = TRUE, abbr = FALSE)),
    nom_lieu = factor(nom_lieu)
  ) %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu",
    as.numeric(as.character(annee)) > 2013
  )

#========================
# MODELES CANDIDATS
#========================

# Modèle nul
m0 <- glm(presence ~ 1,
          data = process_data,
          family = binomial)

# Effet DATE (toujours j_julien + j_julien2)
m_date <- glm(presence ~ j_julien + j_julien2,
              data = process_data,
              family = binomial)

# Effet SITE
m_site <- glm(presence ~ nom_lieu,
              data = process_data,
              family = binomial)

# Effet ANNEE
m_annee <- glm(presence ~ annee,
               data = process_data,
               family = binomial)

# DATE + SITE
m_date_site <- glm(presence ~ j_julien + j_julien2 + nom_lieu,
                   data = process_data,
                   family = binomial)

# DATE + ANNEE
m_date_annee <- glm(presence ~ j_julien + j_julien2 + annee,
                    data = process_data,
                    family = binomial)

# SITE + ANNEE
m_site_annee <- glm(presence ~ nom_lieu + annee,
                    data = process_data,
                    family = binomial)

# DATE + SITE + ANNEE 
m_full <- glm(presence ~ j_julien + j_julien2 + nom_lieu + annee,
              data = process_data,
              family = binomial)

#========================
# COMPARAISON AIC
#========================
aic_tab <- AIC(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)

print(aic_tab)

#========================
# MEILLEUR MODELE
#========================
best_model <- list(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)[[which.min(aic_tab$AIC)]]

summary(best_model)

```

Modèle N-Mixture

```{r}

Protocole_SuiviTaleve <- process_protocole %>%
  filter( champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )


tableau_addition_site <- Protocole_SuiviTaleve %>%
  group_by(date_debut, temp_moy_glissante_7j, pluie_1h, pluie_moy_glissante_7j, pluie_moy_glissante_31j,AssecT_1, Profondeur, vent_moyen) %>%
  summarise(
    total_obs = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )


tableau_addition_site$annee <- as.numeric(format(tableau_addition_site$date_debut, "%Y"))
tableau_addition_site <- tableau_addition_site[-c(1,3,5,7,9), ]

tableau_repet <- tableau_addition_site %>%
  arrange(annee, date_debut) %>%
  group_by(annee) %>%
  mutate(passage = row_number()) %>%
  ungroup()


tableau_ready<- tableau_repet %>%
  select(annee, passage, total_obs,temp_moy_glissante_7j, pluie_1h, pluie_moy_glissante_7j, pluie_moy_glissante_31j, AssecT_1, Profondeur, vent_moyen) %>%
  pivot_wider(
    names_from = passage,
    values_from = total_obs,
    names_prefix = "passage_"
  )

df_long <- tableau_ready %>% 
  pivot_longer(
    cols = starts_with("passage_"),
    names_to = "passage",
    values_to = "count"
  ) %>%
  filter(!is.na(count)) %>%
  mutate(
    passage = as.numeric(gsub("passage_", "", passage))
  )
  
  
counts <- df_long %>%
  select(annee, passage, count) %>%
  pivot_wider(
    names_from = passage,
    values_from = count,
    names_prefix = "passage_"
  ) %>%
  arrange(annee)
  
counts_mat <- as.matrix(counts[, -1])
rownames(counts_mat) <- counts$annee
  
  
obs_covs <- df_long %>%
  select(annee, passage,
         temp_moy_glissante_7j,
         pluie_1h,
         pluie_moy_glissante_7j,
         pluie_moy_glissante_31j,
         Profondeur,
         AssecT_1, 
         vent_moyen) %>%
  pivot_wider(
    names_from = passage,
    values_from = c(
      temp_moy_glissante_7j,
      pluie_1h,
      pluie_moy_glissante_7j,
      pluie_moy_glissante_31j, 
      Profondeur, 
      AssecT_1,
      vent_moyen
    ),
    names_sep = "_passage_"
  ) %>%
  arrange(annee)


df_final <- counts %>%
  left_join(obs_covs, by = "annee")

df_final <- df_final[-c(3), ] #on enlève l'année 2018 car il n'y a qu'1 passage
df_final <- df_final [, -c(27,28,29)]


df_final <- df_final %>%
  rename(assec = AssecT_1_passage_1)


taleve_nmixture<-unmarkedFramePCount(comptage)

#1 : modèle null : pas de covariables
T_count_null <- pcount(~ 1 ~1 , taleve_nmixture, K = 100) # detection, then abundance
summary(T_count_null)


names(T_count_null)
backTransform(T_count_null, "state")
backTransform(T_count_null, "det")

predict(T_count_null, type="state")
predict(T_count_null, type="det")

ranef(T_count_null) # abondance corrigée par la detection



```
