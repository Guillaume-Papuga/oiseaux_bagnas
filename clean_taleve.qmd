---
title: "clean_taleve"
format: html
editor: visual
---

```{r setup}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE, 
  echo = FALSE
)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```

#Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(slider)
library(leaflet)
library(sf)
library(broom)
library(ggeffects)


process_data <- read_csv("data/pro/process_data.csv")

```

## 1. analyses exploratoires de la Talève

#A- Graphique de présence des Talèves par semaine depuis 1990

Le graphique suivant représente pour chaque année (en ligne), au court de quelle semaine (en colonne) la talève a été observé et s’il s’agit d’observations opportunistes ou protocolées. Le graphique indique aussi les sorties protocolées où la talève n’a pas été observé. La ligne pointillée bleue correspond à 2014, début du protocole de point d’écoute de la talève. Celui-ci se déroule du 10 avril au 16 mai, période favorable pour la détection de mâles chanteurs.

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 

esp_taleve<- "Talève sultane, Poule sultane, Porphyrion bleu"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_taleve <- process_data %>%
  filter(nom_vernaculaire == esp_taleve) %>%
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut)
  )


# --- Résumer les semaines pour gérer les sorties multiples ---
data_taleve_summarized <- data_taleve %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)#on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # observations présentes
       # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole
      
      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )


# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_taleve_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de la ", esp_taleve),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

on voit que le protocole est réalisé pendant la periode historique d'écoute et d'observation du la talève. Nous pouvons voir que la talève est présente tout au long de l'année.

#B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

Cette carte donne la localisation des points d’écoute du protocole talève et le nombre de talèves contactés (en cliquant sur les points).

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("data/process_protocole.csv")

process_protocole_taleve <- process_protocole %>%
  filter(nom_vernaculaire=="Talève sultane, Poule sultane, Porphyrion bleu")

#préparer les coordonnées pour R 
sites_protocole_taleve <- st_as_sf(process_protocole_taleve, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Talève par site (somme depuis 2014)

sites_protocole_taleve <- sites_protocole_taleve %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_taleve, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min,#la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Talèves entendues :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)



```

#C- Effort journalier des données protocoles Talève

Ce graphique représente l’effort d’échantillonnage ainsi que le nombre d’obervations cumulés au cours du protocole talève pour chaque heure de la journée de 2014 à 2025. L’effort d’échantillonnage est représenté par la somme des sorties effectuées.

```{r}
# Données 

process_protocole <- read_csv("data/pro/process_protocole.csv")
Taleve_sultane<-process_data %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )

Protocole_Taleve <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Taleve <- Protocole_Taleve %>% filter( nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu")

Protocole_Taleve <- Protocole_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Talève (2014-2018)")


```

En orange l'effort d'échantillonngage et en bleu le nombre de talèves observés/entendus.

#D- Effort journalier des données opportunistes Talève

Ce graphique représente le nombre cumulé d’observations opportunistes ainsi que le nombre cumulé de talèves observés de cette manière pour chaque heure de la journée entre 1997 et 2023. Les observations pour lesquelles l’heure n’était pas disponible ont été enlevées, expliquant l’intervalle temporel réduit.

```{r}
# Données 

opportuniste <- process_data %>%
  filter(
    !champs_additionnels %in% c(
      "{'RELV_NOM': 'SuiviBlongiostaleve'}",
      "{'RELV_NOM': 'SuiviButor'}"
    )
  )

Opportuniste_Taleve<- process_data %>%
  filter(
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiostaleve'}" &
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

Opportuniste_Taleve <- Opportuniste_Taleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )


Opportuniste_Taleve <- Opportuniste_Taleve  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%d/%m/%Y %H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Opportuniste_Taleve %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Opportuniste_Taleve %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23)
  )
 
### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations opportuniste\n par heure pour la Talève (2014-2018)")


```

LA couleur orange représente les observations protocolées et le bleu représente les observations opportunistes. Nous retrouvons le meme patron entre les deux types d'observations

## 2 Preparation du jeu de données et des variables

Pour les analyses de présence et d’abondance, nous utilisons uniquement les données d’observation de la talève provenant des observations protocolées. Ce jeu de données sera nommé *Protocole_SuiviTaleve*.\*\*

```{r}
#| echo: false
#| message: false
#| warning: false
process_protocole <- read.csv("data/pro/process_protocole.csv", sep = ",")
# Filtrer les relevés pour Talève sultane
Protocole_SuiviTaleve <- process_protocole %>%
  filter(
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )
head(Protocole_SuiviTaleve)
```

Le tableau résulte de la fusion d’un tableau contenant les variables environnementales (*environnement_daily*) et d’un tableau regroupant les observations de talèves.

Nous allons préparer les variables environnementales, c’est‑à‑dire les standardiser afin qu’elles ne soient pas influencées par leur unité et pour éviter une sur‑ ou sous‑dispersion.

```{r}
Protocole_SuiviTaleve$annee <- as.numeric(Protocole_SuiviTaleve$annee)
Protocole_SuiviTaleve$julian <- as.numeric(Protocole_SuiviTaleve$julian)
Protocole_SuiviTaleve$annee2 <- as.numeric(as.character(Protocole_SuiviTaleve$annee)) - 2013
Protocole_SuiviTaleve$nom_lieu<- as.character (Protocole_SuiviTaleve$nom_lieu)
Protocole_SuiviTaleve$temp_moy_glissante_31j <- scale(as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_31j))
Protocole_SuiviTaleve$temp_moy_glissante_7j <- scale(as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_7j <- scale(as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_31j <- scale(as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_31j))
Protocole_SuiviTaleve$vent_moyen <- scale(as.numeric(Protocole_SuiviTaleve$vent_moyen))
Protocole_SuiviTaleve$temperature = scale (as.numeric(Protocole_SuiviTaleve$temperature))
Protocole_SuiviTaleve$pluie_1h = scale (as.numeric(Protocole_SuiviTaleve$pluie_1h))
Protocole_SuiviTaleve$Profondeur = scale(as.numeric(Protocole_SuiviTaleve$Profondeur))
Protocole_SuiviTaleve$AssecT_1 = as.factor((Protocole_SuiviTaleve$AssecT_1))
```

##2 . Modèle de présence/absence

```{r}

## création de la variable Occurence (1 si au moins un individu observé, 0 sinon)
Protocole_SuiviTaleve$Occurence <- ifelse(Protocole_SuiviTaleve$nombre_min > 0, 1, 0)

### Modeles emboités 


modele_complet_site <- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_anneesite <- glm(Occurence~ annee2*nom_lieu + julian + I(julian^2),
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_site <- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_vent <- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_temp_31 <- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_31j+ vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_temp_7j <- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_7j+ vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_temp_1j<- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + temperature,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_temp_1j_vent<- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + temperature + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_pluie_31j_vent<- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_moy_glissante_31j + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_pluie_7j_vent<- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_moy_glissante_7j + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )
modele_complet_pluie_1j_vent<- glm(Occurence~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_1h + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = binomial )


AIC_tab <- AIC(modele_complet_site, modele_complet_anneesite, modele_complet_vent , modele_complet_temp_31, modele_complet_temp_7j, 
modele_complet_temp_1j, modele_complet_temp_1j_vent, modele_complet_pluie_31j_vent, modele_complet_pluie_7j_vent, modele_complet_pluie_1j_vent)

AIC_tab

## meilleur modèle selon AIC

p1 <- plot(ggeffect(modele_complet_pluie_31j_vent, terms= "pluie_moy_glissante_31j  ", residual = T))


p2 = plot(ggeffect(modele_complet_pluie_31j_vent, terms= "annee2", residual = T))


p3 = plot(ggeffect(modele_complet_pluie_31j_vent, terms= "nom_lieu", residual = T))

#### Affichage 

p1
p2
p3


```

##2.1 Interpretation

Le modèle GLM explorant la présence de la Talève sultane en fonction du temps, de la profondeur et de l’assec de l’année précédente montre que la profondeur moyenne a un effet significatif positif sur la probabilité de présence (Estimate = 2,19, p = 0,035). Les variables temporelles (date julienne et son terme quadratique) ne sont pas significatives (p ≈ 0,09–0,10), indiquant que la présence de l’espèce n’évolue pas de façon marquée au cours de la période 2014–2024. Les effets de l’assec de l’année précédente sont faibles et non significatifs, avec un assec partiel ayant un effet légèrement négatif et un assec total un effet légèrement positif (p ≈ 0,17–0,08).

## 3 . Modèle d'abondance

Cette analyse vise à caractériser la dynamique de la population de la Talève et à déterminer l'influence relative des variables temporelles (année, date julienne) et environnementales (précipitations et temperatures) sur l'abondance observée.

## 3.1 Modèle d'abondance en fonction du temps

Nous réalisons cette analyse sur seulement les observations qui proviennent du protocole (donc pas les observations opportunistes)

```{r}
modele_annee <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviTaleve)


modele_julian <- glm(nombre_min ~ julian, 
                   data = Protocole_SuiviTaleve, 
                   family = poisson)


modele_annee_julian <- glm(nombre_min ~ annee2 + julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)

modele_anneejulian <- glm(nombre_min ~ annee2 * julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)
modele_julian2 <- glm(nombre_min ~ julian + I(julian^2), 
                   data = Protocole_SuiviTaleve, 
                   family = poisson)

modele_julian2annee <- glm(nombre_min ~ julian*annee2 + I(julian^2),
                   data = Protocole_SuiviTaleve, 
                   family = poisson)
##### Modeles complets 
modele_julian2_annee <- glm(nombre_min ~ julian + I(julian^2)+annee2,
                   data = Protocole_SuiviTaleve, 
                   family = poisson)
modele_complet_site <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviTaleve, 
                   family = poisson ) # meilleur AIC avec le model interaction mais le nombre de parametres largement plus faible (12 < 20 ) donc on le prend
modele_complet_anneesite <- glm(nombre_min~ annee2*nom_lieu + julian + I(julian^2),
                        data = Protocole_SuiviTaleve, 
                   family = poisson )
modele_complet_site <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

#####   avec variable enviro

modele_complet_vent <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )


modele_complet_temp_31 <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_31j+ vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_temp_7j <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_7j+ vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_temp_1j<- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + temperature,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_temp_1j_vent<- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + temperature + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_pluie_31j_vent<- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_moy_glissante_31j + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_pluie_7j_vent<- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_moy_glissante_7j + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )
modele_complet_pluie_1j_vent<- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + pluie_1h + vent_moyen,
                        data = Protocole_SuiviTaleve, 
                   family = poisson )

modele_complet_assec <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + vent_moyen + AssecT_1,
                           data = Protocole_SuiviTaleve, 
                           family = poisson )
                           

modele_complet_profondeur <- glm(nombre_min~ annee2 + julian + I(julian^2)+ nom_lieu + vent_moyen + Profondeur,
                           data = Protocole_SuiviTaleve, 
                           family = poisson )


# Selection du meilleur model avec l'AIC 
AIC_tab <- AIC(
  modele_annee,
  modele_julian,
  modele_annee_julian,
  modele_anneejulian,
  modele_julian2,
  modele_julian2annee,
  modele_julian2_annee,
  modele_complet_site,
  modele_complet_anneesite,
  modele_complet_vent,
  modele_complet_temp_31,
  modele_complet_temp_7j,
  modele_complet_temp_1j,
  modele_complet_temp_1j_vent,
  modele_complet_pluie_31j_vent,
  modele_complet_pluie_7j_vent,
  modele_complet_pluie_1j_vent,
  modele_complet_profondeur,
  modele_complet_assec
) %>%
  as.data.frame() %>%
  rownames_to_column("Modèle") %>%
  arrange(AIC) %>%
  mutate(
    delta_AIC = AIC - min(AIC)
  )

kable(
  AIC_tab,
  digits = 2,
  caption = "Comparaison des modèles selon le critère d'information d'Akaike (AIC)"
)

```

La sélection de modèles basée sur le critère d’information d’Akaike (AIC) a mis en évidence qu’un modèle intégrant les effets temporels (année et jour julien), un effet spatial lié au site, ainsi que des variables environnementales locales (vitesse moyenne du vent et conditions d’assec) constitue la structure la plus parcimonieuse pour expliquer la variation de l’occurrence des individus. Ce modèle a donc été retenu comme base pour l’analyse, afin d’évaluer l’influence conjointe des facteurs temporels, spatiaux et environnementaux sur l'abondance des individus

Les parametres estimés indiquent que :

```{r}
extract_coef <- function(modele, var){
  c <- summary(modele)$coefficients[var, ]
  tibble(
    beta = round(c["Estimate"], 3),
    p    = round(c["Pr(>|z|)"], 7)
  )
}

assec_res <- extract_coef(modele_complet_assec, "AssecT_1partiel")
```

-   L’assec partiel a un effet négatif significatif sur l’abondance des talèves. L’effet de l’assec sur l’abondance est négatif (β = `r assec_res$beta`, p = `r assec_res$p`). En revanche, un assec total ne montre aucun effet significatif sur l’abondance des talèves (fig X) . On peut imaginer que le nombre limité d’assec total n’est pas valorisé en raison de sa faible fréquence de présence.

Le graphique présente l'évolution de la population de la talèves en fonction des differents modalités du niveau de l'eau ( assec total , assec partiel , absence d'assec )

```{r}
p1 <- plot(ggeffect(modele_complet_assec, terms= "AssecT_1", residual = T))
p1
```

```{r}
extract_coef <- function(modele, var){
  c <- summary(modele)$coefficients[var, ]
  tibble(
    beta = round(c["Estimate"], 3),
    p    = round(c["Pr(>|z|)"], 7)
  )
}

annee_res <- extract_coef(modele_complet_assec, "annee2")
```

-   Année a un effet positif significatif sur l’abondance des talèves. L’effet de l’assec sur l’abondance est négatif (β = `r annee_res$beta`, p = `r annee_res$p`). Donc nous avons une augmentation de l'abondance de talèves au cours des années. Le modele nous donne une augmentaion par année d'environ `r exp(annee_res$beta)`de talèves dans la reserve independamment des facteurs etudiés dans le modèle

Le graphique présente l'évolution de la population de la talèves en fonction au cours des années

```{r}
p2 = plot(ggeffect(modele_complet_assec, terms= "annee2", residual = T))
p2
```

-   Le site a un effet significatif sur l’abondance des talèves. Les sites 3, 4, 5 et 7 sont significativement différents du site de référence, le site 1. Sur le graphique (fig. X), nous pouvons constater que ces sites n’ont pas d’observations. On peut supposer que ces sites ne présentent pas les conditions favorables pour accueillir la talève.

-   Le graphique montre l’évolution des observations de la talève sur chaque site du protocole :

```{r}
p3 = plot(ggeffect(modele_complet_assec, terms= "nom_lieu", residual = T))
p3
```

```{r}
null_dev <- modele_complet_assec$null.deviance
resid_dev <- modele_complet_assec$deviance

pseudo_R2 <- (null_dev - resid_dev) / null_dev
pseudo_R2
```

Globalement, Le modèle indique que l’abondance des talèves est significativement influencée par le site et l’assec partiel et le temps.Le modèle explique environ 40 % de la variation de l’abondance des talèves (pseudo-R² = `r pseudo_R2`), ce qui suggère que d’autres facteurs non inclus dans le protocole pourraient également jouer un rôle important dans la distribution et l’abondance de cette espèce.

graphes probabilité d'occurence par année SANS IC

```{r}

#=======================
# LIBRAIRIES
#=======================
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lme4)

#========================
# DONNEES
#========================
process_data <- read.csv("process_protocole.csv")

#========================
# PREPARATION
# garder uniquement les lignes protocolées de talève
# ET supprimer l'année 2018
#========================
process_data <- process_data %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  ) %>%
  mutate(
    presence   = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee      = lubridate::year(date_debut),
    j_julien   = lubridate::yday(date_debut),
    j_julien2  = j_julien^2,
    nom_lieu   = factor(nom_lieu)
  ) %>%
  filter(annee != 2018)   # ⬅️ suppression définitive de 2018

#========================
# MODELE GLM
#========================
modele_phenologie <- glm(
  presence ~ j_julien + j_julien2 + annee,
  data = process_data,
  family = binomial
)

summary(modele_phenologie)

#========================
# GRILLE DE PREDICTION
#========================
newdat <- process_data %>%
  group_by(annee) %>%
  summarise(
    j_julien = list(seq(min(j_julien), max(j_julien), by = 1)),
    .groups = "drop"
  ) %>%
  unnest(j_julien) %>%
  mutate(j_julien2 = j_julien^2)

#========================
# PREDICTION
#========================
newdat$prob_detect <- predict(
  modele_phenologie,
  newdata = newdat,
  type = "response"
)

#========================
# GRAPHE
#========================
ggplot(newdat, aes(x = j_julien, y = prob_detect, color = factor(annee))) +
  geom_line(linewidth = 1) +
  labs(
    x = "Jour julien",
    y = "Probabilité de détection",
    color = "Année"
  ) +
  theme_minimal()


```

graphe proba occurence AVEC IC

```{r}

#=======================
# LIBRAIRIES
#=======================
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lme4)

#========================
# DONNEES
#========================
process_data <- read.csv("process_protocole.csv")

#========================
# PREPARATION
# garder uniquement les lignes protocolées de talève
# ET supprimer l'année 2018
#========================
process_data <- process_data %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  ) %>%
  mutate(
    presence   = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee      = lubridate::year(date_debut),
    j_julien   = lubridate::yday(date_debut),
    j_julien2  = j_julien^2,
    nom_lieu   = factor(nom_lieu)
  ) %>%
  filter(annee != 2018)   # ⬅️ suppression définitive de 2018

#========================
# MODELE GLM
#========================
modele_phenologie <- glm(
  presence ~ j_julien + j_julien2 + annee,
  data = process_data,
  family = binomial
)

summary(modele_phenologie)

#========================
# GRILLE DE PREDICTION
#========================
newdat <- process_data %>%
  group_by(annee) %>%
  summarise(
    j_julien = list(seq(min(j_julien), max(j_julien), by = 1)),
    .groups = "drop"
  ) %>%
  unnest(j_julien) %>%
  mutate(j_julien2 = j_julien^2)

#========================
# PREDICTION
#========================
newdat$prob_detect <- predict(
  modele_phenologie,
  newdata = newdat,
  type = "response"
)

#========================
# GRAPHE
#========================
ggplot(newdat, aes(x = j_julien, y = prob_detect, color = factor(annee))) +
  geom_line(linewidth = 1) +
  labs(
    x = "Jour julien",
    y = "Probabilité de détection",
    color = "Année"
  ) +
  theme_minimal()

#graphe proba occ taleve avec intervalle 
#=======================
# LIBRAIRIES
#=======================
library(dplyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(lme4)

#========================
# DONNEES
#========================
process_data <- read.csv("process_protocole.csv")

#========================
# PREPARATION
# Garder uniquement les lignes protocolées de Talève
# ET supprimer l'année 2018
#========================
process_data <- process_data %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  ) %>%
  mutate(
    presence   = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee      = factor(lubridate::year(date_debut)),  # année en facteur
    j_julien   = lubridate::yday(date_debut),
    j_julien2  = j_julien^2,
    nom_lieu   = factor(nom_lieu)
  ) %>%
  filter(annee != 2018)   # suppression définitive de 2018

#========================
# MODELE GLM
#========================
modele_phenologie <- glm(
  presence ~ j_julien + j_julien2 + annee,
  data = process_data,
  family = binomial
)

summary(modele_phenologie)

#========================
# GRILLE DE PREDICTION
#========================
newdat <- process_data %>%
  group_by(annee) %>%
  summarise(
    j_julien = list(seq(min(j_julien), max(j_julien), by = 1)),
    .groups = "drop"
  ) %>%
  unnest(j_julien) %>%
  mutate(j_julien2 = j_julien^2)

#========================
# PREDICTION AVEC INTERVALLES DE CONFIANCE
#========================
pred <- predict(
  modele_phenologie,
  newdata = newdat,
  type = "link",        # échelle logit
  se.fit = TRUE
)

newdat <- newdat %>%
  mutate(
    fit         = pred$fit,
    se_fit      = pred$se.fit,
    prob_detect = plogis(fit),
    prob_lower  = plogis(fit - 1.96 * se_fit),
    prob_upper  = plogis(fit + 1.96 * se_fit)
  )

#========================
# GRAPHE AVEC INTERVALLES
#========================
ggplot(newdat, aes(x = j_julien, y = prob_detect, color = annee, fill = annee)) +
  geom_line(linewidth = 1) +
  geom_ribbon(aes(ymin = prob_lower, ymax = prob_upper), alpha = 0.2, color = NA) +
  labs(
    x = "Jour julien",
    y = "Probabilité de détection",
    color = "Année",
    fill  = "Année"
  ) +
  theme_minimal()
```

quelles variables font le meilleur glm (préparation au n mixture)

```{r}


#========================
# LIBRAIRIES
#========================
library(dplyr)
library(lubridate)

#========================
# DONNEES
#========================
process_data <- read.csv("data/pro/process_protocole.csv")

#========================
# PREPARATION
#========================
process_data <- process_data %>%
  mutate(
    presence = ifelse(nombre_min > 0, 1, 0),
    date_debut = as.Date(date_debut),
    annee = factor(year(date_debut)),
    j_julien = yday(date_debut),
    j_julien2 = j_julien^2,
    mois = factor(month(date_debut, label = TRUE, abbr = FALSE)),
    nom_lieu = factor(nom_lieu)
  ) %>%
  filter(
    grepl("SuiviBlongiosTalève", champs_additionnels),
    nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu",
    as.numeric(as.character(annee)) > 2013
  )

#========================
# MODELES CANDIDATS
#========================

# Modèle nul
m0 <- glm(presence ~ 1,
          data = process_data,
          family = binomial)

# Effet DATE (toujours j_julien + j_julien2)
m_date <- glm(presence ~ j_julien + j_julien2,
              data = process_data,
              family = binomial)

# Effet SITE
m_site <- glm(presence ~ nom_lieu,
              data = process_data,
              family = binomial)

# Effet ANNEE
m_annee <- glm(presence ~ annee,
               data = process_data,
               family = binomial)

# DATE + SITE
m_date_site <- glm(presence ~ j_julien + j_julien2 + nom_lieu,
                   data = process_data,
                   family = binomial)

# DATE + ANNEE
m_date_annee <- glm(presence ~ j_julien + j_julien2 + annee,
                    data = process_data,
                    family = binomial)

# SITE + ANNEE
m_site_annee <- glm(presence ~ nom_lieu + annee,
                    data = process_data,
                    family = binomial)

# DATE + SITE + ANNEE 
m_full <- glm(presence ~ j_julien + j_julien2 + nom_lieu + annee,
              data = process_data,
              family = binomial)

#========================
# COMPARAISON AIC
#========================
aic_tab <- AIC(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)

print(aic_tab)

#========================
# MEILLEUR MODELE
#========================
best_model <- list(
  m0,
  m_date,
  m_site,
  m_annee,
  m_date_site,
  m_date_annee,
  m_site_annee,
  m_full
)[[which.min(aic_tab$AIC)]]

summary(best_model)

```
