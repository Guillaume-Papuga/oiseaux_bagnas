---
title: "clean_taleve"
format: html
editor: visual
---

#Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)

setwd("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro")
process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")

```

## 1. analyses exploratoires de la Talève

#A- Graphique de présence des Talèves par semaine depuis 1990

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 

esp_taleve<- "Talève sultane, Poule sultane, Porphyrion bleu"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

data_taleve <- process_data %>%
  filter(nom_vernaculaire == esp_taleve) %>%
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut)
  )


# --- Résumer les semaines pour gérer les sorties multiples ---
data_taleve_summarized <- data_taleve %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)#on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
      # observations présentes
       # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole",  #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole
      
      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )


# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_taleve_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique 
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de la ", esp_taleve),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

#B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

process_protocole_taleve <- process_protocole %>%
  filter(nom_vernaculaire=="Talève sultane, Poule sultane, Porphyrion bleu")

#préparer les coordonnées pour R 
sites_protocole_taleve <- st_as_sf(process_protocole_taleve, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Talève par site (somme depuis 2014)

sites_protocole_taleve <- sites_protocole_taleve %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )

#leaflet est un package pour projeter des infos sur une carte
leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_taleve, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min,#la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Talèves entendues :" ,(somme_nombre_min), sep = "")
  ) %>%
  setView(lng = 3.51, lat = 43.31, zoom = 13)



```

#C- Les heures de la journée où sont vu les Talèves

```{r}

```

#D- évolution de l'abondance de Talève dans le temps

```{r}

```

##2 . Modèle de présence/absence

##3 . Modèle d'abondance

```{r}

# Filtrer les relevés pour Talève sultane
Protocole_SuiviTaleve <- process_protocole %>%
  filter(
      nom_vernaculaire == "Talève sultane, Poule sultane, Porphyrion bleu"
  )

```

```{r}
# Preparation des variables ( standardisation )
Protocole_SuiviTaleve$annee <- as.numeric(Protocole_SuiviTaleve$annee)
Protocole_SuiviTaleve$julian <- scale(as.numeric(Protocole_SuiviTaleve$julian))
Protocole_SuiviTaleve$annee2 <- as.numeric(as.character(Protocole_SuiviTaleve$annee)) - 2013
```

```{r}
#  Modèle dans le temps 
# y ~ Pois ( lambda)

modele_annee <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviTaleve)


modele_jour <- glm(nombre_min ~ julian, 
                   data = Protocole_SuiviTaleve, 
                   family = poisson)


modele_annee_jour <- glm(nombre_min ~ annee2 + julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)

modele_anneejour <- glm(nombre_min ~ annee2 * julian, 
                         data = Protocole_SuiviTaleve, 
                         family = poisson)



summary(modele_annee)
summary(modele_jour)
summary(modele_annee_jour)
summary(modele_anneejour)

AIC(modele_annee, modele_jour, modele_annee_jour, modele_anneejour)

```

::: callout-note
:::

::: callout-note
:::

::: callout-note
## Interprétation

Le meilleur modele d'apres l'AIC est le modele avec la combinaison de l'effet de l'année et du jour

Nous allons garder ce modele pour la suite de l'analyse afin de tester les variables environnementales
:::

On rajoute les variables environnementales dans nos modeles

```{r}
#standartisation des variables explicatives continues
Protocole_SuiviTaleve$temp_moy_glissante_31j <- scale(as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_31j))
Protocole_SuiviTaleve$temp_moy_glissante_7j <- scale(as.numeric(Protocole_SuiviTaleve$temp_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_7j <- scale(as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_7j))
Protocole_SuiviTaleve$pluie_moy_glissante_31j <- scale(as.numeric(Protocole_SuiviTaleve$pluie_moy_glissante_31j))
```

```{r}
m_temp_7 <- glm(nombre_min ~ annee2 * julian + temp_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_temp_31 <- glm(nombre_min ~ annee2 * julian + temp_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_7 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_31<- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_temp_7 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_7j +
                        temp_moy_glissante_7j,
          data = Protocole_SuiviTaleve, family = poisson)

m_pluie_temp_31 <- glm(nombre_min ~ annee2 * julian + pluie_moy_glissante_31j +
                        temp_moy_glissante_31j,
          data = Protocole_SuiviTaleve, family = poisson)

AIC(m_temp_31,m_temp_7,m_pluie_7, m_pluie_31, m_pluie_temp_7, m_pluie_temp_31)
```

> La comparaison des modèles à l’aide de l’AIC montre que l’ajout de la pluie moyenne glissante sur 31 jours améliore légèrement la capacité prédictive du modèle, contrairement aux variables de température qui n’apportent pas d’amélioration supplémentaire.

Les paramètres estimés indiquent que :

-   La pluie moyenne glissante sur 31 jours n'a pas d'effet négatif significatif sur l’abondance des talèves (β = −0.179, p =0.08). Donc une variation de la quantité de pluie entre les mois n'influence pas une diminution ou augmentation du nombre d’individus

-   L’année a un effet positif significatif sur l’abondance (β = 0.155, p \< 0.001), suggérant une augmentation progressive du nombre de talèves au cours des années.

-   Le jour julien présente un effet négatif significatif (β = −0.569, p = 0.002), indiquant une diminution de l’abondance au cours de la saison ( ce qui est logique car le protocole n'est pas effectué en fin d'année )

-   L’interaction entre l’année et le jour julien est faiblement positive et significative (β = 0.059, p = 0.034), suggérant que la dynamique saisonnière varie peu d’une année à l’autre.

    Globalement, le modèle permet d’expliquer une part substantielle de la variabilité observée (déviance résiduelle = 308.28 contre une déviance nulle de 354.24), avec un AIC de 545.09.
