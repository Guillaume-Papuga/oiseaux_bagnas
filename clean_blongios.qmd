---
title: "Analyse des observations de Blongios nain (Ixobrychus minutus) dans la Reserve Naturelle du Bagnas"
format: html
editor: visual
css: styles.css
---

```{css, echo=FALSE}

body {
    text-align: justify}
    
```

```{r setup}
#| include: false
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE, 
  echo = FALSE)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```

# 1. Introduction

Le Blongios nain (*Ixobrychus minutus*) est une espèce emblématique des zones humides, inféodée aux roselières inondées, aux berges de lacs et de cours d’eau ainsi qu’aux marais, qui lui fournissent à la fois des ressources alimentaires et des sites favorables à la nidification. Particulièrement discret, il demeure le plus souvent dissimulé au sein de la végétation, ce qui rend son observation difficile. Il s’agit d’une espèce migratrice, quittant les sites de reproduction européens à la fin de l’été pour hiverner principalement en Afrique subsaharienne.

L’Inventaire national du patrimoine naturel réalisé entre 2013 et 2015, indique que l’espèce est présente dans une cinquantaine de départements de France métropolitaine, notamment dans le nord du territoire (Hauts-de-France, Île-de-France), l’est (Grand Est, Auvergne-Rhône-Alpes), les départements littoraux du sud le long de la Méditerranée, ainsi que dans quelques départements du centre du pays. Toutefois, un déclin des populations est observé depuis les années 1970, principalement lié à la raréfaction et à la dégradation de ses habitats de reproduction. En conséquence, le Blongios nain est classé « En danger » (EN) sur la Liste rouge nationale, tandis qu’il est considéré en « Préoccupation mineure » (LC) à l’échelle européenne. Dans ce contexte, la réserve naturelle du Bagnas a exprimé le besoin de disposer d’une analyse approfondie des données d’observation du Blongios nain collectées sur le site entre 1990 et 2021.

L’objectif est, dans un premier temps, de comparer les données opportunistes à celles issues de protocoles standardisés de suivi — notamment les points d’écoute visant la détection des mâles chanteurs — afin d’évaluer l’efficacité et la pertinence des différents dispositifs de suivi. Dans un second temps, il s’agit de caractériser la structure spatio-temporelle de la présence du Blongios nain au sein de la réserve. Nous nous sommes ainsi interrogés sur la structure de l’effort de prospection au cours du temps, tant à l’échelle annuelle que journalière, ainsi que sur les facteurs influençant la détection de l’espèce lors des prospections, en lien avec sa phénologie et les modalités d’échantillonnage.

# 2. Analyses

```{r}
## Importation des packages nécessaires
library(dplyr)
library(tidyverse) 
library(tidyr)
library(lubridate) 
library(readxl) 
library(ggplot2)
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(ggeffects)
library(tibble)
library(glmmTMB)
library(broom)  
library(dplyr)    
library(knitr)    
library(kableExtra)
library(gt)
library(logistf)
library(patchwork)

```

```{r}

# A changer selon votre chemin d'accès personnel 

# Importation des données
process_data <- read.csv("data/pro/process_data.csv")
process_protocole <- read.csv("data/pro/process_protocole.csv")

```

## 2.1 Analyses exploratoires

### A) Répartition temporelle des observations de Blongios nain depuis 1990

En premier lieu, nous voulions visualiser l'absence et la présence du Blongios nain sur toute la période d'étude. Pour cela, nous avons créé une grille années X semaines qui montre toutes les sorties avec et sans observation d'individus. Les cases du graphiques sont colorées de manière à différentier (i) les semaines avec observation d'un Blongios lors d'un protocole standardisé, (ii) les semaines avec observation opportuniste d'un Blongios, (iii) les semaines avec à la fois des observations opportuniste et par protocole standardisé, et (iiii) les semaines sans observation d'un Blongios.

```{r}

# Définir l'espèce d'intérêt
esp_blongios <- "Blongios nain, Butor blongios"

# Extraire les années des dates de début
annees <- as.integer(format(as.Date(process_data$date_debut), "%Y"))

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

# Filtrer les données pour le blongios et ajouter les colonnes année_suivi et semaine
data_blongios <- process_data %>%
  filter(nom_vernaculaire == esp_blongios) %>% 
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut))

# Résumer les données par année_suivi et semaine
data_blongios_summarized <- data_blongios %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    Type = case_when(
       # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # au moins 1 observation protocole ET 1 opportuniste = observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole", # au moins 1 observation protocolée (et aucune opportuniste) = observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", # au moins 1 observation opportuniste (et aucune protocolée) = observation hors protocole
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",  # sorties sans observation = aucun oiseau vu
      TRUE ~ NA_character_),
    .groups = "drop")

# Créattion d'une grille complète (années x semaines)
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_blongios_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(Type = ifelse(is.na(Type), "pas_de_sortie", Type)) # semaines sans sortie
grille <- grille %>%
  mutate(Type = factor(Type,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

# Visualisation graphique
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = Type)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"),
    labels = c(
      "Observation protocolée",
      "Observation hors protocole",
      "Observation mixte",
      "Sortie sans observation",
      "Pas de sortie")) +
  labs(
    title = paste("Observations hebdomadaires de Blongios nain depuis 1990"),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Années") +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

Premièrement, on observe que l’ensemble des observations est concentré approximativement entre les semaines 16 et 35 (printemps–été), ce qui correspond bien à la période de présence du Blongios nain sur le littoral méditerranéen français. Le protocole de suivi standardisé a débuté en 2014, avec plusieurs passages réalisés tous les deux ans environ (entre 3 et 8 passages selon les années). Enfin, les résultats suggèrent une diminution de la présence du Blongios nain sur la réserve au cours du temps. En effet, le nombre total de semaines avec au moins une observation semble décroître, avec seulement deux semaines de présence détectée en 2024 contre onze en 2004. Cette tendance pourrait indiquer soit un déclin de la population globale, soit une diminution de l’attractivité écologique du site du Bagnas pour la population nicheuse.

### B) Répartition spatiale des observations de Blongios nain issues du protocole standardisé de suivi

Ensuite, nous voulions visualiser la répartition spatiale des observations de Blongios nain issues du protocole standardisé de suivi. Pour cela, nous avons créé une carte avec des cercles dont la taille est proportionnelle au nombre total d'individus entendus/vus sur chaque site d'écoute depuis le début du protocole en 2014.

```{r}

# Filtre uniquement les données du blongios nain protocolé
Protocole_SuiviBlongios<- process_protocole %>%
  filter(
    champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire ==
        "Blongios nain, Butor blongios")  

# Préparer le format des coordonnées pour R 
sites_protocole_blongios <- st_as_sf(Protocole_SuiviBlongios, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# On rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Blongios par site (somme depuis 2014)

sites_protocole_blongios <- sites_protocole_blongios %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop")


leaflet() %>%
  addTiles() %>%     
addCircleMarkers(
    data =sites_protocole_blongios, # on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, # la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Blongios entendus :" ,(somme_nombre_min), sep = "")
  ) %>%  # cela nous donne le nom du lieu suivi du nombre de blongios entendu sur le site depuis 2014 
  setView(lng = 3.51, lat = 43.31, zoom = 13)


```

Sur cette carte on peut voir que certains sites semblent plus propice à l'observation d'individus de Blongios nain que d'autres. Notamment les sites n°5 et 6 semblent être les plus favorables à l'observation de cette espèce.

### C) Effort d'échantillonnage journalier et répartition temporelle journalière des observations protocolées de Blongios nain

Ici, nous voulions comprendre à quel moment de la journée était réalisé le protocole, et quelles étaient les horaires qui permettaient une meilleure détection de l'espèce. Pour cela, nous avons réalisé un graphique qui représente l’effort d’échantillonnage ainsi que le nombre d’obervations cumulés au cours du protocole blongios pour chaque heure de la journée de 2014 à 2025. L’effort d’échantillonnage est représenté par la somme des sorties effectuées.

```{r, include=FALSE}
# Données 
process_protocole <- read_csv("data/pro/process_protocole.csv")

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"))

Protocole_Blongios <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut))

Protocole_Blongios <- Protocole_Blongios %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Protocole_Blongios <- Protocole_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 


### Frequence horaire
freq_heure <- Protocole_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23))

```

```{r,echo=FALSE}

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage en fonction du nombre d'observations")

```

Ici, on observe que les sorties protocolées sont majoritairement réalisées entre 6 h et 7 h du matin ainsi qu’entre 20 h et 21 h, ce qui correspond aux plages horaires du protocole standardisé et aux périodes d’activité maximale du Blongios nain. Ces créneaux apparaissent pertinents, puisque c’est durant ces périodes que l’espèce est le plus fréquemment détectée.

### D) Effort d'échantillonnage journalier et répartition temporelle journalière des observations opportunistes de Blongios nain

Similairement, ici nous voulions comprendre à quel moment de la journée était faites les sorties hors protocole standardisé, et quelles étaient les horaires qui permettaient une meilleure détection de l'espèce sur ce type de données. Pour cela, nous avons réalisé un graphique qui représente le nombre d’obervations hors protocole cumulés pour chaque heure de la journée de 1997 à 2023. Il est important de préciser que les sorties hors protocole où l'heure d'observation est identifiée sont très rares (n=46), et correspondent en majorité à des données produites lors d'autres protocoles non dédiés à cette espèce.

```{r, include=FALSE}

## Filtrage des données opportunistes
Opportuniste_Blongios<- process_data %>%
  filter( nom_vernaculaire == "Blongios nain, Butor blongios" &
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" )
     

## Preparation des données
Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut))

Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

## Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

## Additionner les observations par heure

obs_heure <- Opportuniste_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

## Frequence horaire
freq_heure <- Opportuniste_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

## Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23))

```

```{r}

## Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre d'observations") +
  ggtitle("Nombre d'observations hors protocole par heure pour le Blongios")

```

On remarque que hors protocole standardisé, le Blonios nain est essentiellement entre 6 et 11h du matin et entre 19 et 21h du soir, ce qui correspond bien à son pic d'activité (aube et crépuscule), et au horaires de prospections choisies pour le protocole dédié au Blongios nain.

## 2.2. Modèles statistiques

Maintenant que nous avons mieux compris la structure et la provenance des données, nous avons construit différent modèles statistiques pour voir si il y a des tendances temporelles (intra- et inter- annuelles) significatives dans la présence et l'abondance du Blongios nain dans la réserve.

Pour les analyses de présence et d’abondance, nous utilisons uniquement les données d’observation du blongios provenant des observations protocolées. Ce jeu de données sera nommé **Protocole_SuiviBlongios.**

```{r, echo=FALSE}

##La première étape consiste à reprendre le jeu de données comprenant les données protocolées de Blongios nain.

process_protocole <- read_csv("data/pro/process_protocole.csv")

Protocole_SuiviBlongios<- process_protocole %>%
  filter(
    champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire ==
        "Blongios nain, Butor blongios")
```

```{r, echo=FALSE}

# Pour commencer, nous ajustons le format de toutes les variables explicatives potentielles

# variables temporelles et spatiales
Protocole_SuiviBlongios$annee <- as.numeric(Protocole_SuiviBlongios$annee)
Protocole_SuiviBlongios$julian <- as.numeric(Protocole_SuiviBlongios$julian)
Protocole_SuiviBlongios$annee <- as.numeric(Protocole_SuiviBlongios$annee)
Protocole_SuiviBlongios$nom_lieu<- as.factor (Protocole_SuiviBlongios$nom_lieu)

# variables climatiques 
Protocole_SuiviBlongios$temp_moy_glissante_31j <- as.numeric(Protocole_SuiviBlongios$temp_moy_glissante_31j)
Protocole_SuiviBlongios$temp_moy_glissante_7j <- as.numeric(Protocole_SuiviBlongios$temp_moy_glissante_7j)
Protocole_SuiviBlongios$pluie_moy_glissante_7j <- as.numeric(Protocole_SuiviBlongios$pluie_moy_glissante_7j)
Protocole_SuiviBlongios$pluie_moy_glissante_31j <- as.numeric(Protocole_SuiviBlongios$pluie_moy_glissante_31j)
Protocole_SuiviBlongios$vent_moyen <- as.numeric(Protocole_SuiviBlongios$vent_moyen)
Protocole_SuiviBlongios$temperature <-as.numeric(Protocole_SuiviBlongios$temperature)
Protocole_SuiviBlongios$pluie_1h <- as.numeric(Protocole_SuiviBlongios$pluie_1h)

# variables hydrologiques 
Protocole_SuiviBlongios$Profondeur <-  as.numeric(Protocole_SuiviBlongios$Profondeur )
Protocole_SuiviBlongios$AssecT_1 <- as.factor(Protocole_SuiviBlongios$AssecT_1)

```

### A) Modèles de présence/absence du Blongios Nain

En premier lieu, nous réalisons un modèle pour essayer d'expliquer la variabilité de l'absence et présence du Blongios nain sur les 10 années de suivi protocolé. Pour cela nous utilisons la variable Occurence qui notifie la présence ou l'absence d'une observation de Blongios à chaque sortie.

```{r, echo=FALSE}

## création de la variable Occurence (1 si au moins un individu observé, 0 sinon)
Protocole_SuiviBlongios$Occurence <- ifelse(Protocole_SuiviBlongios$nombre_min > 0, 1, 0)

```

Nous commençons par vérifier la structure et la dispersion de la variable réponse.

```{r}
## création d'un histogramme pour visualiser les données d'occurence
Protocole_SuiviBlongiosGraph <- Protocole_SuiviBlongios
Protocole_SuiviBlongiosGraph$Occurence <- ifelse(Protocole_SuiviBlongiosGraph$nombre_min > 0, 1, 0)
Protocole_SuiviBlongiosGraph$Occurence <- factor(
  Protocole_SuiviBlongiosGraph$Occurence,
  levels = c(0, 1),
  labels = c("Absence", "Présence"))

ggplot(Protocole_SuiviBlongiosGraph, aes(x = Occurence)) +
  geom_bar(fill = "steelblue", alpha = 0.8) +
  geom_text(
    stat = "count",
    aes(label = after_stat(count)),
    vjust = -0.5,
    size = 4
  ) +
  labs(
    x = "",
    y = "Nombre d'observations",
    title = "Occurrence du Blongios (absence / présence)"
  ) +
  theme_classic(base_size = 13) +
  expand_limits(y = 0)


```

On peut voir que la majorité des observations sont des absence de l’espèce (n=203) pour seulement quelques présences (n=33).

Par conséquent, nous avons utilisé un modèle ***logistf*** (régression logistique pénalisée de Firth) qui permet de fournir des estimations stables et des intervalles de confiance fiables lorsqu'il y a de très rares présences. Cependant, nous réduisons le nombre de variables explicatives par modèle, et nous nous limitons à une estimation d'une tendance temporelle interanuelle (variable annee).

Modele : Occurence \~ Annee

```{r}
## Modèle logistf avec uniquement l'effet interanuel de l'année
ModeleOccurenceInterAnnee <- logistf(Occurence ~ annee, data = Protocole_SuiviBlongios)
```

```{r}

## Données de prédiction
annees <- data.frame(
  annee = sort(unique(Protocole_SuiviBlongios$annee)))

## Prédictions sur l’échelle du lien (logit)
pred <- predict(
  ModeleOccurenceInterAnnee,
  newdata = annees,
  type = "link",
  se.fit = TRUE)

## Ajout des prédictions et IC (95 %)
annees$predicted_prob <- plogis(pred$fit)
annees$lower_ci <- plogis(pred$fit - 1.96 * pred$se.fit)
annees$upper_ci <- plogis(pred$fit + 1.96 * pred$se.fit)

## graphique

ggplot(annees, aes(x = annee)) +
  geom_ribbon(
    aes(ymin = lower_ci, ymax = upper_ci),
    fill = "steelblue",
    alpha = 0.25
  ) +
  geom_line(
    aes(y = predicted_prob),
    color = "steelblue",
    size = 1
  ) +
  geom_point(
    data = Protocole_SuiviBlongios,
    aes(x = annee, y = Occurence),
    color = "black",
    alpha = 0.6,
    position = position_jitter(height = 0.03)
  ) +
  labs(
    x = "Années",
    y = "Probabilité de présence du Blongios",
    title = "Probabilité de présence au cours du temps",
  ) +
  theme_classic(base_size = 14)

```

```{r, include=FALSE}
# Calculer les valeurs à insérer dynamiquement
SummaryModeleOccurenceInterAnnee <- summary(ModeleOccurenceInterAnnee)

# Transformer en data.frame
coef_df <- as.data.frame(SummaryModeleOccurenceInterAnnee$coefficients)
pvalue_df <- as.data.frame(SummaryModeleOccurenceInterAnnee$prob)
ResultatsModeleOccurence <- cbind(coef_df, pvalue_df)

# Récupérer le coefficient et p-value pour "annee"
beta_annee <- round(ResultatsModeleOccurence["annee", "SummaryModeleOccurenceInterAnnee$coefficients"], 3)
p_annee <- round(ResultatsModeleOccurence["annee", "SummaryModeleOccurenceInterAnnee$prob"], 3)

```

L’effet de l’année sur la probabilité de présence du Blongios est négatif mais non significatif (β = `r beta_annee`, p = `r p_annee`). Cela signifie qu’il n’y a pas de tendance prononcée au cours du temps. On peut toutefois remarquer qu’en visualisant l’effet graphiquement, on observe une tendance légèrement négative de la probabilité de présence du Blongios nain sur la réserve.

### B) Modèles d'abondance du Blongios nain

Ensuite, nous réalisons un modèle pour essayer d'expliquer la variabilité de l'abondance du Blongios nain sur les 10 années de suivi protocolé. Nous commençons également par vérifier la structure et la dispersion de la variable réponse abondance.

```{r}

Protocole_SuiviBlongiosGraph_abond <- Protocole_SuiviBlongios %>%
  mutate(
    Abondance_f = factor(nombre_min))

ggplot(Protocole_SuiviBlongiosGraph_abond, aes(x = Abondance_f)) +
  geom_bar(fill = "steelblue", alpha = 0.8) +
  geom_text(
    stat = "count",
    aes(label = after_stat(count)),
    vjust = -0.5,
    size = 4
  ) +
  labs(
    x = "Abondance (nombre d'individus observés)",
    y = "Nombre d'observations",
    title = "Distribution des abondances de Blongios"
  ) +
  theme_classic(base_size = 13) +
  expand_limits(y = 0)

ZeroProportion <- round(mean(Protocole_SuiviBlongios$nombre_min == 0),2)

```

On observe un nombre important de zéros dans la variable réponse d'abondance (proportion = `r ZeroProportion`). Par conséquent, nous avons choisi d'utiliser un modèle GLM avec une loi de distribution en Binomiale négative (avec le package *glmmTMB*). Cette distribution permet de prendre en compte la surdispersion des données liée à la forte proportion de zéros.

Et similairement au modèle de présence, nous allons seulement essayer de détecter une tendance temporelle, car l'estimation de trop de paramètres peut être instable avec un jeu de données comprenant autant de zéros.

Modèle : Abondance \~ Annee

```{r}
# Contruction du modèle avec une bionômiale négative

ModeleAbondanceAnnee <- glmmTMB(
  nombre_min ~ annee,
  family = nbinom2,
  data = Protocole_SuiviBlongios)

```

```{r}
# Extraction des coefficients du modèle

# Extraire les coefficients du modèle
coef_est <- summary(ModeleAbondanceAnnee)$coefficients$cond
intercept <- coef_est["(Intercept)","Estimate"]
slope <- coef_est["annee","Estimate"]
se_slope <- coef_est["annee","Std. Error"]

# Calculer la variation annuelle et IC 95 %
# log link : log(mu) = intercept + slope*annee
annual_change <- exp(slope) - 1

# Intervalle de confiance
lower_slope <- slope - 1.96*se_slope
upper_slope <- slope + 1.96*se_slope

lower_change <- exp(lower_slope) - 1
upper_change <- exp(upper_slope) - 1

# Convertir en pourcentage et arrondir
annual_loss <- round(-annual_change*100,1)
annual_loss_lower <- round(-upper_change*100,1) # attention à l'ordre pour la perte
annual_loss_upper <- round(-lower_change*100,1)

```

Selon le modèle binomial négatif, il n'y a pas de tendance temporelle significative de l'abondance (p = `r signif(coef_est["annee","Pr(>|z|)"],3)`), mais on note toutefois que la tendance est négative : l'abondance moyenne de Blongios diminue en moyenne de `r annual_loss`% par an (IC 95 % : `r annual_loss_lower` – `r annual_loss_upper`% ; β = `r round(slope,3)`).

Ensuite, nous avons réalisé les prédictions du modèle précédent pour pouvoir visualiser l'effet de l'année graphiquement. De plus, pour pouvoir mieux comprendre cette dynamique légèrement dynamique nous avons représenté les données brutes de comptage journalier sur les 10 années du suivi protocolé.

```{r}
# Création d'un data frame pour toutes les années observées
annees <- data.frame(annee = sort(unique(Protocole_SuiviBlongios$annee)))

# Prédictions sur l'échelle du lien (log)
preds <- predict(ModeleAbondanceAnnee, newdata = annees, type = "link", se.fit = TRUE)

# Transformer sur l'échelle originale et ajouter l'IC 95%
annees <- annees %>%
  mutate(
    fit = exp(preds$fit),                         # valeur prédite
    lower = exp(preds$fit - 1.96 * preds$se.fit), # borne inférieure IC 95%
    upper = exp(preds$fit + 1.96 * preds$se.fit))  # borne supérieure IC 95%)

# Graphique de l'abondance prédite
GraphiqueAbondancePredite <- ggplot(annees, aes(x = annee, y = fit)) +
  geom_line(color = "black", size = 1) +
  geom_ribbon(aes(ymin = lower, ymax = upper),
              alpha = 0.2, fill = "steelblue") +
  labs(
    x = "Années",
    y = "Abondance prédite de Blongios",
    title = "Figure 1: Abondance prédite du Blongios"
  ) +
  theme_classic(base_size = 14)

# 3) Graphique 2 : abondance réelle
Abondance_suivi <- Protocole_SuiviBlongios %>%
  arrange(date_debut) %>%
  group_by(date_debut) %>%
  summarise(total_abondance = sum(nombre_min, na.rm = TRUE)) %>%
  ungroup()

GraphiqueAbondanceReelle <- ggplot(Abondance_suivi, aes(x = date_debut, y = total_abondance)) +
  geom_point(color = "black", size = 2, alpha = 0.6) +
  geom_smooth(method = "loess", se = TRUE,
              color = "steelblue", fill = "steelblue", alpha = 0.2) +
  labs(
    x = "Années",
    y = "Abondance totale de Blongios",
    title = "Figure 2: Abondance de Blongios pour chaque journée de comptage"
  ) +
  theme_classic(base_size = 14)

GraphiqueAbondancePredite 
GraphiqueAbondanceReelle

```

Sur le graphique de l'abondance prédite (Figure 1), on observe une légère tendance négative de l'abondance du Blongios nain au cours des 10 années de suivi protocolé.\
Cette tendance peut être mieux comprise en regardant le graphique des données brutes (Figure 2) : au début du suivi (2014), les comptages journaliers montrent un nombre relativement élevé de Blongios. Lors du suivi deux ans plus tard, le nombre d'individus observés diminue, et les deux campagnes suivantes n'ont permis de détecter aucun individu. Ce n’est qu’en 2022 et 2024 que des individus sont de nouveau observés, mais toujours en quantité moindre par rapport au début du suivi.

# 3. Discussion

# 4. Bibliographie
