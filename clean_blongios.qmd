---
title: "Analyse des observations de Blongios nain (Ixobrychus minutus) dans la Reserve Naturelle du Bagnas"
format: html
editor: visual
css: styles.css
---

```{css, echo = FALSE}

body {
    text-align: justify}
    
```

```{r setup}
#| include: false
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE, 
  echo = FALSE)
#ce code permet de n'afficher aucun message parasite ni les warnings. 
```

# 1. Introduction

Le Blongios nain (Ixobrychus minutus) est une espèce emblématique des zones humides, inféodée aux roselières inondées, aux berges de lacs et de cours d’eau ainsi qu’aux marais, qui lui fournissent à la fois des ressources alimentaires et des sites favorables à la nidification. Particulièrement discret, il demeure le plus souvent dissimulé au sein de la végétation, ce qui rend son observation difficile. Il s’agit d’une espèce migratrice, quittant les sites de reproduction européens à la fin de l’été pour hiverner principalement en Afrique subsaharienne. 

L’Inventaire national du patrimoine naturel réalisé entre 2013 et 2015, indique que l’espèce est présente dans une cinquantaine de départements de France métropolitaine, notamment dans le nord du territoire (Hauts-de-France, Île-de-France), l’est (Grand Est, Auvergne-Rhône-Alpes), les départements littoraux du sud le long de la Méditerranée, ainsi que dans quelques départements du centre du pays. Toutefois, un déclin des populations est observé depuis les années 1970, principalement lié à la raréfaction et à la dégradation de ses habitats de reproduction. En conséquence, le Blongios nain est classé « En danger » (EN) sur la Liste rouge nationale, tandis qu’il est considéré en « Préoccupation mineure » (LC) à l’échelle européenne. Dans ce contexte, la réserve naturelle du Bagnas a exprimé le besoin de disposer d’une analyse approfondie des données d’observation du Blongios nain collectées sur le site entre 1990 et 2021. 

L’objectif est, dans un premier temps, de comparer les données opportunistes à celles issues de protocoles standardisés de suivi — notamment les points d’écoute visant la détection des mâles chanteurs — afin d’évaluer l’efficacité et la pertinence des différents dispositifs de suivi. Dans un second temps, il s’agit de caractériser la structure spatio-temporelle de la présence du Blongios nain au sein de la réserve. Nous nous sommes ainsi interrogés sur la structure de l’effort de prospection au cours du temps, tant à l’échelle annuelle que journalière, ainsi que sur les facteurs influençant la détection de l’espèce lors des prospections, en lien avec sa phénologie et les modalités d’échantillonnage.



```{r}
## Importation des packages nécessaires
library(dplyr)
library(tidyverse) 
library(tidyr)
library(lubridate) 
library(readxl) 
library(ggplot2)
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)
library(sf)
library(ggeffects)
library(tibble)
library(glmmTMB)
library(broom)    # transforme les modèles en data frame
library(dplyr)    # manipulation des tableaux
library(knitr)    # kable
library(kableExtra) # pour un joli rendu HTML / PDF
library(gt)
library(logistf)

```

```{r}

# A changer selon votre chemin d'accès personnel 

# Importation des données
process_data <- read.csv("data/pro/process_data.csv")
process_protocole <- read.csv("data/pro/process_protocole.csv")

```

# 3. Analyses

## 3.1 Analyses exploratoires

### A) Répartition temporelle des observations de Blongios nain depuis 1990

En premier lieu, nous voulions visualiser l'absence et la présence du Blongios nain sur toute la période d'étude. Pour cela, nous avons créé une grille années X semaines qui montre toutes les sorties avec et sans observation d'individus. Les cases du graphiques sont colorées de manière à différentier (i) les semaines avec observation d'un Blongios lors d'un protocole standardisé, (ii) les semaines avec observation opportuniste d'un Blongios, (iii) les semaines avec à la fois des observations opportuniste et par protocole standardisé, et (iiii) les semaines sans observation d'un Blongios.

```{r}

# Définir l'espèce d'intérêt
esp_blongios <- "Blongios nain, Butor blongios"

# Extraire les années des dates de début
annees <- as.integer(format(as.Date(process_data$date_debut), "%Y"))

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1

# Filtrer les données pour le blongios et ajouter les colonnes année_suivi et semaine
data_blongios <- process_data %>%
  filter(nom_vernaculaire == esp_blongios) %>% 
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut))

# Résumer les données par année_suivi et semaine
data_blongios_summarized <- data_blongios %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels)) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
       # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # au moins 1 observation protocole ET 1 opportuniste = observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole", # au moins 1 observation protocolée (et aucune opportuniste) = observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", # au moins 1 observation opportuniste (et aucune protocolée) = observation hors protocole
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",  # sorties sans observation = aucun oiseau vu
      TRUE ~ NA_character_),
    .groups = "drop")

# Créattion d'une grille complète (années x semaines)
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_blongios_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie
grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

# Visualisation graphique
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie")) +
  labs(
    title = paste("Observations de", esp_blongios),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année") +
  theme_minimal() +
  theme(panel.grid = element_blank())

```

Premièrement, on observe que l’ensemble des observations est concentré approximativement entre les semaines 16 et 35 (printemps–été), ce qui correspond bien à la période de présence du Blongios nain sur le littoral méditerranéen français. Le protocole de suivi standardisé a débuté en 2014, avec plusieurs passages réalisés tous les deux ans environ (entre 3 et 8 passages selon les années). Enfin, les résultats suggèrent une diminution de la présence du Blongios nain sur la réserve au cours du temps. En effet, le nombre total de semaines avec au moins une observation semble décroître, avec seulement deux semaines de présence détectée en 2024 contre onze en 2004. Cette tendance pourrait indiquer soit un déclin de la population globale, soit une diminution de l’attractivité écologique du site du Bagnas pour la population nicheuse.

### B) Répartition spatiale des observations de Blongios nain issues du protocole standardisé de suivi

Ensuite, nous voulions visualiser la répartition spatiale des observations de Blongios nain issues du protocole standardisé de suivi. Pour cela, nous avons créé une carte avec des cercles dont la taille est proportionnelle au nombre total d'individus entendus/vus sur chaque site d'écoute depuis le début du protocole en 2014.

```{r}

# Filtre uniquement les données du blongios nain protocolé
Protocole_SuiviBlongios<- process_protocole %>%
  filter(
    champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire ==
        "Blongios nain, Butor blongios")

# Préparer le format des coordonnées pour R 
sites_protocole_blongios <- st_as_sf(Protocole_SuiviBlongios, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# On rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Blongios par site (somme depuis 2014)

sites_protocole_blongios <- sites_protocole_blongios %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop")


leaflet() %>%
  addTiles() %>%     
addCircleMarkers(
    data =sites_protocole_blongios, # on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min, # la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Blongios entendus :" ,(somme_nombre_min), sep = "")
  ) %>%  # cela nous donne le nom du lieu suivi du nombre de blongios entendu sur le site depuis 2014 
  setView(lng = 3.51, lat = 43.31, zoom = 13)


```

Sur cette carte on peut voir que certains sites semblent plus propice à l'observation d'individus de Blongios nain que d'autres. Notamment les sites n°5 et 6 semblent être les plus favorables à l'observation de cette espèce.

### C) Effort d'échantillonnage journalier et répartition temporelle journalière des observations protocolées de Blongios nain

Ici, nous voulions comprendre à quel moment de la journée était réalisé le protocole, et quelles étaient les horaires qui permettaient une meilleure détection de l'espèce. Pour cela, nous avons réalisé un graphique qui représente l’effort d’échantillonnage ainsi que le nombre d’obervations cumulés au cours du protocole blongios pour chaque heure de la journée de 2014 à 2025. L’effort d’échantillonnage est représenté par la somme des sorties effectuées.

```{r, include=FALSE}
# Données 
process_protocole <- read_csv("data/pro/process_protocole.csv")

Protocole_SuiviBlongiosTaleve <- process_protocole %>%
  filter(
    champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire %in% c(
        "Blongios nain, Butor blongios",
        "Talève sultane, Poule sultane, Porphyrion bleu"
      )
  )
Protocole_Blongios <- Protocole_SuiviBlongiosTaleve %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut)
  )

Protocole_Blongios <- Protocole_Blongios %>% filter( nom_vernaculaire == "Blongios nain, Butor blongios")

Protocole_Blongios <- Protocole_Blongios  %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

# Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

### Sommer les obs par heure

obs_heure <- Protocole_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

### Frequence horaire
freq_heure <- Protocole_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

# Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23))

```

```{r,echo=FALSE}

### Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = freq),
           stat = "identity",
           width = 0.8,
           fill = "orange") +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Effort d'échantillonnage et nombre d'observations\n par heure pour le protocole Blongios (2014-2018)")

```

Ici, on observe que les sorties protocolées sont majoritairement réalisées entre 6 h et 7 h du matin ainsi qu’entre 20 h et 21 h, ce qui correspond aux plages horaires du protocole standardisé et aux périodes d’activité maximale du Blongios nain. Ces créneaux apparaissent pertinents, puisque c’est durant ces périodes que l’espèce est le plus fréquemment détectée

### D) Effort d'échantillonnage journalier et répartition temporelle journalière des observations opportunistes de Blongios nain

Similairement, ici nous voulions comprendre à quel moment de la journée était faites les sorties hors protocole standardisé, et quelles étaient les horaires qui permettaient une meilleure détection de l'espèce sur ce type de données. Pour cela, nous avons réalisé un graphique qui représente le nombre d’obervations hors protocole cumulés pour chaque heure de la journée de 1997 à 2023. Il est important de préciser que les sorties hors protocole où l'heure d'observation est identifiée sont très rares (n=46), et correspondent en majorité à des données produites lors d'autres protocoles non dédiés à cette espèce.

```{r, include=FALSE}

## Filtrage des données opportunistes
Opportuniste_Blongios<- process_data %>%
  filter( nom_vernaculaire == "Blongios nain, Butor blongios" &
    !champs_additionnels == "{'RELV_NOM': 'SuiviBlongiosTalève'}" )
     

## Preparation des données
Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(
    heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S"),
    heure_debut_tronc = hour(heure_debut),
    date = as.Date(heure_debut))

Opportuniste_Blongios <- Opportuniste_Blongios %>%
  mutate(heure_debut = as.POSIXct(heure_debut, format = "%H:%M:%S")) %>%
  filter(format(heure_debut, "%H:%M:%S") != "00:00:00")

## Table des 24 heures

heures_jour <- tibble(heure_debut_tronc = 0:23)

## Additionner les observations par heure

obs_heure <- Opportuniste_Blongios %>%
  group_by(heure_debut_tronc) %>%
  summarize(sum(nombre_min)) 
obs_heure

## Frequence horaire
freq_heure <- Opportuniste_Blongios %>% group_by(heure_debut_tronc) %>% summarise(freq = n()) %>% mutate(freq_rel = freq / sum(freq))

## Compléter les heures manquantes avec 0
data_plot_h <- heures_jour %>%
  left_join(freq_heure, by = "heure_debut_tronc") %>%
  left_join(obs_heure, by = "heure_debut_tronc") %>%
  mutate(
    freq = replace_na(freq, 0),
    `sum(nombre_min)` = replace_na(`sum(nombre_min)`, 0),
    heure_debut_tronc = factor(heure_debut_tronc, levels = 0:23))

```

```{r}

## Barplot

ggplot(data_plot_h, aes(x = heure_debut_tronc)) +
  geom_bar(aes(y = `sum(nombre_min)`),
           stat = "identity",
           width = 0.4,
           fill = "blue") +
  theme_classic() +
  scale_y_continuous(expand = c(0, 0)) +
  xlab("Heure de la journée") +
  ylab("Nombre de prospections (orange)\n et d'observations (bleu)") +
  ggtitle("Nombre d'observations hors protocole\n par heure pour le Blongios (1997-2023)")

```

On remarque que hors protocole standardisé, le Blonios nain est essentiellement entre 6 et 11h du matin et entre 19 et 21h du soir, ce qui correspond bien à son pic d'activité (aube et crépuscule), et au horaires de prospections choisies pour le protocole dédié au Blongios nain.

## 3.2. Modèles statistiques

Maintenant que nous avons exploré les données, nous avons construit différent modèles statistiques pour voir si :

-   il y a des tendances temporelles (intra- et inter- annuelles) significatives dans la présence et l'abondance du Blongios nain dans la réserve

-   il y a des différences spatiales (entre sites d'écoute) significatives dans la présence et l'abondance du Blongios nain dans la réserve

-   quelles variables environnementales (climatiques et hydrologiques) influencent la présence et l'abondance du Blongios nain

Pour les analyses de présence et d’abondance, nous utilisons uniquement les données d’observation du blongios provenant des observations protocolées. Ce jeu de données sera nommé **Protocole_SuiviBlongios**


```{r, echo=FALSE}

##La première étape consiste à reprendre le jeu de données comprenant les données protocolées de Blongios nain.

process_protocole <- read_csv("data/pro/process_protocole.csv")

Protocole_SuiviBlongios<- process_protocole %>%
  filter(
    champs_additionnels  == "{'RELV_NOM': 'SuiviBlongiosTalève'}" &
      nom_vernaculaire ==
        "Blongios nain, Butor blongios")
```


```{r, echo=FALSE}

# Pour commencer, nous ajustons le format de toutes les variables que nous allons utiliser.

# variables temporelles et spatiales
Protocole_SuiviBlongios$annee <- as.numeric(Protocole_SuiviBlongios$annee)
Protocole_SuiviBlongios$julian <- as.numeric(Protocole_SuiviBlongios$julian)
Protocole_SuiviBlongios$annee <- as.numeric(Protocole_SuiviBlongios$annee)
Protocole_SuiviBlongios$nom_lieu<- as.factor (Protocole_SuiviBlongios$nom_lieu)

# variables climatiques 
Protocole_SuiviBlongios$temp_moy_glissante_31j <- as.numeric(Protocole_SuiviBlongios$temp_moy_glissante_31j)
Protocole_SuiviBlongios$temp_moy_glissante_7j <- as.numeric(Protocole_SuiviBlongios$temp_moy_glissante_7j)
Protocole_SuiviBlongios$pluie_moy_glissante_7j <- as.numeric(Protocole_SuiviBlongios$pluie_moy_glissante_7j)
Protocole_SuiviBlongios$pluie_moy_glissante_31j <- as.numeric(Protocole_SuiviBlongios$pluie_moy_glissante_31j)
Protocole_SuiviBlongios$vent_moyen <- as.numeric(Protocole_SuiviBlongios$vent_moyen)
Protocole_SuiviBlongios$temperature <-as.numeric(Protocole_SuiviBlongios$temperature)
Protocole_SuiviBlongios$pluie_1h <- as.numeric(Protocole_SuiviBlongios$pluie_1h)

# variables hydrologiques 
Protocole_SuiviBlongios$Profondeur <-  as.numeric(Protocole_SuiviBlongios$Profondeur )
Protocole_SuiviBlongios$AssecT_1 <- as.factor(Protocole_SuiviBlongios$AssecT_1)

```

### A) Modèles de présence/absence du Blongios Nain

En premier lieu, nous réalisons un modèle pour essayer d'expliquer l'absence/présence du Blongios nain sur les 10 années de suivi protocolé. Pour cela nous utilisons la variable Occurence qui notifie la présence ou l'absence d'une observation de Blongios à chaque sortie.

```{r, echo=FALSE}

## création de la variable Occurence (1 si au moins un individu observé, 0 sinon)
Protocole_SuiviBlongios$Occurence <- ifelse(Protocole_SuiviBlongios$nombre_min > 0, 1, 0)

## test de la colinéarité entre variables
VariablesExplicatives <- (Protocole_SuiviBlongios %>%
  select(annee, julian, temp_moy_glissante_31j, temp_moy_glissante_7j,
         pluie_moy_glissante_31j, pluie_moy_glissante_7j, vent_moyen,
         temperature, pluie_1h, Profondeur))

CorrelationVariablesExplicatives <- cor(VariablesExplicatives, use = "pairwise.complete.obs")
corrplot::corrplot(CorrelationVariablesExplicatives)

## verification de la distribution de la variable réponse
hist(Protocole_SuiviBlongios$Occurence)

```

Nous commençons par vérifier la structure et la dispersion de la variable réponse 

```{r}
## création d'un histogramme pour visualiser les données d'occurence
hist(Protocole_SuiviBlongios$Occurence)
```

On peut voir que la majorité des observations sont des zéros (absence de l’espèce). Par conséquent, nous avons utilisé un modèle logistf (régression logistique pénalisée de Firth) qui permet de fournir des estimations stables et des intervalles de confiance fiables lorsqu'il y a de très rares présences. Cependant, nous allons diminuer le nombre de variables explicatives et nous limiter à l'estimation d'une tendance temporelle interanuelle.

```{r}

## Modèle logistf avec uniquement l'effet de l'année
logistf_model <- logistf(Occurence ~ annee, data = Protocole_SuiviBlongios)

## Prédictions
annees <- data.frame(annee = sort(unique(Protocole_SuiviBlongios$annee)))
annees$predicted_prob <- predict(logistf_model, newdata = annees, type = "response")

## graphique

ggplot(annees, aes(x = annee, y = predicted_prob)) +
  geom_line(color = "steelblue", size = 1) +    
  geom_point(data = Protocole_SuiviBlongios,     
             aes(x = annee, y = Occurence),
             color = "black", alpha = 0.6) +
  labs(
    x = "Année",
    y = "Probabilité de présence du Blongios",
    title = "Probabilité prédite de présence selon l'année (logistf)"
  ) +
  theme_minimal(base_size = 14)

```

### B) Modèles d'abondance du Blongios nain

Ensuite, nous avons construit des modèles pour expliquer l'abondance du Blongios sur la Réserve.. Cela nous à permis de vérifier s'il y avait (i) des tendances temporelles dans les populations de Blongios de la réserve, (ii) des sites avec plus d'individus observés ou (iii) des variables environnementales qui pouvaient influencer le nombre d'individus recensé lors du suivi.

```{r}


## vérification de la distribution de la variable réponse
hist(Protocole_SuiviBlongios$nombre_min)

## enormément de zéros : test de la surdispersion

ModeleEnvironnementAbondance |>
  performance::check_overdispersion()

# Modèle à inflation de zéros
modeleZI <- glmmTMB(nombre_min ~ annee,
data=Protocole_SuiviBlongios,
ziformula=~1,
family=poisson)

summary(modeleZI)

# Création d'un data frame pour toutes les années observées
annees <- data.frame(annee = sort(unique(Protocole_SuiviBlongios$annee)))

# Prédictions sur l'échelle du lien (log)
preds <- predict(modeleZI, newdata = annees, type = "link", se.fit = TRUE)

# Transformer sur l'échelle originale et ajouter l'IC 95%
annees <- annees %>%
  mutate(
    fit = exp(preds$fit),                         # valeur prédite
    lower = exp(preds$fit - 1.96 * preds$se.fit), # borne inférieure IC 95%
    upper = exp(preds$fit + 1.96 * preds$se.fit))  # borne supérieure IC 95%)

# Graphique
ggplot(annees, aes(x = annee, y = fit)) +
  geom_line(color = "black", size = 1) +              # courbe
  geom_ribbon(aes(ymin = lower, ymax = upper),           # IC 95%
              alpha = 0.2, fill = "steelblue") +
  labs(
    x = "Année",
    y = "Abondance prédite de Blongios",
    title = "Abondance prédite du Blongios"
  ) +
  theme_classic(base_size = 14)

```

```{r}
Abondance_suivi <- Protocole_SuiviBlongios %>%
  arrange(date_debut) %>%   # tri chronologique
  group_by(date_debut) %>%  # groupe par date réelle
  summarise(
    total_abondance = sum(nombre_min, na.rm = TRUE)
  ) %>%
  ungroup()

ggplot(Abondance_suivi, aes(x = date_debut, y = total_abondance)) +
  geom_point(color = "black", size = 2, alpha = 0.6) +      # points bruts
  geom_smooth(method = "loess", se = TRUE, color = "steelblue", fill = "steelblue", alpha = 0.2) + 
  labs(
    x = "Date",
    y = "Abondance totale de Blongios",
    title = "Abondance de Blongios par date avec IC 95%"
  ) +
  theme_minimal(base_size = 14)


```

La variable temporelle interannuelle (année) et intraannuelle (jours julian) n'ont pas d'effet significatif sur l'abondance de l'espèce, ce qui signifie que le nombre d'individus contacté lors des suivis protocolés de l'espèce ne varie pas significativement entre 2014 et 2024 (β = `r round(coef(ModeleEnvironnementAbondance)["annee"], 3)` ± `r round(summary(ModeleEnvironnementAbondance)$coefficients["annee", "Std. Error"], 3)`, p = `r format.pval(summary(ModeleEnvironnementAbondance)$coefficients["annee", "Pr(>|z|)"], digits = 3)`), ni durant la durée du protocole (β = `r round(coef(ModeleEnvironnementAbondance)["julian"], 3)` ± `r round(summary(ModeleEnvironnementAbondance)$coefficients["julian", "Std. Error"], 3)`, p = `r format.pval(summary(ModeleEnvironnementAbondance)$coefficients["julian", "Pr(>|z|)"], digits = 3)`. De même, il n'y a aucun site de la réserve qui montre un nombre de Blongios observé plus important, et aucune des variables environnementales qui expliquent significativement les variations d'abondance du Blongios nain.



Nous admettons que le modèle de base comprend uniquement les variables temporelles (année, jour julien) et spatiales (site d'écoute). Pour les variations intra-anuelles on rajoute également un effet quadratique sur la variable jour julien (julian^2). Ensuite, nous rajoutons à ce modèle de base les variables environnementales (climatiques et hydrologiques). Un test de corrélation entre les variables environnementales est réalisé au préalable pour éviter la colinéarité entre variables explicatives.

Modèle Occurence ~ Temporel + Spatial 
```{r,echo=FALSE}

## Modèle de base (temporel et spatial)
ModeleBaseOccurence <- glm(Occurence ~ annee + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviBlongios, 
                   family = binomial)

tidy(ModeleBaseOccurence) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    p.value = signif(p.value, 3)
  ) %>%
  kable(
    caption = "Résumé du modèle Occurrence avec variables environnementales",
    col.names = c("Variable", "Estimate", "SE", "p-value")
  ) %>%
  kable_styling(full_width = F, position = "center")

```

Modèle Occurence ~ Temporel + Spatial + Environnement
```{r, echo=FALSE}
## Modèle complet avec les variables environnementales
ModeleEnvironnementOccurence <- glm(Occurence ~ annee + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_31j+ pluie_moy_glissante_31j + pluie_moy_glissante_7j + pluie_1h + AssecT_1 + Profondeur,
                        data = Protocole_SuiviBlongios, 
                   family = binomial)
summary(ModeleEnvironnementOccurence)

tidy(ModeleEnvironnementOccurence) %>%
  select(term, estimate, std.error, p.value) %>%
  mutate(
    estimate = round(estimate, 3),
    std.error = round(std.error, 3),
    p.value = signif(p.value, 3)
  ) %>%
  kable(
    caption = "Résumé du modèle Occurrence avec variables environnementales",
    col.names = c("Variable", "Estimate", "SE", "p-value")
  ) %>%
  kable_styling(full_width = F, position = "center")

```

Nous obervons que les trois variables de température sont fortement corrélées entre elles (R\>0.8), donc nous conservons que la variable de température moyénnée à 7 jours avant la date du suivi. Concernant les précipitations, nous gardons les trois variables (du jour J, moyenne sur 7 et 31 jours).

La variable temporelle interannuelle (année) et intraannuelle (jours julian) n'ont pas d'effet significatif sur la présence de l'espèce, ce qui signifie que la probabilité d'occurrence de l'espèce ne varie pas significativement entre 2014 et 2024 (β = `r round(coef(ModeleEnvironnementOccurence)["annee"], 3)` ± `r round(summary(ModeleEnvironnementOccurence)$coefficients["annee", "Std. Error"], 3)`, p = `r format.pval(summary(ModeleEnvironnementOccurence)$coefficients["annee", "Pr(>|z|)"], digits = 3)`), ni durant la durée du protocole (β = `r round(coef(ModeleEnvironnementOccurence)["julian"], 3)` ± `r round(summary(ModeleEnvironnementOccurence)$coefficients["julian", "Std. Error"], 3)`, p = `r format.pval(summary(ModeleEnvironnementOccurence)$coefficients["julian", "Pr(>|z|)"], digits = 3)`. De même, il n'y a aucun site qui montre une meilleure présence de Blongios sur la réserve, et aucune variables environnementales qui explique significativement l'occurence du Blongios nain.


```{r}

## Modèle de base (temporel et spatial)
ModeleBaseAbondance <- glm(nombre_min ~ annee + julian + I(julian^2)+ nom_lieu,
                        data = Protocole_SuiviBlongios, 
                   family = poisson)
summary(ModeleBaseAbondance)

## Modèle complet avec les variables environnementales
ModeleEnvironnementAbondance <- glm(nombre_min ~ annee + julian + I(julian^2)+ nom_lieu + temp_moy_glissante_31j+ pluie_moy_glissante_31j + pluie_moy_glissante_7j + pluie_1h + AssecT_1 + Profondeur,
                        data = Protocole_SuiviBlongios, 
                   family = poisson)
summary(ModeleEnvironnementAbondance)
```

