---
title: "clean_blongios"
format: html
editor: visual
---

#Charger les données et les library

```{r}

library(tidyverse) 
library(lubridate) 
library(readxl) 
library(ggplot2) 
library(dplyr)
library(gridExtra)
library(readr)
library(knitr)
library(lme4)
library(leaflet)

setwd("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro")
process_data <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_data.csv")

```

## 1. analyses exploratoires du Blongios

#A- Graphique de présence des Blongios par semaine depuis 1990

```{r}
## 1 : graphique des semaines de la vie, on regarde les présences de l'espèce chaque semaine depuis 1990. 

esp_blongios <- "Blongios nain, Butor blongios"

annees <- format(process_data$date_debut, "%Y")
annees <- as.numeric(annees)

# Trouver les années min et max
annee_min <- min(annees, na.rm = TRUE)
annee_max <- max(annees, na.rm = TRUE)
duree_annees <- annee_max - annee_min +1


data_blongios <- process_data %>%
  filter(nom_vernaculaire == esp_blongios) %>%#on filtre pour avoir uniquement les lignes du blongios dans le data frame
  mutate(
    annee_suivi = year(date_debut) - annee_min + 1,
    annee_reelle = year(date_debut),
    semaine = isoweek(date_debut)
  )

# --- Résumer les semaines pour gérer les sorties multiples ---
data_blongios_summarized <- data_blongios %>%
  mutate(
    is_obs = nombre_min > 0,
    is_protocole = grepl("SuiviBlongiosTalève", champs_additionnels) #on définit ce qu'est une observation protocolée
  ) %>%
  group_by(annee_suivi, semaine) %>%
  summarise(
    statut = case_when(
       # sorties avec observations 
      any(is_obs) & any(is_protocole & is_obs) & any(!is_protocole & is_obs) ~ "obs_mixte", # si dans une semaine il y a eu au moins 1 observation protocole ET 1 opportuniste, alors on définit ça en observation mixte 
      any(is_obs) & any(is_protocole & is_obs) ~ "obs_protocole", #si dans 1 semaine il y a eu au moins 1 observation protocolée (et aucune opportuniste) on définit en observation protocolée 
      any(is_obs) & any(!is_protocole & is_obs) ~ "obs_hors_protocole", #si dans 1 semaine il y a eu au moins 1 observation opportuniste (et aucune protocolée) on définit en observation hors protocole


      # sorties sans observation = aucun oiseau vu
      !any(is_obs) & any(nombre_min == 0) ~ "sortie_sans_observation",

      TRUE ~ NA_character_
    ),
    .groups = "drop"
  )
# --- Créer la grille complète (année x semaine) ---
grille <- expand.grid(
  annee_suivi = 1:duree_annees,
  semaine = 1:53
) %>%
  mutate(annee_reelle = annee_min + annee_suivi - 1) %>%
  left_join(
    data_blongios_summarized,
    by = c("annee_suivi", "semaine")
  ) %>%
  mutate(statut = ifelse(is.na(statut), "pas_de_sortie", statut)) # semaines sans sortie


grille <- grille %>%
  mutate(statut = factor(statut,
                         levels = c("obs_protocole", "obs_hors_protocole", "obs_mixte",
                                    "sortie_sans_observation", "pas_de_sortie")))

#on fait le graphique
ggplot(grille, aes(x = semaine, y = annee_reelle, fill = statut)) +
  geom_tile(color = "white", linewidth = 0.2) +
  geom_hline(yintercept = 2014, color = "blue", linetype = "dashed", size = 0.4)+
  scale_y_reverse() +
  scale_fill_manual(
    values = c(
      "obs_protocole" = "red",
      "obs_hors_protocole" = "green",
      "obs_mixte" = "purple",
      "sortie_sans_observation" = "black",
      "pas_de_sortie" = "grey85"
    ),
    labels = c(
      "Observation (protocole)",
      "Observation (hors protocole)",
      "Observation (mixte)",
      "Sortie sans observation",
      "Pas de sortie"
    )
  ) +
  labs(
    title = paste("Observations de", esp_blongios),
    subtitle = paste("Suivi de", annee_min, "à", annee_max),
    x = "Semaine de l'année",
    y = "Année"
  ) +
  theme_minimal() +
  theme(panel.grid = element_blank())






```

#B- Cartographie de la présence des Butors sur les sites d'écoute du protocole

```{r}
# on prend le dataframe des données uniquement protocolées (cf document clean_data pour sa création)
process_protocole <- read_csv("~/Desktop/M2/projet biodiversite/oiseaux_bagnas/data/pro/process_protocole.csv")

#on ne garde que les données du blongios 
process_protocole_blongios <- process_protocole %>%
  filter(nom_vernaculaire=="Blongios nain, Butor blongios")

#préparer les coordonnées pour R 
sites_protocole_blongios <- st_as_sf(process_protocole_blongios, coords = c("x_centroid_4326", "y_centroid_4326"), crs = 4326)

# on rassemble les données pour avoir un dataframe avec 1 ligne par site d'étude. L'objectif est d'avoir le nombre d'écoute de Blongios par site (somme depuis 2014)

sites_protocole_blongios <- sites_protocole_blongios %>%
  group_by(nom_lieu, nom_vernaculaire, geometry) %>%
  summarise(
    somme_nombre_min = sum(nombre_min, na.rm = TRUE),
    .groups = "drop"
  )


leaflet() %>%
  addTiles() %>%     # fond OSM

  addCircleMarkers(
    data =sites_protocole_blongios, #on prend les data frame résumé avec 1 ligne par site
    radius = ~somme_nombre_min,#la taille des points est proportionnelle au nombre d'oiseaux entendus
    color = "red",
    fillOpacity = 0.9,
    popup = ~paste ((nom_lieu), ", Blongios entendus :" ,(somme_nombre_min), sep = "")
  ) %>%  #cela nous donne le nom du lieu suivi du nombre de blongios entendu sur le site depuis 2014 
  setView(lng = 3.51, lat = 43.31, zoom = 13)


```

#C- heures de la journée où les blongios ont été entendus

```{r}

```

#D- évolution de l'abondance de blongios dans le temps

```{r}

```

##2 . Modèle de présence/absence

## 3 . Modèle d'abondance

Cette analyse vise à caractériser la dynamique de la population de blongios et à déterminer l'influence relative des variables temporelles (année, date julienne) et environnementales (précipitations et temperatures) sur l'abondance observée.

## 3.1 Modèle d'abondance en fonction du temps

Nous réalisons cette analyse sur seulement les observations qui proviennent du protocole (donc pas les observations opportunistes)

```{r}
Protocole_SuiviBlongios <- process_protocole %>%
  filter(
      nom_vernaculaire == "Blongios nain, Butor blongios"
  )

```

```{r}
# Preparation des variables ( standardisation )
Protocole_SuiviBlongios$annee <- as.numeric(Protocole_SuiviBlongios$annee)
Protocole_SuiviBlongios$julian <- as.numeric(scale(Protocole_SuiviBlongios$julian))
Protocole_SuiviBlongios$annee2 <- as.numeric(as.character(Protocole_SuiviBlongios$annee)) - 2013
```

```{r}
#  Modèle dans le temps 
# y ~ Pois ( lambda)

modele_annee <- glm(nombre_min ~ annee2, 
                    family = poisson, 
                    data = Protocole_SuiviBlongios)


modele_jour <- glm(nombre_min ~ julian, 
                   data = Protocole_SuiviBlongios, 
                   family = poisson)


modele_annee_jour <- glm(nombre_min ~ annee2 + julian, 
                         data = Protocole_SuiviBlongios, 
                         family = poisson)

modele_anneejour <- glm(nombre_min ~ annee2 * julian, 
                         data = Protocole_SuiviBlongios, 
                         family = poisson)



summary(modele_annee)
summary(modele_jour)
summary(modele_annee_jour)
summary(modele_anneejour)

AIC(modele_annee, modele_jour, modele_annee_jour, modele_anneejour)

```

## Interprétation

La sélection par l'AIC indique que le modèle incluant l'effet du jour julien est le plus performant. Nous retenons cette structure de base pour la suite des analyses, afin d'y intégrer et de tester l'influence des variables environnementales.

## 3.2 Modèle d'abondance en fonction du temps et de l'environnement

```{r}
# Nettoyage des variables (on force le passage de matrice à vecteur simple)
Protocole_SuiviBlongios$temp_moy_glissante_31j <- as.numeric(scale(Protocole_SuiviBlongios$temp_moy_glissante_31j))
Protocole_SuiviBlongios$temp_moy_glissante_7j <- as.numeric(scale(Protocole_SuiviBlongios$temp_moy_glissante_7j))
Protocole_SuiviBlongios$pluie_moy_glissante_7j <- as.numeric(scale(Protocole_SuiviBlongios$pluie_moy_glissante_7j))
Protocole_SuiviBlongios$pluie_moy_glissante_31j <- as.numeric(scale(Protocole_SuiviBlongios$pluie_moy_glissante_31j))
```

```{r}
m_temp_7 <- glm(nombre_min ~ julian + temp_moy_glissante_7j,
          data = Protocole_SuiviBlongios, family = poisson)

m_temp_31 <- glm(nombre_min ~ julian + temp_moy_glissante_31j,
          data = Protocole_SuiviBlongios, family = poisson)

m_pluie_7 <- glm(nombre_min ~ julian + pluie_moy_glissante_7j,
          data = Protocole_SuiviBlongios, family = poisson)

m_pluie_31<- glm(nombre_min ~ julian + pluie_moy_glissante_31j,
          data = Protocole_SuiviBlongios, family = poisson)

m_pluie_temp_7 <- glm(nombre_min ~ julian + pluie_moy_glissante_7j +
                        temp_moy_glissante_7j,
          data = Protocole_SuiviBlongios, family = poisson)

m_pluie_temp_31 <- glm(nombre_min ~ julian + pluie_moy_glissante_31j +
                        temp_moy_glissante_31j,
          data = Protocole_SuiviBlongios, family = poisson)

AIC(m_temp_31,m_temp_7,m_pluie_7, m_pluie_31, m_pluie_temp_7, m_pluie_temp_31)
```

> La comparaison des modèles par l’AIC montre que l’intégration de la pluie moyenne glissante sur 7 jours améliore légèrement la capacité prédictive du modèle. En revanche, les variables de température n'apportent aucune amélioration supplémentaire et n'ont donc pas été retenues.

Les paramètres estimés indiquent que :

-   La pluie moyenne glissante sur 7 jours a un effet négatif significatif sur l’abondance des talèves (β = -0.566, p =0.014). Donc uneaugemtation de la quantité de pluie engendre une diminution ou du nombre d’individus de blongios dans la reserve

-   Le jour julien présente un effet négatif significatif (β = −0.357 p = 0.039), indiquant une diminution de l’abondance au cours de la saison ( ce qui est logique car le protocole n'est pas effectué en fin d'année )

    Globalement, le modèle permet d’expliquer une part substantielle de la variabilité observée (déviance résiduelle = 166,96 contre une déviance nulle de 166.96), avec un AIC de 252.79.

-   La fonction pour trouver l'abondance du blongios en fonction de la pluie et des jours est :

    log(y) = -1.9136 -03572(julian\[i\]) - 0.5659(pluie\[i\])

    ```{r}
    #  Création d'un graphique de la fonction predite ; nombre d'individus en fonction de la pluie ( donc on fixe les jours pour avoir seulement l'effet pluie)
    data_pred <- data.frame(
      pluie_moy_glissante_7j = seq(min(Protocole_SuiviBlongios$pluie_moy_glissante_7j), 
    max(Protocole_SuiviBlongios$pluie_moy_glissante_7j), 
                                   length.out = 100),
      julian = 0
    )

    predictions <- predict(m_pluie_7, newdata = data_graph, type = "link", se.fit = TRUE)

    data_pred$fit <- exp(predictions$fit)
    data_pred$ucl <- exp(predictions$fit + 1.96 * predictions$se.fit)
    data_pred$lcl <- exp(predictions$fit - 1.96 * predictions$se.fit)

    # Le Graphique
    ggplot() +
      geom_ribbon(data = data_graph, aes(x = pluie_moy_glissante_7j, ymin = lcl, ymax = ucl), 
                  fill = "blue", alpha = 0.1) +

      geom_jitter(data = Protocole_SuiviBlongios, 
                  aes(x = pluie_moy_glissante_7j, y = nombre_min, color = "Observations"), 
                  alpha = 0.5, width = 0.05, height = 0.05) +
      geom_line(data = data_graph, 
                aes(x = pluie_moy_glissante_7j, y = fit, color = "Modèle GLM"), 
                size = 1) +
      scale_color_manual(name = "Légende", 
                         values = c("Observations" = "orange", "Modèle GLM" = "blue")) +
      
      labs(
        title = "Relation entre Pluie et Abondance de Blongios",
        x = "Pluie moyenne (standardisée)",
        y = "Nombre d'individus"
      ) +
      theme_minimal()
    ```
